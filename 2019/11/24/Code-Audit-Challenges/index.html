<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Code-Audit-Challenges - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=writeup,代码审计>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">Code-Audit-Challenges</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#弱类型比较"><span class="toc-text">弱类型比较</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP"><span class="toc-text">PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-2"><span class="toc-text">challenge-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-7"><span class="toc-text">challenge-7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-10"><span class="toc-text">challenge-10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-13"><span class="toc-text">challenge-13</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-15"><span class="toc-text">challenge-15</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-21"><span class="toc-text">challenge-21</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-26"><span class="toc-text">challenge-26</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-64"><span class="toc-text">challenge-64</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#命令执行"><span class="toc-text">命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-1"><span class="toc-text">PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-6"><span class="toc-text">challenge-6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-12"><span class="toc-text">challenge-12</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-2"><span class="toc-text">PHP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#challenge-1"><span class="toc-text">challenge-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chanllenge-3"><span class="toc-text">chanllenge-3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解法1"><span class="toc-text">解法1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解法二"><span class="toc-text">解法二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#challenge-5"><span class="toc-text">challenge-5</span></a></li></ol></li></ol>

  <div class="post-content">
    <p>今天开始做p神推荐的<a href="https://github.com/CHYbeta/Code-Audit-Challenges" target="_blank" rel="noopener">Code-Audit-Challenges</a></p>
<h1 id="弱类型比较"><a href="#弱类型比较" class="headerlink" title="弱类型比较"></a>弱类型比较</h1><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><h3 id="challenge-2"><a href="#challenge-2" class="headerlink" title="challenge-2"></a>challenge-2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$flag = <span class="string">"xxxx"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'time'</span>]))&#123; </span><br><span class="line">        <span class="keyword">if</span>(!is_numeric($_GET[<span class="string">'time'</span>]))&#123; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'The time must be number.'</span>; </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">'time'</span>] &lt; <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> * <span class="number">2</span>)&#123; </span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">'This time is too short.'</span>; </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">'time'</span>] &gt; <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> * <span class="number">3</span>)&#123; </span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">'This time is too long.'</span>; </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">                sleep((int)$_GET[<span class="string">'time'</span>]); </span><br><span class="line">                <span class="keyword">echo</span> $flag; </span><br><span class="line">        &#125; </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;hr&gt;'</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>is_numeric()用于检测变量是否为数字或数字字符串,像3e123或者0x123这样的字符串都会返回True</li>
<li>当3e123这样的字符串强制转换成int时会变成3<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> (int)<span class="string">'3e123'</span>; <span class="comment"># 输出3</span></span><br></pre></td></tr></table></figure></li>
<li>因此需要一个指数形式的字符串，范围在60<em>60</em>24<em>30</em>2和60<em>60</em>24<em>30</em>3之间<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?time&#x3D;6e6</span><br></pre></td></tr></table></figure>
等待6秒后即可拿到flag</li>
</ul>
<h3 id="challenge-7"><a href="#challenge-7" class="headerlink" title="challenge-7"></a>challenge-7</h3><p>代码漏了点东西，修改了一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$output = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>])) &#123;</span><br><span class="line">  $content = file_get_contents(<span class="keyword">__FILE__</span>);</span><br><span class="line">  $content = preg_replace(<span class="string">'/FLAG\-[0-9a-zA-Z_?!.,]+/i'</span>, <span class="string">'FLAG-XXXXXXXXXXXXXXXXXXXXXXX'</span>, $content);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'&lt;div class="code-highlight"&gt;'</span>;</span><br><span class="line">  highlight_string($content);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'pass'</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span>(!preg_match(<span class="string">'/^[^\W_]+$/'</span>, $_GET[<span class="string">'pass'</span>])) &#123;</span><br><span class="line">    $output = <span class="string">"Don't hack me please :("</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $pass = md5(<span class="string">"admin1674227342"</span>);</span><br><span class="line">    <span class="keyword">if</span> ((((((((($_GET[<span class="string">'pass'</span>] == $pass)))) &amp;&amp; (((($pass !== $_GET[<span class="string">'pass'</span>]))))) || ((((($pass == $_GET[<span class="string">'pass'</span>])))) &amp;&amp; ((($_GET[<span class="string">'pass'</span>] !== $pass)))))))) &#123; <span class="comment">// Trolling u lisp masta</span></span><br><span class="line">      <span class="keyword">if</span> (strlen($pass) == strlen($_GET[<span class="string">'pass'</span>])) &#123;</span><br><span class="line">        $output = <span class="string">"&lt;div class='alert alert-success'&gt;FLAG-abcdefg&lt;/div&gt;"</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $output = <span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password&lt;/div&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $output = <span class="string">"&lt;div class='alert alert-danger'&gt;Wrong password&lt;/div&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">echo</span> $output;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>md5(admin1674227342)为0e463854177790028825434984462555，可以当成指数来看</li>
<li>因此传入一个0e开头，位数相同的字符串即可，比如0e463854177790028825434984462550</li>
</ul>
<h3 id="challenge-10"><a href="#challenge-10" class="headerlink" title="challenge-10"></a>challenge-10</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;!--index.phps--&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(!$_GET[<span class="string">'id'</span>])</span><br><span class="line">&#123;</span><br><span class="line">	header(<span class="string">'Location: index.php?id=1'</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">$a=$_GET[<span class="string">'a'</span>];</span><br><span class="line">$b=$_GET[<span class="string">'b'</span>];</span><br><span class="line"><span class="keyword">if</span>(stripos($a,<span class="string">'.'</span>))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Hahahahahaha'</span>;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line">$data = @file_get_contents($a,<span class="string">'r'</span>);</span><br><span class="line"><span class="keyword">if</span>($data==<span class="string">"1112 is a nice lab!"</span> <span class="keyword">and</span> $id==<span class="number">0</span> <span class="keyword">and</span> strlen($b)&gt;<span class="number">5</span> <span class="keyword">and</span> eregi(<span class="string">"111"</span>.substr($b,<span class="number">0</span>,<span class="number">1</span>),<span class="string">"1114"</span>) <span class="keyword">and</span> substr($b,<span class="number">0</span>,<span class="number">1</span>)!=<span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">require</span>(<span class="string">"flag.txt"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"work harder!harder!harder!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要满足以下几个条件:</p>
<ol>
<li>传入$_GET[‘id’]并且$id==0</li>
<li>$data==”1112 is a nice lab!”</li>
<li>strlen($b)&gt;5 and eregi(“111”.substr($b,0,1),”1114”) and substr($b,0,1)!=4)</li>
</ol>
<p>绕过方法：</p>
<ul>
<li>利用php中非0都为真的特性和弱类型转换的特性即可绕过<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;a</span><br></pre></td></tr></table></figure></li>
<li>利用php伪协议php://input<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;php:&#x2F;&#x2F;input</span><br><span class="line">post: 1112 is a nice lab!</span><br></pre></td></tr></table></figure></li>
<li>可以将b设为%00111111，这样strlen不会发生截断，substr($b,0,1)为NULL,eregi(“111”,”1114”)匹配成功</li>
</ul>
<h3 id="challenge-13"><a href="#challenge-13" class="headerlink" title="challenge-13"></a>challenge-13</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$v1=<span class="number">0</span>;$v2=<span class="number">0</span>;$v3=<span class="number">0</span>;</span><br><span class="line">$a=(<span class="keyword">array</span>)json_decode(@$_GET[<span class="string">'foo'</span>]);</span><br><span class="line"><span class="keyword">if</span>(is_array($a))&#123;</span><br><span class="line">   is_numeric(@$a[<span class="string">"bar1"</span>])?<span class="keyword">die</span>(<span class="string">"nope"</span>):<span class="keyword">NULL</span>;</span><br><span class="line">   <span class="keyword">if</span>(@$a[<span class="string">"bar1"</span>])&#123;</span><br><span class="line">	   ($a[<span class="string">"bar1"</span>]&gt;<span class="number">2016</span>)?$v1=<span class="number">1</span>:<span class="keyword">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>(is_array(@$a[<span class="string">"bar2"</span>]))&#123;</span><br><span class="line">	   <span class="keyword">if</span>(count($a[<span class="string">"bar2"</span>])!==<span class="number">5</span> <span class="keyword">OR</span> !is_array($a[<span class="string">"bar2"</span>][<span class="number">0</span>])) <span class="keyword">die</span>(<span class="string">"nope"</span>);</span><br><span class="line">	   $pos = array_search(<span class="string">"nudt"</span>, $a[<span class="string">"a2"</span>]);</span><br><span class="line">	   $pos===<span class="keyword">false</span>?<span class="keyword">die</span>(<span class="string">"nope"</span>):<span class="keyword">NULL</span>;</span><br><span class="line">	   <span class="keyword">foreach</span>($a[<span class="string">"bar2"</span>] <span class="keyword">as</span> $key=&gt;$val)&#123;</span><br><span class="line">		   $val===<span class="string">"nudt"</span>?<span class="keyword">die</span>(<span class="string">"nope"</span>):<span class="keyword">NULL</span>;</span><br><span class="line">	   &#125;</span><br><span class="line">	   $v2=<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c=@$_GET[<span class="string">'cat'</span>];</span><br><span class="line">$d=@$_GET[<span class="string">'dog'</span>];</span><br><span class="line"><span class="keyword">if</span>(@$c[<span class="number">1</span>])&#123;</span><br><span class="line">   <span class="keyword">if</span>(!strcmp($c[<span class="number">1</span>],$d) &amp;&amp; $c[<span class="number">1</span>]!==$d)&#123;</span><br><span class="line">	   eregi(<span class="string">"3|1|c"</span>,$d.$c[<span class="number">0</span>])?<span class="keyword">die</span>(<span class="string">"nope"</span>):<span class="keyword">NULL</span>;</span><br><span class="line">	   strpos(($c[<span class="number">0</span>].$d), <span class="string">"htctf2016"</span>)?$v3=<span class="number">1</span>:<span class="keyword">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($v1 &amp;&amp; $v2 &amp;&amp; $v3)&#123;</span><br><span class="line">   <span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">   <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>payload<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?foo=&#123;<span class="string">"bar1"</span>:<span class="string">"2017aaa"</span>,<span class="string">"bar2"</span>:[[<span class="number">1</span>,<span class="number">2</span>],<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>],<span class="string">"a2"</span>:[<span class="string">"nudt"</span>]&#125;&amp;cat[<span class="number">0</span>]=ahtctf2016&amp;cat[<span class="number">1</span>][]=<span class="number">201612</span>&amp;dog=%<span class="number">00</span></span><br></pre></td></tr></table></figure></li>
<li>Code-Audit-Challenges的wp很详细了，就先不分析了</li>
</ul>
<h3 id="challenge-15"><a href="#challenge-15" class="headerlink" title="challenge-15"></a>challenge-15</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_GET[<span class="string">'name'</span>] == $_GET[<span class="string">'password'</span>])</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Your password can not be your name!&lt;/p&gt;'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sha1($_GET[<span class="string">'name'</span>]) === sha1($_GET[<span class="string">'password'</span>]))</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;Invalid password.&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;p&gt;Login first!&lt;/p&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用sha1传入数组会返回NULL<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name[]&#x3D;123&amp;password[]&#x3D;456</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="challenge-21"><a href="#challenge-21" class="headerlink" title="challenge-21"></a>challenge-21</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename = $_GET[<span class="string">'f'</span>];</span><br><span class="line"><span class="keyword">if</span>(stripos($filename, <span class="string">'file_list'</span>) != <span class="keyword">false</span>) <span class="keyword">die</span>();</span><br><span class="line">header(<span class="string">"Content-Type: application/octet-stream"</span>);</span><br><span class="line">header(<span class="string">"Content-Disposition: attachment; filename='$filename'"</span>);</span><br><span class="line">readfile(<span class="string">"uploads/$filename"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>目标是读取当前目录下的file_list.php</li>
<li>利用弱类型比较和一个php目录穿越的一个trick(先进入一个不存在的文件夹，然后再用../跳回来)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f&#x3D;file_list&#x2F;..&#x2F;..&#x2F;file_list.php</span><br></pre></td></tr></table></figure>
<h3 id="challenge-26"><a href="#challenge-26" class="headerlink" title="challenge-26"></a>challenge-26</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">"xxx"</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'answer'</span>]))&#123;</span><br><span class="line">		$number = $_POST[<span class="string">'answer'</span>];</span><br><span class="line">        <span class="keyword">if</span> (noother_says_correct($number))&#123;</span><br><span class="line">                <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Sorry"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noother_says_correct</span><span class="params">($number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $one = ord(<span class="string">'1'</span>);</span><br><span class="line">        $nine = ord(<span class="string">'9'</span>);</span><br><span class="line">        <span class="comment"># Check all the input characters!        </span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($number); $i++)</span><br><span class="line">        &#123; </span><br><span class="line">                <span class="comment"># Disallow all the digits!</span></span><br><span class="line">                $digit = ord($number&#123;$i&#125;);</span><br><span class="line">                <span class="keyword">if</span> ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )                </span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="comment"># Aha, digit not allowed!</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="comment"># Allow the magic number ...</span></span><br><span class="line">        <span class="keyword">return</span> $number == <span class="string">"3735929054"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>可以发现3735929054的16进制形式是deadc0de,不包含1-9，因此输入一个0xdeadc0de即可</li>
<li>需要注意的是，php7取消了16进制转换的特性，因此这题只能在php5的环境里做</li>
</ul>
<h3 id="challenge-64"><a href="#challenge-64" class="headerlink" title="challenge-64"></a>challenge-64</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>	</span><br><span class="line">	@$k1=$_GET[<span class="string">'key1'</span>];</span><br><span class="line">	@$k2=$_GET[<span class="string">'key2'</span>];</span><br><span class="line">	<span class="keyword">if</span>(@file_get_contents($k1)===<span class="string">"Hello hacker!"</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'welcome! Hacker!&lt;br&gt;'</span>;</span><br><span class="line">		<span class="keyword">if</span>(md5($k2)&gt;<span class="number">666666</span>*<span class="number">666666</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">include</span>(<span class="string">'ctf.php'</span>); </span><br><span class="line">			@$k3=$_GET[<span class="string">'key3'</span>];</span><br><span class="line">			@$k4=$_GET[<span class="string">'key4'</span>];</span><br><span class="line">			<span class="keyword">if</span>(intval($k3)&lt;<span class="number">666</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>($k3==<span class="number">666</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">echo</span> <span class="string">'Come on, flag is coming&lt;br&gt;'</span>;</span><br><span class="line">					<span class="keyword">if</span>($k4&gt;<span class="number">0</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span>(intval($k3+$k4)&lt;<span class="number">666</span>)</span><br><span class="line">							<span class="keyword">echo</span> $flag;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">exit</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">exit</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后的payload<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?key1&#x3D;php:&#x2F;&#x2F;input&amp;key2&#x3D;erewr&amp;key3&#x3D;0x29a&amp;key4&#x3D;9999999999999999999999999999</span><br><span class="line">post: Hello hacker!</span><br></pre></td></tr></table></figure></li>
<li>k1-k3就不写了，记录下k4这个点:</li>
</ul>
<ol>
<li>intval()是有范围限制的<blockquote>
<p>最大的值取决于操作系统。 32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval(‘1000000000000’) 会返回 2147483647。64 位系统上，最大带符号的 integer 值是 9223372036854775807</p>
</blockquote>
</li>
<li>php中如果一个整数过大，则会将其转为浮点数<blockquote>
<p>如果给定的一个数超出了 integer 的范围，将会被解释为 float。同样如果执行的运算结果超出了 integer 范围，也会返回 float。 </p>
</blockquote>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//32位系统下的溢出</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$large_number = <span class="number">2147483647</span>;</span><br><span class="line">var_dump($large_number);                     <span class="comment">// int(2147483647)</span></span><br><span class="line"></span><br><span class="line">$large_number = <span class="number">2147483648</span>;</span><br><span class="line">var_dump($large_number);                     <span class="comment">// float(2147483648)</span></span><br><span class="line"></span><br><span class="line">$million = <span class="number">1000000</span>;</span><br><span class="line">$large_number =  <span class="number">50000</span> * $million;</span><br><span class="line">var_dump($large_number);                     <span class="comment">// float(50000000000)</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>而这时如果把这个超大的浮点数转换为整数，则会返回未定义的值<blockquote>
<p>当从浮点数转换成整数时，将向下取整。<br>如果浮点数超出了整数范围（32 位平台下通常为 +/- 2.15e+9 = 2^31，64 位平台下，除了 Windows，通常为 +/- 9.22e+18 = 2^63），则结果为未定义，因为没有足够的精度给出一个确切的整数结果。在此情况下没有警告，甚至没有任何通知</p>
</blockquote>
</li>
</ol>
<p>测试发现在我的环境下会返回一个0</p>
<ul>
<li>综合利用以上三点，将$k4设为一个很大的值，$k3+$k4会转换为一个浮点数，然后intval会将这个浮点数转为整形，从而发生溢出返回一个0，拿到flag</li>
</ul>
<h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><h2 id="PHP-1"><a href="#PHP-1" class="headerlink" title="PHP"></a>PHP</h2><h3 id="challenge-6"><a href="#challenge-6" class="headerlink" title="challenge-6"></a>challenge-6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[ <span class="string">'ip'</span> ])) &#123;</span><br><span class="line">    $target = trim($_REQUEST[ <span class="string">'ip'</span> ]);</span><br><span class="line">    $substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'|'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line">    $cmd = shell_exec( <span class="string">'ping -c 4 '</span> . $target );</span><br><span class="line">        <span class="keyword">echo</span> $target;</span><br><span class="line">    <span class="keyword">echo</span>  <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用%0a即可执行多条命令<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1%0awhoami</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="challenge-12"><a href="#challenge-12" class="headerlink" title="challenge-12"></a>challenge-12</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$a = @$_REQUEST[<span class="string">'hello'</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"var_dump($a);"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>?hello=’xxx’);phpinfo();// 或 ?hello=xxx);phpinfo();// 皆可</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="PHP-2"><a href="#PHP-2" class="headerlink" title="PHP"></a>PHP</h2><h3 id="challenge-1"><a href="#challenge-1" class="headerlink" title="challenge-1"></a>challenge-1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************</span></span><br><span class="line"><span class="comment"> * PHP Challenge 2015</span></span><br><span class="line"><span class="comment"> *******************************************************************</span></span><br><span class="line"><span class="comment"> * Why leave all the fun to the XSS crowd?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do you know PHP?</span></span><br><span class="line"><span class="comment"> * And are you up to date with all its latest peculiarities?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Are you sure?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you believe you do then solve this challenge and create an</span></span><br><span class="line"><span class="comment"> * input that will make the following code believe you are the ADMIN.</span></span><br><span class="line"><span class="comment"> * Becoming any other user is not good enough, but a first step.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Attention this code is installed on a Mac OS X 10.9 system</span></span><br><span class="line"><span class="comment"> * that is running PHP 5.4.30 !!!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TIPS: OS X is mentioned because OS X never runs latest PHP</span></span><br><span class="line"><span class="comment"> *       Challenge will not work with latest PHP</span></span><br><span class="line"><span class="comment"> *       Also challenge will only work on 64bit systems</span></span><br><span class="line"><span class="comment"> *       To solve challenge you need to combine what a normal</span></span><br><span class="line"><span class="comment"> *       attacker would do when he sees this code with knowledge</span></span><br><span class="line"><span class="comment"> *       about latest known PHP quirks</span></span><br><span class="line"><span class="comment"> *       And you cannot bruteforce the admin password directly.</span></span><br><span class="line"><span class="comment"> *       To give you an idea - first half is:</span></span><br><span class="line"><span class="comment"> *          orewgfpeowöfgphewoöfeiuwgöpuerhjwfiuvuger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If you know the answer please submit it to info<span class="doctag">@sektioneins</span>.de</span></span><br><span class="line"><span class="comment"> ********************************************************************/</span></span><br><span class="line"></span><br><span class="line">$users = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"0:9b5c3d2b64b8f74e56edec71462bd97a"</span> ,</span><br><span class="line">        <span class="string">"1:4eb5fb1501102508a86971773849d266"</span>,</span><br><span class="line">        <span class="string">"2:facabd94d57fc9f1e655ef9ce891e86e"</span>,</span><br><span class="line">        <span class="string">"3:ce3924f011fe323df3a6a95222b0c909"</span>,</span><br><span class="line">        <span class="string">"4:7f6618422e6a7ca2e939bd83abde402c"</span>,</span><br><span class="line">        <span class="string">"5:06e2b745f3124f7d670f78eabaa94809"</span>,</span><br><span class="line">        <span class="string">"6:8e39a6e40900bb0824a8e150c0d0d59f"</span>,</span><br><span class="line">        <span class="string">"7:d035e1a80bbb377ce1edce42728849f2"</span>,</span><br><span class="line">        <span class="string">"8:0927d64a71a9d0078c274fc5f4f10821"</span>,</span><br><span class="line">        <span class="string">"9:e2e23d64a642ee82c7a270c6c76df142"</span>,</span><br><span class="line">        <span class="string">"10:70298593dd7ada576aff61b6750b9118"</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$valid_user = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">$input = $_COOKIE[<span class="string">'user'</span>]; </span><br><span class="line">$input[<span class="number">1</span>] = md5($input[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user)</span><br><span class="line">&#123;</span><br><span class="line">        $user = explode(<span class="string">":"</span>, $user);</span><br><span class="line">        <span class="keyword">if</span> ($input === $user) &#123;</span><br><span class="line">                $uid = $input[<span class="number">0</span>] + <span class="number">0</span>;</span><br><span class="line">                $valid_user = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$valid_user) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"not a valid user\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($uid == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello Admin How can I serve you today?\n"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"SECRETS ....\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Welcome back user\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>作者的<a href="https://www.sektioneins.de/blog/15-08-03-php_challenge_2015_solution.html" target="_blank" rel="noopener">wp</a>已经很详细了，这题就先不分析了</li>
<li>最后的payload<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: user[4294967296]&#x3D;5; user[1]&#x3D;hund</span><br></pre></td></tr></table></figure></li>
<li>有一个要注意的是作者只说了<blockquote>
<p>challenge will only work on 64bit systems</p>
</blockquote>
</li>
</ul>
<p>但实际上php也必须是64位的才行，32位php的数组键值不能是这么大的数，因此user[4294967296]会变为user[‘4294967296’]</p>
<h3 id="chanllenge-3"><a href="#chanllenge-3" class="headerlink" title="chanllenge-3"></a>chanllenge-3</h3><ul>
<li><p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = addslashes($_GET[<span class="string">'option'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'xxxxx/option.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">'|\$option=\'.*\';|'</span>, <span class="string">"\$option='$str';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'xxxxx/option.php'</span>, $file);</span><br></pre></td></tr></table></figure></li>
<li><p>option.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$option=<span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>这题的场景是配置文件写入</p>
<h4 id="解法1"><a href="#解法1" class="headerlink" title="解法1"></a>解法1</h4></li>
<li><p>preg_replace没有使用m修饰符，因此只会匹配单行</p>
<blockquote>
<p>m (PCRE_MULTILINE)<br>默认情况下，PCRE 认为目标字符串是由单行字符组成的(然而实际上它可能会包含多行)， “行首”元字符 (^) 仅匹配字符串的开始位置， 而”行末”元字符 ($) 仅匹配字符串末尾， 或者最后的换行符(除非设置了 D 修饰符)。这个行为和 perl 相同。 当这个修饰符设置之后，“行首”和“行末”就会匹配目标字符串中任意换行符之前或之后，另外， 还分别匹配目标字符串的最开始和最末尾位置。这等同于 perl 的 /m 修饰符。如果目标字符串 中没有 “\n” 字符，或者模式中没有出现 ^ 或 $，设置这个修饰符不产生任何影响</p>
</blockquote>
</li>
<li><p>利用这一点，注入一个换行符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?option=<span class="number">123</span><span class="string">';%0a phpinfo();//</span></span><br></pre></td></tr></table></figure></li>
<li><p>这时option.php变为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$option=<span class="string">'123\';</span></span><br><span class="line"><span class="string"> phpinfo();//'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>将转义字符\去掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?option&#x3D;123</span><br></pre></td></tr></table></figure>
<p>这时option.php变为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$option=<span class="string">'123'</span>;</span><br><span class="line"> phpinfo();<span class="comment">//';</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h4></li>
<li><p>php文档中preg_replace部分有以下内容:</p>
<blockquote>
<p>如果要在replacement 中使用反斜线，必须使用4个(“\\\\“，译注：因为这首先是php的字符串，经过转义后，是两个，再经过正则表达式引擎后才被认为是一个原文反斜线)。</p>
</blockquote>
</li>
</ul>
<p>其中replacement是第二个参数</p>
<ul>
<li>因此$str中如果存在\\的话会被当成\,可以利用这个\去转义addslashes添加的\<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?option&#x3D;123\&#39;;phpinfo();&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="challenge-5"><a href="#challenge-5" class="headerlink" title="challenge-5"></a>challenge-5</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">"display_errors"</span>, <span class="string">"On"</span>);</span><br><span class="line">error_reporting(E_ALL | E_STRICT);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">   show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">   <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rand_string</span><span class="params">( $length )</span> </span>&#123;</span><br><span class="line">   $chars = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>;    </span><br><span class="line">   $size = strlen( $chars );</span><br><span class="line">   $str = <span class="string">''</span>;</span><br><span class="line">   <span class="keyword">for</span>( $i = <span class="number">0</span>; $i &lt; $length; $i++ ) &#123;</span><br><span class="line">	   $str .= $chars[ rand( <span class="number">0</span>, $size - <span class="number">1</span> ) ];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line">$data = $_GET[<span class="string">'c'</span>];</span><br><span class="line">$black_list = <span class="keyword">array</span>(<span class="string">' '</span>, <span class="string">'!'</span>, <span class="string">'"'</span>, <span class="string">'#'</span>, <span class="string">'%'</span>, <span class="string">'&amp;'</span>, <span class="string">'*'</span>, <span class="string">','</span>, <span class="string">'-'</span>, <span class="string">'/'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">':'</span>, <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>, <span class="string">'?'</span>, <span class="string">'@'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'N'</span>, <span class="string">'O'</span>, <span class="string">'P'</span>, <span class="string">'Q'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'T'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'\\'</span>, <span class="string">'^'</span>, <span class="string">'`'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'j'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'o'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'|'</span>, <span class="string">'~'</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $b) &#123;</span><br><span class="line">   <span class="keyword">if</span> (stripos($data, $b) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">	   <span class="keyword">die</span>(<span class="string">"WAF!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">$filename=rand_string(<span class="number">0x20</span>).<span class="string">'.php'</span>;</span><br><span class="line">$folder=<span class="string">'uploads/'</span>;</span><br><span class="line">$full_filename = $folder.$filename;</span><br><span class="line"><span class="keyword">if</span>(file_put_contents($full_filename, <span class="string">'&lt;?php '</span>.$data))&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"&lt;a href='"</span>.$full_filename.<span class="string">"'&gt;WebShell&lt;/a&gt;&lt;/br&gt;"</span>;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Enjoy your webshell~"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Some thing wrong..."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以参考p神文章<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></li>
</ul>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2019-11-24</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/writeup/" rel="tag">writeup</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2022
  <span class="author">
    LionTree
  </span>
</footer>


    </div>
  </body>
</html>