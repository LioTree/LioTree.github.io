<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>FUGIO Fuzzer部分源码分析 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=反序列化,paper-reading,fuzzing>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">FUGIO Fuzzer部分源码分析</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Seed"><span class="toc-text">Seed</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Select-Seed"><span class="toc-text">Select Seed</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类"><span class="toc-text">将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds"><span class="toc-text">按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终选择seed"><span class="toc-text">最终选择seed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#存在到达sink点的seed"><span class="toc-text">存在到达sink点的seed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不存在到达sink点的seed"><span class="toc-text">不存在到达sink点的seed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mutation"><span class="toc-text">Mutation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Add-New-Properties"><span class="toc-text">Add New Properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mutate-Properties"><span class="toc-text">Mutate Properties</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PUT-Generation"><span class="toc-text">PUT Generation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Execution"><span class="toc-text">Execution</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feedback"><span class="toc-text">Feedback</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Branch-Coverage"><span class="toc-text">Branch Coverage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Depth-of-a-Gadget-Reached"><span class="toc-text">The Depth of a Gadget Reached</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Property-Hinting"><span class="toc-text">Property Hinting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#条件分支的hint"><span class="toc-text">条件分支的hint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数组索引的hint"><span class="toc-text">数组索引的hint</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-Error"><span class="toc-text">Reference Error</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploit-oracle"><span class="toc-text">Exploit oracle</span></a></li></ol>

  <div class="post-content">
    <p>论文：<a href="https://www.usenix.org/conference/usenixsecurity22/presentation/park-sunnyeo" target="_blank" rel="noopener">FUGIO: Automatic Exploit Generation for PHP Object Injection Vulnerabilities</a></p>
<p>源码：<a href="https://github.com/WSP-LAB/FUGIO" target="_blank" rel="noopener">https://github.com/WSP-LAB/FUGIO</a></p>
<p><img src="/images/FUGIO%E6%9E%B6%E6%9E%84.png" alt="FUGIO架构"></p>
<p>整体架构如图所示，先通过POP Chain Identifier静态分析出潜在的PHP反序列化漏洞利用链，再通过POP Chain Fuzzer进行动态的验证以及POC的生成。</p>
<p>这里主要关注POP Chain Fuzzer部分，算法伪代码描述如下：</p>
<p><img src="/images/FUGIO_fuzzing%E7%AE%97%E6%B3%95.png" alt="FUGIO Fuzzing算法"></p>
<p>主要逻辑位于<code>Fuzzer/FuzzSlave.php</code>中的<code>RunFuzz</code>方法</p>
<h1 id="Seed"><a href="#Seed" class="headerlink" title="Seed"></a>Seed</h1><p>Seed对应的类为<code>SeedNode</code>，其中比较重要的属性包括：</p>
<ul>
<li><p><code>$input_tree</code>，对应一条将要生成的反序列化利用链，里面会记录类名以及该类各个属性的值，也就是论文中说的property tree</p>
</li>
<li><p><code>$goal_depth</code>，在POP链（来自POP Chain Identifier的结果）中已执行的最大深度</p>
</li>
<li><p><code>depth</code>，好像没到达sink点的话就是<code>$goal_depth-1</code>，到达了sink点就一样</p>
</li>
<li><p><code>$select_count</code>，seed被选择过的次数</p>
</li>
</ul>
<p>对应于伪代码的1-3行，FUGIO首先生成一个seed并加入<code>seed_pool</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// First time: set root seed</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;seed_pool-&gt;root == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;seed_pool-&gt;SetRoot(<span class="keyword">$this</span>-&gt;GenerateFirstSeed());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GenerateFirstSeed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $payload_creator = <span class="keyword">new</span> PayloadCreator();</span><br><span class="line">    $new_seed = <span class="keyword">new</span> SeedNode();</span><br><span class="line"></span><br><span class="line">    $new_seed-&gt;class_template = $payload_creator-&gt;MakeGadgetTemplate(<span class="keyword">$this</span>-&gt;gadget[<span class="number">0</span>]);</span><br><span class="line">    $new_seed-&gt;input_tree = $payload_creator-&gt;GenerateRandomProperties(</span><br><span class="line">                                                $new_seed-&gt;class_template,</span><br><span class="line">                                                <span class="keyword">$this</span>-&gt;gadget[<span class="number">0</span>],</span><br><span class="line">                                                <span class="keyword">$this</span>-&gt;file_chain</span><br><span class="line">                                              );</span><br><span class="line">    $new_seed-&gt;parent = <span class="keyword">NULL</span>;</span><br><span class="line">    $new_seed-&gt;goal_depth = <span class="number">0</span>;</span><br><span class="line">    $new_seed-&gt;depth = <span class="number">-1</span>;</span><br><span class="line">    $new_seed-&gt;select_count = <span class="number">0</span>;</span><br><span class="line">    $new_seed-&gt;seed_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $new_seed;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>举个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;o-&gt;jump(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">jump</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">$this</span>-&gt;o2-&gt;evil($a);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Baz</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;con == <span class="number">5</span>) &#123;</span><br><span class="line">                    system($a);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">unserialize(base64_decode($_GET[<span class="string">'input'</span>]));</span><br></pre></td></tr></table></figure>

<p>此时生成的第一个seed的<code>input_tree</code>为:</p>
<p><img src="/images/FUGIO_input_tree.png" alt="input_tree"></p>
<p>可以看到此时的seed只包含链子中第一个gadget的结构，因为<code>Foo::__destruct</code>中会调用<code>$this-&gt;o</code>属性的<code>jump</code>方法，<code>$this-&gt;o</code>被设为了存在<code>jump</code>方法的<code>Bar</code>类对象，而<code>$this-&gt;a</code>则被随机设为了<code>FilePath</code>类型</p>
<h1 id="Select-Seed"><a href="#Select-Seed" class="headerlink" title="Select Seed"></a>Select Seed</h1><p>seed选择的实现位于<code>Fuzzer/SeedTree.php</code>中的<code>CherryPick</code>方法，对应伪代码第5行，分为3个步骤</p>
<h2 id="将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类"><a href="#将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类" class="headerlink" title="将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类"></a>将seed按深度、被选择的次数以及是否到达sink点3个指标进行分类</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Split seeds by depth</span></span><br><span class="line">$seed_dict = <span class="keyword">array</span>();</span><br><span class="line">$seed_queue = <span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;root);</span><br><span class="line"><span class="keyword">while</span> ($seed = array_shift($seed_queue)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!array_key_exists($seed-&gt;goal_depth, $seed_dict)) &#123;</span><br><span class="line">    $goal_depth = $seed-&gt;goal_depth + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ($max_goal_depth &lt;= $goal_depth) &#123;</span><br><span class="line">      $max_goal_depth = $goal_depth;</span><br><span class="line">    &#125;</span><br><span class="line">    $seed_dict[$goal_depth][<span class="string">'TRY_O'</span>] = <span class="keyword">array</span>();</span><br><span class="line">    $seed_dict[$goal_depth][<span class="string">'TRY_X'</span>] = <span class="keyword">array</span>();</span><br><span class="line">    $seed_dict[$goal_depth][<span class="string">'TRY_O_SINK_REACHED'</span>] = <span class="keyword">array</span>();</span><br><span class="line">    $seed_dict[$goal_depth][<span class="string">'TRY_X_SINK_REACHED'</span>] = <span class="keyword">array</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ($seed-&gt;select_count == <span class="number">0</span>) &#123;</span><br><span class="line">    array_push($seed_dict[$goal_depth][<span class="string">'TRY_X'</span>], $seed);</span><br><span class="line">    <span class="keyword">if</span> ($seed-&gt;sink_reached[<span class="string">'reach'</span>] == <span class="keyword">True</span>) &#123;</span><br><span class="line">      array_push($seed_dict[$goal_depth][<span class="string">'TRY_X_SINK_REACHED'</span>], $seed);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    array_push($seed_dict[$goal_depth][<span class="string">'TRY_O'</span>], $seed);</span><br><span class="line">    <span class="keyword">if</span> ($seed-&gt;sink_reached[<span class="string">'reach'</span>] == <span class="keyword">True</span>) &#123;</span><br><span class="line">      array_push($seed_dict[$goal_depth][<span class="string">'TRY_O_SINK_REACHED'</span>], $seed);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> ($seed-&gt;child <span class="keyword">as</span> $child_seed) &#123;</span><br><span class="line">    array_push($seed_queue, $child_seed);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终<code>$seed_dict</code>的结构如下：</p>
<p><img src="/images/FUGIO_seed_dict.png" alt="seed_dict"></p>
<p>其中索引<code>1</code>代表这些seeds的<code>$goal_depth</code>都为0，<code>TRY_X</code>代表未被选择过的seed，<code>TRY_O</code>则相反。如果1个seed到达了sink点，则它会同时出现在<code>TRY_X</code>和<code>TRY_X_SINK_REACHED</code>或者<code>TRY_O</code>和<code>TRY_O_SINK_REACHED</code>中</p>
<h2 id="按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds"><a href="#按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds" class="headerlink" title="按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds"></a>按照公式计算不同深度seed的分数，根据分数按不同概率选择某一个深度的seeds</h2><p>计算分数的公式：</p>
<p><img src="/images/FUGIO_scores.png" alt="scores"></p>
<p>其中<code>diff</code>为当前seed的<code>goal_depth</code>和整个链子深度的差值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Select depth</span></span><br><span class="line">$depth_scores = <span class="keyword">array</span>();</span><br><span class="line">$depth_sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($seed_dict <span class="keyword">as</span> $goal_depth =&gt; $seeds) &#123;</span><br><span class="line">  $power = (<span class="number">5</span> * ($fianl_goal_depth - $goal_depth) / ($max_goal_depth));</span><br><span class="line">  $depth_score = <span class="number">1</span>/(<span class="number">1</span>+pow(exp(<span class="number">1</span>), $power));</span><br><span class="line">  array_push($depth_scores, $depth_score);</span><br><span class="line">  $depth_sum += $depth_score;</span><br><span class="line">&#125;</span><br><span class="line">$depth_probability = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> ($depth_scores <span class="keyword">as</span> $goal_depth =&gt; $depth_score) &#123;</span><br><span class="line">  array_push($depth_probability, $depth_score/$depth_sum);</span><br><span class="line">&#125;</span><br><span class="line">$selected_depth_array = <span class="keyword">$this</span>-&gt;RandomChoiceByProbability($seed_dict,</span><br><span class="line">                                                         $depth_probability);</span><br></pre></td></tr></table></figure>

<p>最终的<code>$selected_depth_array</code>就是被选择的某个深度的所有seeds</p>
<h2 id="最终选择seed"><a href="#最终选择seed" class="headerlink" title="最终选择seed"></a>最终选择seed</h2><h3 id="存在到达sink点的seed"><a href="#存在到达sink点的seed" class="headerlink" title="存在到达sink点的seed"></a>存在到达sink点的seed</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($count_sink_reached &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  $try_o_prob_sum = <span class="number">0</span>;</span><br><span class="line">  $sink_reached_try_o_prob_sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">foreach</span> ($selected_depth_array[<span class="string">'TRY_O'</span>] <span class="keyword">as</span> $try_o_seed) &#123;</span><br><span class="line">    $power = $try_o_seed-&gt;select_count / ($const_exp * $const_max_try);</span><br><span class="line">    $try_o_alpha = <span class="number">2</span> / (<span class="number">1</span> + pow($const_exp, $power));</span><br><span class="line">    <span class="keyword">if</span> ($try_o_seed-&gt;sink_reached[<span class="string">'reach'</span>]) &#123;</span><br><span class="line">      $try_o_prob = (($const_sink_weight) /</span><br><span class="line">                    ($count_try_o_sink_reached + $count_try_x_sink_reached)) *</span><br><span class="line">                    $try_o_alpha;</span><br><span class="line">      $sink_reached_try_o_prob_sum += $try_o_prob;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      $try_o_prob = ((<span class="number">1</span> - $const_sink_weight) /</span><br><span class="line">                    (($count_try_o + $count_try_x) -</span><br><span class="line">                    ($count_try_o_sink_reached + $count_try_x_sink_reached))) *</span><br><span class="line">                    $try_o_alpha;</span><br><span class="line">      $try_o_prob_sum += $try_o_prob;</span><br><span class="line">    &#125;</span><br><span class="line">    array_push($seeds, $try_o_seed);</span><br><span class="line">    array_push($seed_probabilities, $try_o_prob);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">foreach</span> ($selected_depth_array[<span class="string">'TRY_X'</span>] <span class="keyword">as</span> $try_x_seed) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($try_x_seed-&gt;sink_reached[<span class="string">'reach'</span>]) &#123;</span><br><span class="line">      $try_x_prob = ($const_sink_weight - $sink_reached_try_o_prob_sum) /</span><br><span class="line">                    ($count_try_x_sink_reached);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      $try_x_prob = (((<span class="number">1</span> - $const_sink_weight) - ($try_o_prob_sum)) /</span><br><span class="line">                    (($count_try_o + $count_try_x) -</span><br><span class="line">                    ($count_try_o_sink_reached + $count_try_x_sink_reached) -</span><br><span class="line">                    ($count_try_o)));</span><br><span class="line">    &#125;</span><br><span class="line">    array_push($seeds, $try_x_seed);</span><br><span class="line">    array_push($seed_probabilities, $try_x_prob);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>$const_sink_weight</code>为<code>0.9</code>，也就是论文中说的：</p>
<blockquote>
<p>When the seed pool includes seeds that reach the sink,<br>FUGIO splits the probability of 1.0 into 0.9 and 0.1. It then<br>uniformly distributes the probability of 0.9 across seeds that<br>have reached the sink. The probability of 0.1 is also uniformly<br>distributed across the remaining seeds in the pool.</p>
</blockquote>
<h3 id="不存在到达sink点的seed"><a href="#不存在到达sink点的seed" class="headerlink" title="不存在到达sink点的seed"></a>不存在到达sink点的seed</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  $try_o_prob_sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">foreach</span> ($selected_depth_array[<span class="string">'TRY_O'</span>] <span class="keyword">as</span> $try_o_seed) &#123;</span><br><span class="line">    $power = $try_o_seed-&gt;select_count / ($const_exp * $const_max_try);</span><br><span class="line">    $try_o_alpha = <span class="number">2</span> / (<span class="number">1</span> + pow($const_exp, $power));</span><br><span class="line">    $try_o_prob = (<span class="number">1</span> / ($count_try_o + $count_try_x)) * $try_o_alpha;</span><br><span class="line">    array_push($seeds, $try_o_seed);</span><br><span class="line">    array_push($seed_probabilities, $try_o_prob);</span><br><span class="line">    $try_o_prob_sum += $try_o_prob;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">foreach</span> ($selected_depth_array[<span class="string">'TRY_X'</span>] <span class="keyword">as</span> $try_x_seed) &#123;</span><br><span class="line">    $try_x_prob = (<span class="number">1</span> - $try_o_prob_sum) / ($count_try_x);</span><br><span class="line">    array_push($seeds, $try_x_seed);</span><br><span class="line">    array_push($seed_probabilities, $try_x_prob);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是类似，<code>TRY_O</code>和<code>TRY_X</code>的计算方式不同，更倾向于选择<code>TRY_X</code></p>
<h1 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h1><p>伪代码第6行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add new properties</span></span><br><span class="line">$copied_seed-&gt;input_tree = $payload_creator-&gt;MakeAuxiliaryTemplateWithProp(</span><br><span class="line">                            $copied_seed-&gt;input_tree,</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;gadget[$selected_seed-&gt;depth + <span class="number">1</span>],</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;cand_props_hash_table</span><br><span class="line">                           );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mutate properties</span></span><br><span class="line">$copied_seed-&gt;input_tree = $payload_creator-&gt;SetMutateProperties(</span><br><span class="line">                            $copied_seed-&gt;input_tree,</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;file_chain, <span class="keyword">$this</span>-&gt;gadget,</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;cand_class, <span class="keyword">$this</span>-&gt;cand_foreach,</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;hinting_infos,</span><br><span class="line">                            $copied_seed-&gt;array_hinting,</span><br><span class="line">                            $copied_seed-&gt;array_object</span><br><span class="line">                           );</span><br></pre></td></tr></table></figure>

<h2 id="Add-New-Properties"><a href="#Add-New-Properties" class="headerlink" title="Add New Properties"></a>Add New Properties</h2><p>实现位于<code>/Fuzzer/PayloadCreator.php</code>中的<code>MakeAuxiliaryTemplateWithProp</code>方法</p>
<p>这里会随机添加一些类中明确定义但在给定方法中没有直接使用的属性，比如上面那个例子中虽然<code>Foo::__destruct</code>中没有用到<code>$p</code>，但仍然有一定概率将<code>$p</code>添加到<code>input_tree</code>中，虽然并不知道这样有啥用…</p>
<ul>
<li>判断是否需要添加属性</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$gen_aux_probability = rand(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">if</span> ($gen_aux_probability &gt; MAKE_AUX_PROP) &#123; <span class="comment">// Make Aux?</span></span><br><span class="line">  <span class="keyword">return</span> $input_tree;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>遍历该类明确定义的属性(<code>$gadget_info-&gt;prop_list</code>)，按照一定概率保存到<code>$aux_props</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$prop_list = $gadget_info-&gt;prop_list;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Aux prop in prop_list (selecting)</span></span><br><span class="line">$aux_props = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> ($prop_list <span class="keyword">as</span> $prop) &#123;</span><br><span class="line">  $gen_aux_sub_probability = rand(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">  <span class="keyword">if</span> ($gen_aux_sub_probability &lt;= MAKE_AUX_SUB_PROP) &#123;</span><br><span class="line">    array_push($aux_props, $prop);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加到seed中去，<code>new_aux_props</code>中保存的是<code>$aux_props</code>中属性构造的属性树</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Adding Aux prop (prop_list)</span></span><br><span class="line"><span class="keyword">if</span> ($node[<span class="string">'value'</span>] == $gadget_info-&gt;class <span class="keyword">and</span> $node[<span class="string">'file'</span>] == $gadget_info-&gt;file) &#123;</span><br><span class="line">  <span class="keyword">foreach</span> ($new_aux_props <span class="keyword">as</span> $new_obj_property) &#123;</span><br><span class="line">    $new_add_flag = <span class="keyword">True</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($node[<span class="string">'deps'</span>] <span class="keyword">as</span> $obj_property_key =&gt; $obj_property_value) &#123;</span><br><span class="line">      <span class="keyword">if</span> ($new_obj_property[<span class="string">'name'</span>] == $obj_property_value[<span class="string">'name'</span>]) &#123;</span><br><span class="line">        $new_add_flag = <span class="keyword">False</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($new_add_flag) &#123;</span><br><span class="line">      $adding_props[$new_obj_property[<span class="string">'name'</span>]] = $new_obj_property;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  $node[<span class="string">'deps'</span>] = $node[<span class="string">'deps'</span>] + $adding_props;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了<code>prop_list</code>之外还会添加<code>prop_candidates</code>中的属性，没看懂啥时候会用到这个，试了几个benchmark感觉像是废的…</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Aux prop in prop_candidates (Selecting)</span></span><br><span class="line">$aux_props_cands = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> ($cand_props_hash_table <span class="keyword">as</span> $cand_class =&gt; $props_in_class) &#123;</span><br><span class="line">  <span class="keyword">foreach</span> ($props_in_class <span class="keyword">as</span> $prop_in_class) &#123;</span><br><span class="line">    $gen_aux_sub_probability = rand(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> ($gen_aux_sub_probability &lt;= MAKE_AUX_SUB_PROP) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!array_key_exists($cand_class, $aux_props_cands)) &#123;</span><br><span class="line">        $aux_props_cands[$cand_class] = <span class="keyword">array</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $aux_props_cands[$cand_class][$prop_in_class[<span class="string">'name'</span>]] = $prop_in_class;</span><br><span class="line">      <span class="comment">// array_push($aux_props_cands[$cand_class], $prop_in_class);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mutate-Properties"><a href="#Mutate-Properties" class="headerlink" title="Mutate Properties"></a>Mutate Properties</h2><p>对seed中的属性进行变异，实现位于<code>/Fuzzer/PayloadCreator.php</code>中的<code>SetMutateProperties</code>方法</p>
<ul>
<li>针对<code>Object</code>类型进行变异时会随机从候选的类中随机选择。例如上面那个例子中<code>__destruct</code>中调用了<code>$this-&gt;o</code>的<code>jump</code>方法，候选的类就只有包含<code>jump</code>方法的<code>Bar</code>类</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (rand(<span class="number">0</span>, <span class="number">100</span>) &lt;= <span class="number">70</span>) &#123; <span class="comment">//变异</span></span><br><span class="line">    $obj_candidates = $candidates-&gt;candidates;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($obj_candidates)) &#123;</span><br><span class="line">      $choice = rand(<span class="number">0</span>, count($obj_candidates) - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($obj_candidates[$choice]-&gt;value)) &#123;</span><br><span class="line">        var_dump($prop[<span class="string">'name'</span>]);</span><br><span class="line">        <span class="keyword">echo</span> $choice . <span class="string">"\n"</span>;</span><br><span class="line">        var_dump($obj_candidates);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $parent_class = $obj_candidates[$choice]-&gt;value-&gt;class;</span><br><span class="line">      $parent_file = $obj_candidates[$choice]-&gt;value-&gt;file;</span><br><span class="line">      $prop[<span class="string">'value'</span>] = $parent_class;</span><br><span class="line">      $prop[<span class="string">'visibility'</span>] = $obj_candidates[$choice]-&gt;visibility;</span><br><span class="line">      $prop[<span class="string">'file'</span>] = $parent_file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//维持不变</span></span><br><span class="line">      $parent_class = $prop[<span class="string">'value'</span>];</span><br><span class="line">      $parent_file = $prop[<span class="string">'file'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于其他类型的属性，随机挑选类型进行变异</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Do not change</span></span><br><span class="line"><span class="keyword">if</span> ($mutate_probability &gt; MUTATE_PROP <span class="keyword">and</span> $prop[<span class="string">'type'</span>] != <span class="string">"Unknown"</span>) &#123;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>($value_type) &#123;</span><br><span class="line">  <span class="comment">// String</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    $prop[<span class="string">'type'</span>] = <span class="string">"String"</span>;</span><br><span class="line">    $prop[<span class="string">'value'</span>] = <span class="keyword">$this</span>-&gt;GetRandomString();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="comment">// Int</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    $prop[<span class="string">'type'</span>] = <span class="string">"Int"</span>;</span><br><span class="line">    $prop[<span class="string">'value'</span>] = <span class="keyword">$this</span>-&gt;GetRandomInt();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="comment">// Boolean</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    $prop[<span class="string">'type'</span>] = <span class="string">"Boolean"</span>;</span><br><span class="line">    $prop[<span class="string">'value'</span>] = <span class="keyword">$this</span>-&gt;GetRandomBoolean();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    $prop[<span class="string">'type'</span>] = <span class="string">"Array"</span>;</span><br><span class="line">    <span class="keyword">if</span> (count($array_hinting) != <span class="number">0</span>) &#123;</span><br><span class="line">      $prop[<span class="string">'value'</span>] = <span class="keyword">$this</span>-&gt;GetHintingArray($file_chain, $array_hinting);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      $prop[<span class="string">'value'</span>] = <span class="keyword">$this</span>-&gt;GetRandomArray($file_chain);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>

<ul>
<li>此外对于<code>ArrayObject</code>类型的属性也有特殊的处理</li>
</ul>
<h1 id="PUT-Generation"><a href="#PUT-Generation" class="headerlink" title="PUT Generation"></a>PUT Generation</h1><p>在POP Chain Identifier和POP Chain Fuzzer启动前，PUT Generator部分会在<code>Files/fuzzing/目标目录.时间戳/PUT/</code>生成以下文件：</p>
<ul>
<li><p><code>class-带有命名空间的类名.php</code>，所谓的PUT(Program Under Test)，其实就是将每个类的定义拆分到单独的文件中，例如上面例子中会生成<code>class-bar.php</code> <code>class-baz.php</code>和<code>class-foo.php</code></p>
</li>
<li><p><code>put-body.php</code>，<code>include_once</code>所有的PUT</p>
</li>
<li><p><code>put-head.php</code>，使用uopz对内置函数进行hook相关，似乎是废弃的没啥用</p>
</li>
</ul>
<p>除此之外，FUGIO还会先调用<code>Fuzzer/Instrumentor.php</code>，使用phpParser对PUT进行插桩从而向Fuzzer提供feedback，这一步会在<code>Files/fuzzing/app.xxx.xxxx/PUT/</code>下生成以下文件：</p>
<ul>
<li><code>inst-class-带有命名空间的类名.php</code>，上述例子中生成的<code>inst-class-baz.php</code>为：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Baz</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">evil</span>($<span class="title">a</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $GLOBALS['Feedback_cls']-&gt;isBranchPassed('000000006b06bc4800000000724d4095', 'METHOD-ENTRY', debug_backtrace());</span><br><span class="line">            <span class="keyword">if</span> ($GLOBALS[<span class="string">'Feedback_cls'</span>]-&gt;isBranchPassed(<span class="string">'000000006b06bc7100000000724d4095'</span>, <span class="string">'COND-PRE'</span>, <span class="keyword">array</span>()) &amp;&amp; <span class="keyword">$this</span>-&gt;con == <span class="number">5</span> &amp;&amp; $GLOBALS[<span class="string">'Feedback_cls'</span>]-&gt;isBranchPassed(<span class="string">'000000006b06bc7100000000724d4095'</span>, <span class="string">'COND-POST'</span>, <span class="keyword">array</span>())) &#123;</span><br><span class="line">                $GLOBALS[<span class="string">'Feedback_cls'</span>]-&gt;funcWrapped(<span class="string">'system'</span>, debug_backtrace(), <span class="string">'000000006b06bc7500000000724d4095'</span>, <span class="string">'Baz'</span>, <span class="string">'evil'</span>, <span class="string">'1'</span>, $a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> &#123;</span><br><span class="line">    <span class="title">if</span> (<span class="title">getenv</span>("<span class="title">FUZZ_CMD</span>") === "<span class="title">FuzzerInit</span>") &#123;</span><br><span class="line">        $GLOBALS['Feedback_cls']-&gt;initIfConstraint('000000006b06bc7100000000724d4095', array('TYPE_VALUE', 'con', 'Int', '5', 'IF'));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，原有的方法调用被包裹了一层<code>$GLOBALS[&#39;Feedback_cls&#39;]-&gt;setMethodWrapped</code>，条件分支则前后都被包裹了一个<code>$GLOBALS[&#39;Feedback_cls&#39;]-&gt;isBranchPassed</code>，并且方法的入口点也添加了一个<code>$GLOBALS[&#39;Feedback_cls&#39;]-&gt;isBranchPassed</code></p>
<p>除此之外，在该文件的最后还添加了一个<code>$GLOBALS[&#39;Feedback_cls&#39;]-&gt;initIfConstraint</code>，该语句用于给Fuzzer提供属性具体值的hint，从而加快Fuzzer执行的速度</p>
<ul>
<li><code>inst_PUT.php</code>，其中包含了<code>isBranchPassed</code>以及<code>setMethodWrapped</code>等插桩方法的实现，以及对用户输入的反序列化进行测试</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ConstraintFeedback</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">......        </span><br><span class="line">        <span class="comment">//各种插桩方法的实现</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">isBranchPassed</span><span class="params">($stmt_id, $type, $call_stack, $argv_array = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;BranchPath, <span class="keyword">array</span>(<span class="string">"hash"</span> =&gt; $stmt_id, <span class="string">"type"</span> =&gt; $type, <span class="string">"call_stack"</span> =&gt; $call_stack, <span class="string">"argvs"</span> =&gt; $argv_array));</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;goalPath <span class="keyword">as</span> &amp;$goalPath) &#123;</span><br><span class="line">                <span class="keyword">if</span> ($goalPath[<span class="string">'hash'</span>] == $stmt_id) &#123;</span><br><span class="line">                    $goalPath[<span class="string">'hitCount'</span>] += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">        &#125;</span><br><span class="line">......</span><br><span class="line">            <span class="comment">//将执行的feedback传给rabbitmq</span></span><br><span class="line">            $channel = $connection-&gt;channel();</span><br><span class="line">            $channel-&gt;queue_declare($rabbitmq_channel, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (getenv(<span class="string">"FUZZ_CMD"</span>) == <span class="string">"FuzzerInit"</span>) &#123;</span><br><span class="line">                $msg = <span class="keyword">new</span> AMQPMessage(serialize($GLOBALS[<span class="string">'Feedback_cls'</span>]-&gt;init_output));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $msg = <span class="keyword">new</span> AMQPMessage(serialize($feedback_output));</span><br><span class="line">            &#125;</span><br><span class="line">            $channel-&gt;basic_publish($msg, <span class="string">''</span>, $rabbitmq_channel);</span><br><span class="line">......</span><br><span class="line">    <span class="comment">//对seed生成的序列化字符串进行测试</span></span><br><span class="line">    $userInput = base64_decode($argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// $userInput = $GLOBALS['Feedback_cls']-&gt;mutate();</span></span><br><span class="line">    <span class="comment">// echo "[#] User Input: " . $userInput . "\n";</span></span><br><span class="line">    $fuzzed_class = unserialize($userInput);</span><br><span class="line">    <span class="keyword">switch</span> ($entry_magic_method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"__destruct"</span>:</span><br><span class="line">            <span class="keyword">unset</span>($fuzzed_class);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"__construct"</span>:</span><br><span class="line">            <span class="comment">// TODO</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"__call"</span>:</span><br><span class="line">            $fuzzed_class-&gt;non_existed_method();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h1 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h1><p>伪代码第7行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$executor = <span class="keyword">new</span> Executor();</span><br><span class="line">$copied_seed-&gt;fuzz_result = $executor-&gt;ExecutePutByPayloadTree(</span><br><span class="line">                              <span class="keyword">$this</span>-&gt;file_inst, <span class="keyword">$this</span>-&gt;file_chain,</span><br><span class="line">                              $copied_seed-&gt;input_tree,</span><br><span class="line">                              <span class="keyword">$this</span>-&gt;rabbitmq_settings,</span><br><span class="line">                              <span class="keyword">$this</span>-&gt;rabbitmq_connection,</span><br><span class="line">                              <span class="keyword">$this</span>-&gt;chain[<span class="number">0</span>]-&gt;method,</span><br><span class="line">                              <span class="keyword">$this</span>-&gt;chain</span><br><span class="line">                            );</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Executor::ExecutePutByPayloadTree</code>首先调用<code>Executor::MakePayloadPhpFile</code>，该方法在<code>Files/fuzzing/app.xxx.xxxx/PUT/PAYLOAD</code>下生成当前seed对应的序列化文件，例如：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//类的定义</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">// <span class="title">case</span> 3</span><br><span class="line">$<span class="title">obj_Foo_0</span> = <span class="title">new</span> <span class="title">Foo</span>;</span><br><span class="line"><span class="comment">// case 4</span></span><br><span class="line">$obj_Foo_0-&gt;setProp(<span class="string">'o'</span>, <span class="keyword">new</span> Bar);</span><br><span class="line"><span class="comment">// case 0</span></span><br><span class="line">$obj_Foo_0-&gt;setProp(<span class="string">'a'</span>, <span class="number">880065850</span>);</span><br><span class="line"><span class="comment">// case 0</span></span><br><span class="line">$obj_Foo_0-&gt;setProp(<span class="string">'p'</span>, <span class="string">"/FUGIO/Files/fuzzing/app.test.230828014612/PUT/helper/proc0_1_4_1_36_2_dir/"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"><span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>($<span class="title">obj_Foo_0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>也就是按照seed中的属性树给对象属性挨个赋值，之后执行该文件即可获得该seed对应的序列化字符串</p>
<ul>
<li>之后会调用之前Instrumentor阶段生成的<code>Files/fuzzing/app.xxx.xxxx/PUT/inst_PUT.php</code>，并将序列化字符串传递过去，从而执行该gadget</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">putenv(<span class="string">"ENTRY_MAGIC_METHOD="</span> . $entry_magic_method);</span><br><span class="line">putenv(<span class="string">"SEED_VALUE="</span> . $GLOBALS[<span class="string">'SEED_VALUE'</span>]);</span><br><span class="line">shell_exec(<span class="string">"php "</span> .</span><br><span class="line">           <span class="string">"-d max_execution_time="</span> . $GLOBALS[<span class="string">'FUZZING_TIMEOUT'</span>] . <span class="string">" "</span> .</span><br><span class="line">           <span class="string">"-d memory_limit="</span> . MEMORY_LIMIT . <span class="string">" "</span> .</span><br><span class="line">           $file_inst . <span class="string">" "</span> . <span class="keyword">$this</span>-&gt;serialized_string);</span><br></pre></td></tr></table></figure>

<h1 id="Feedback"><a href="#Feedback" class="headerlink" title="Feedback"></a>Feedback</h1><p>总共有4类Feedback：</p>
<blockquote>
<p>There exist four types of feedback that the fuzzer leverages: 1) branch<br>coverage, 2) the depth of a gadget reached, 3) property hinting,<br>and 4) reference error.</p>
</blockquote>
<h2 id="Branch-Coverage"><a href="#Branch-Coverage" class="headerlink" title="Branch Coverage"></a>Branch Coverage</h2><ul>
<li>伪代码第8 9行，判断是否到达了新的path以及对fuzz结果的分析（两者顺序和伪代码中反过来）</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;seed_pool-&gt;IsNewPath($copied_seed)) &#123;</span><br><span class="line">        $analyzed_result = $executor-&gt;AnalyzeExecutedResult(</span><br><span class="line">                            $copied_seed-&gt;fuzz_result[<span class="string">'result'</span>],</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;chain,</span><br><span class="line">                            $copied_seed</span><br><span class="line">                           );</span><br><span class="line">                           ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsNewPath</span><span class="params">($copied_seed)</span> </span>&#123;</span><br><span class="line">  $seed_queue = <span class="keyword">array</span>();</span><br><span class="line">  array_push($seed_queue, <span class="keyword">$this</span>-&gt;root);</span><br><span class="line"></span><br><span class="line">  $seed_list = <span class="keyword">array</span>();</span><br><span class="line">  <span class="keyword">while</span> ($seed = array_shift($seed_queue)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($seed-&gt;path_hash == $copied_seed-&gt;path_hash <span class="keyword">and</span></span><br><span class="line">        $seed-&gt;goal_depth == $copied_seed-&gt;goal_depth <span class="keyword">and</span></span><br><span class="line">        $seed-&gt;depth == $copied_seed-&gt;depth) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($seed-&gt;child <span class="keyword">as</span> $child_seed) &#123;</span><br><span class="line">      array_push($seed_queue, $child_seed);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和其他seed挨个进行比对</p>
<ul>
<li>将当前seed加入seed_pool，对应伪代码第10行</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$copied_seed-&gt;depth = count($analyzed_result[<span class="string">'gadget_pass_check'</span>]) - <span class="number">1</span>;</span><br><span class="line">$copied_seed-&gt;select_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;seed_pool-&gt;AddSeed($selected_seed, $copied_seed, <span class="keyword">True</span>);</span><br></pre></td></tr></table></figure>

<h2 id="The-Depth-of-a-Gadget-Reached"><a href="#The-Depth-of-a-Gadget-Reached" class="headerlink" title="The Depth of a Gadget Reached"></a>The Depth of a Gadget Reached</h2><ul>
<li>伪代码17 18行，判断当前seed是否比变异前的seed到达了更深层的gadget，是的话根据当前seed再生成一个新seed加入seed_pool，其中包含了新到达的gadget</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($copied_seed-&gt;depth &gt; $selected_seed-&gt;depth) &#123;</span><br><span class="line">  <span class="keyword">if</span> ($copied_seed-&gt;depth == <span class="number">0</span> <span class="keyword">and</span> $selected_seed-&gt;depth == <span class="number">-1</span>) &#123;</span><br><span class="line">    $next_gadget_index = $copied_seed-&gt;depth + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    $next_gadget_index = $copied_seed-&gt;depth;</span><br><span class="line">  &#125;</span><br><span class="line">  $next_gadget = $payload_creator-&gt;MakeGadgetTemplate(</span><br><span class="line">                                    <span class="keyword">$this</span>-&gt;gadget[$next_gadget_index]);</span><br><span class="line">  $merged_tree_list = $copied_seed-&gt;GetMergedTreeList($next_gadget);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span> ($merged_tree_list <span class="keyword">as</span> $merged_tree) &#123;</span><br><span class="line">    $new_evolved_seed = <span class="keyword">new</span> SeedNode();</span><br><span class="line">    $new_evolved_seed-&gt;template_tree = $merged_tree;</span><br><span class="line">    $new_evolved_seed-&gt;input_tree = $payload_creator-&gt;SetMutateProperties(</span><br><span class="line">                                      $new_evolved_seed-&gt;template_tree,</span><br><span class="line">                                      <span class="keyword">$this</span>-&gt;file_chain, <span class="keyword">$this</span>-&gt;gadget,</span><br><span class="line">                                      <span class="keyword">$this</span>-&gt;cand_class, <span class="keyword">$this</span>-&gt;cand_foreach,</span><br><span class="line">                                      <span class="keyword">$this</span>-&gt;hinting_infos,</span><br><span class="line">                                      $new_evolved_seed-&gt;array_hinting,</span><br><span class="line">                                      $next_gadget</span><br><span class="line">                                    );</span><br><span class="line">    $new_evolved_seed-&gt;goal_depth = $copied_seed-&gt;depth + <span class="number">1</span>;</span><br><span class="line">    $new_evolved_seed-&gt;depth = $copied_seed-&gt;depth;</span><br><span class="line">    $new_evolved_seed-&gt;select_count = <span class="number">0</span>;</span><br><span class="line">    $new_evolved_seed-&gt;seed_idx = <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx;</span><br><span class="line">    $new_evolved_seed-&gt;array_object = $next_gadget;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;seed_pool-&gt;AddSeed($selected_seed, $new_evolved_seed, <span class="keyword">True</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单说有点抽象，还是用上面那个例子。当Fuzzer第一次运行到该分支时，<code>$copied_seed-&gt;input_tree</code>类似于：</p>
<p><img src="/images/FUGIO_input_tree2.png" alt="input_tree2"></p>
<p>可以看到此时<code>o</code>被设置为了<code>Bar</code>类的对象，因此到达了第2层gadget，但其<code>deps</code>此时还是空的</p>
<p>而<code>$merged_tree_list</code>则会是补全了<code>deps</code>的<code>$copied_tree</code>：</p>
<p><img src="/images/FUGIO_merged_tree_list.png" alt="merged_tree_list"></p>
<h2 id="Property-Hinting"><a href="#Property-Hinting" class="headerlink" title="Property Hinting"></a>Property Hinting</h2><p>伪代码19-21行，这里有两类Hint：</p>
<h3 id="条件分支的hint"><a href="#条件分支的hint" class="headerlink" title="条件分支的hint"></a>条件分支的hint</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$hinted_seeds = <span class="keyword">$this</span>-&gt;MakeHintedSeeds($copied_seed,</span><br><span class="line">                                        <span class="keyword">$this</span>-&gt;hinting_data,</span><br><span class="line">                                        $analyzed_result[<span class="string">'passed_conds'</span>]);</span><br><span class="line"><span class="keyword">foreach</span> ($hinted_seeds <span class="keyword">as</span> $hinted_seed) &#123;</span><br><span class="line">  <span class="comment">// $hinted_seed-&gt;path_hash = NULL;</span></span><br><span class="line">  $hinted_seed-&gt;select_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx += <span class="number">1</span>;</span><br><span class="line">  $hinted_seed-&gt;seed_idx = <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx;</span><br><span class="line">  <span class="comment">// Duplicate Check</span></span><br><span class="line">  <span class="keyword">$this</span>-&gt;seed_pool-&gt;AddSeed($selected_seed, $hinted_seed, <span class="keyword">True</span>);</span><br><span class="line">  <span class="comment">// $hinted_seed-&gt;depth = count($analyzed_result['gadget_pass_check']) - 1;</span></span><br><span class="line">  <span class="comment">// $hinted_seed-&gt;goal_depth = count($analyzed_result['gadget_pass_check']);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的hint来源于<code>inst-class-xxx.php</code>,其中包含了如果要进入某个分支某个属性需要的值，还是上面那个例子。当检测到<code>$copied_seed</code>能够到达该分支的<code>COND-PRE</code>并且已经具有该分支需要的属性时，就按照hint中的类型和值修改该属性</p>
<p>上面那个例子：</p>
<p><img src="/images/hinted_seeds.png" alt="hinted_seeds"></p>
<p>另外FUGIO只实现了<code>==</code>以及<code>is_string</code>这种的hint，<code>&lt;</code>这种都不支持</p>
<h3 id="数组索引的hint"><a href="#数组索引的hint" class="headerlink" title="数组索引的hint"></a>数组索引的hint</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hinting 2 (ArrayFetch)</span></span><br><span class="line">$array_hinted_seed = <span class="keyword">$this</span>-&gt;MakeArrayHintedSeed(</span><br><span class="line">                              $copied_seed, $analyzed_result[<span class="string">'array_fetch_list'</span>]);</span><br><span class="line"><span class="keyword">if</span> ($array_hinted_seed != <span class="keyword">False</span>) &#123;</span><br><span class="line">  $array_hinted_seed-&gt;select_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx += <span class="number">1</span>;</span><br><span class="line">  $array_hinted_seed-&gt;seed_idx = <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;seed_pool-&gt;AddSeed($selected_seed, $array_hinted_seed, <span class="keyword">True</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理的应该是这种情况：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Baz</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;con[<span class="string">"key"</span>] == <span class="string">"value"</span>) &#123;</span><br><span class="line">                    system($a);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>inst-class-baz.php</code>中会多一个：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;con[$GLOBALS[<span class="string">'Feedback_cls'</span>]-&gt;ArrayFetch(<span class="string">'000000001b7b9c78000000007cb15664'</span>, <span class="string">'$this-&gt;con'</span>, <span class="string">"key"</span>, <span class="keyword">$this</span>-&gt;con, <span class="string">"key"</span>, debug_backtrace())]</span><br></pre></td></tr></table></figure>

<p>但这里的实现跟条件分支的hint有点不一样，并不会直接在<code>$array_hinted_seed</code>中把<code>$this-&gt;con[&quot;key&quot;]</code>直接设成<code>&quot;value&quot;</code>，只会给<code>array_hinted_seed</code>添加一个<code>array_hinting</code>属性。后续在变异（PayloadCreator::SetMutateProperties）的时候如果<code>con</code>的类型变异为<code>Array</code>或者<code>ArrayObject</code>的话有一定概率根据这个<code>array_hinting</code>属性设置一个<code>&quot;key&quot;</code>的索引（值还不会被设成<code>&quot;value&quot;</code>….）。感觉应该是没实现完或者写错了之类的，测试了几次根本不能成功fuzz出来</p>
<h2 id="Reference-Error"><a href="#Reference-Error" class="headerlink" title="Reference Error"></a>Reference Error</h2><p>伪代码22-24行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$revise_check = <span class="keyword">$this</span>-&gt;IsNeedRevise($copied_seed);</span><br><span class="line"><span class="keyword">if</span> ($revise_check[<span class="string">'result'</span>]) &#123;</span><br><span class="line">  <span class="keyword">if</span> ($revise_check[<span class="string">'type'</span>] == <span class="string">"NON_OBJECT_METHOD"</span>) &#123;</span><br><span class="line">    $added_prop_seeds = <span class="keyword">$this</span>-&gt;MakeAddPropSeeds($copied_seed);</span><br><span class="line">    <span class="keyword">if</span> ($added_prop_seeds != <span class="keyword">false</span>) &#123;</span><br><span class="line">      <span class="keyword">foreach</span> ($added_prop_seeds <span class="keyword">as</span> $added_prop_seed) &#123;</span><br><span class="line">        $new_added_seed = <span class="keyword">new</span> SeedNode();</span><br><span class="line">        $new_added_seed-&gt;template_tree = $added_prop_seed;</span><br><span class="line">        $new_added_seed-&gt;input_tree = $payload_creator-&gt;SetMutateProperties(</span><br><span class="line">                                        $new_added_seed-&gt;template_tree,</span><br><span class="line">                                        <span class="keyword">$this</span>-&gt;file_chain, <span class="keyword">$this</span>-&gt;gadget,</span><br><span class="line">                                        <span class="keyword">$this</span>-&gt;cand_class, <span class="keyword">$this</span>-&gt;cand_foreach,</span><br><span class="line">                                        <span class="keyword">$this</span>-&gt;hinting_infos,</span><br><span class="line">                                        $new_added_seed-&gt;array_hinting,</span><br><span class="line">                                        $copied_seed-&gt;array_object</span><br><span class="line">                                      );</span><br><span class="line">        $new_added_seed-&gt;goal_depth = $copied_seed-&gt;depth + <span class="number">1</span>;</span><br><span class="line">        $new_added_seed-&gt;depth = $copied_seed-&gt;depth;</span><br><span class="line">        $new_added_seed-&gt;select_count = <span class="number">0</span>;</span><br><span class="line">        $new_added_seed-&gt;seed_idx = <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;seed_pool-&gt;seed_idx += <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// Duplicate check [TODO - NEED TO TEST]</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;seed_pool-&gt;AddSeed($selected_seed, $new_added_seed, <span class="keyword">True</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Furthermore, the fuzzer observes reference errors in the<br>invocation of a method call leveraging a receiver (e.g., $receiver-&gt;method()). When an observed error is due to a missing property or an incorrect object in the receiver, the fuzzer appends the missing property node in the tree of the current input or assigns an Object with a value chosen from among the classes that have the target method call name<br>(Lines 22–24).</p>
</blockquote>
<p>虽然论文里说missing property or an incorrect object in the receiver，但代码中似乎只有后一种情况的处理，也不太知道啥情况能触发这个，正常情况下都会挑选有该方法的对象吧。</p>
<h1 id="Exploit-oracle"><a href="#Exploit-oracle" class="headerlink" title="Exploit oracle"></a>Exploit oracle</h1><p>有空再写</p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2023-08-16</span>
  </div>

  <div class="post-footer">
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/fuzzing/" rel="tag">fuzzing</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li></ul>
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>

    </div>
  </body>
</html>